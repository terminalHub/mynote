---
typora-copy-images-to: ./img
---

# 菜单条件查询&菜单增加

```
(1)条件查询
(2)增加操作
```

# 1 菜单查询-条件查询

## 1.1 需求分析

```sql
(1)Menu.vue->MenuController->MenuService->MenuDao
(2)sql：
	情况一：
        select 
            m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') 		
            parent_name,m1.menu_url,m1.glyphicon
        from 
            fin_admin_menu m1 
        left join 
            fin_admin_menu m2
        on 
            m1.parent_id=m2.menu_id
        where
            m1.menu_name like '%管理%'
        and
            m1.parent_id=1
        limit 0,5;
	情况二：
        select 
            m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') 		
            parent_name,m1.menu_url,m1.glyphicon
        from 
            fin_admin_menu m1 
        left join 
            fin_admin_menu m2
        on 
            m1.parent_id=m2.menu_id
        limit 0,5;
	情况三：
        select 
            m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') 		
            parent_name,m1.menu_url,m1.glyphicon
        from 
        	fin_admin_menu m1 
        left join 
        	fin_admin_menu m2
        on 
        	m1.parent_id=m2.menu_id
        where
        	m1.menu_name like '%管理%'
        limit 0,5;
	情况四：
    select 
        m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') 		
        parent_name,m1.menu_url,m1.glyphicon
    from 
    	fin_admin_menu m1 
    left join 
    	fin_admin_menu m2
    on 
    	m1.parent_id=m2.menu_id
    where
    	m1.parent_id=1
    limit 0,5;
```

## 1.2 实现过程

### 1.2.1 前端

#### 1.2.1 Menu.vue

```vue
<template>
  <div>
    <!-- 行内表单->搜索 -->
    <el-form :inline="true" :model="queryForm" class="demo-form-inline">
      <el-form-item label="菜单名称">
        <el-input
          v-model="queryForm.menuName"
          placeholder="请输入菜单名称"
        ></el-input>
      </el-form-item>
      <el-form-item label="上级菜单">
        <el-select v-model="queryForm.parentId" placeholder="请选择">
          <el-option label="超级菜单" value="0"></el-option>
          <!-- 所有的一级菜单名称：使用v-for遍历 -->
          <el-option
            :key="oneMenu.menuId"
            :label="oneMenu.menuName"
            :value="oneMenu.menuId"
            v-for="oneMenu in oneMenuData"
          ></el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="executeQuery()">查询</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格-呈现菜单数据 -->
    <el-table :data="tableData" style="width: 100%">
      <el-table-column prop="menuId" label="菜单编号" width="180">
      </el-table-column>
      <el-table-column prop="menuName" label="菜单名称" width="180">
      </el-table-column>
      <el-table-column prop="parentId" label="上级菜单编号"> </el-table-column>
      <el-table-column prop="parentName" label="上级菜单名称" width="180">
      </el-table-column>
      <el-table-column prop="menuUrl" label="访问地址" width="180">
      </el-table-column>
      <el-table-column prop="glyphicon" label="菜单图标"> </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[5, 10, 15, 20]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 表格数据 */
      tableData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 20,
        totalNum: 50,
      },
      /* 条件查询 */
      queryForm: {
        menuName: "",
        parentId: "",
      },
      /* 一级菜单数据 */
      oneMenuData: [],
    };
  },
  methods: {
    /* 条件查询 */
    executeQuery() {
      var reqData = this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryMenu(reqData);
    },
    /* 分页查询 */
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置为第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryMenu(reqData);
    },
    /* 切换页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryMenu(reqData);
    },
    /* 公共函数-查询 */
    queryMenu(reqData) {
      this.$axios
        .post("/menuQuery", reqData)
        .then((resp) => {
          console.log(resp);
          this.tableData = resp.data.returnData.menuList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 查询所有的一级菜单数据 */
    queryOneMenu() {
      this.$axios
        .post("/oneMenu", "")
        .then((resp) => {
          console.log(resp);
          this.oneMenuData = resp.data.returnData;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    this.queryMenu("");
    this.queryOneMenu();
  },
};
</script>
<style>
/* 自增样式 */
/* 设置表格表头高度 */
.el-main {
  line-height: 50px;
}
</style>
```

#### 1.2.2 index.js

```javascript
/* 导入组件 */
import Vue from 'vue'
import VueRouter from 'vue-router'
/* 相对路径 */
import Login from '../components/Login.vue'
import Main from '../components/Main.vue'
import User from '../components/SystemManage/User.vue'
import Menu from '../components/SystemManage/Menu.vue'

Vue.use(VueRouter)

/* 配置组件 */
const routes = [
  {
    /* 进入登录界面 */
    path: '/',
    redirect: '/login'
  },
  {
    /* 路径 */
    path: '/login',
    /* 组件 */
    component: Login
  },
  {
    /* 路径 */
    path: '/main',
    /* 组件 */
    component: Main,
    children: [
      {
        path: '/user',
        component: User
      },
      {
        path: '/menu',
        component: Menu
      }
    ]
  }
]

const router = new VueRouter({
  routes
})

export default router
```

### 1.2.2 后端

#### 1.2.2.1 实体类

##### Menu

```java
package com.javasm.finance.entity;

import lombok.*;

import java.util.List;

/**
 * @author: ShangMa
 * @className: Menu
 * @description:
 * @date: 2023/3/1 11:18
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class Menu {
    //菜单编号
    private Integer menuId;
    //菜单名称
    private String menuName;
    //上级编号
    private Integer parentId;
    //上级名称
    private String parentName;
    //请求地址
    private String menuUrl;
    //菜单图标
    private String glyphicon;
    //版本编号
    private Integer versionId;
    //子菜单-二级菜单数据
    private List<Menu> subMenu;

}
```

##### ReturnEntity

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: ReturnEntity
 * @description:
 * @date: 2023/3/1 10:13
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class ReturnEntity {
    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
    //核心数据
    private Object returnData;
}
```

##### CodeAndMsg

```java
package com.javasm.finance.entity;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * @author: ShangMa
 * @className: CodeAndMsg
 * @description:
 * @date: 2023/3/1 10:14
 * @since: 11
 */
@AllArgsConstructor
@Getter
public enum CodeAndMsg {
    LOGIN_SUCCESS(2000, "登录成功"),
    LOGIN_FAILURED(4000, "登录失败"),
    QUERY_SUCCESS(2001,"成功查询到数据"),
    QUERY_FAILURED(4001,"没有查询到数据"),
    NO_LOGIN(4005,"没有登录");

    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
}
```

#### 1.2.2.2 持久层

##### MenuDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDao
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public interface MenuDao {

    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @param level  菜单等级
     * @return 登录用户菜单数据
     * @throws SQLException
     */
    List<Menu> findMenu(Integer userId, Integer level) throws SQLException;


    /**
     * 查询菜单数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 菜单数据
     * @throws SQLException
     */
    List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) throws SQLException;


    /**
     * 查询数据表中数据总条数
     *
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 数据总条数
     * @throws SQLException
     */
    long findTotalNum(String menuName, Integer parentId) throws SQLException;

    /**
     * 查询所有的一级菜单数据
     *
     * @return 所有的一级菜单数据
     * @throws SQLException
     */
    List<Menu> findAllOneMenu() throws SQLException;

}
```

##### MenuDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDaoImpl
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public class MenuDaoImpl implements MenuDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public List<Menu> findMenu(Integer userId, Integer level) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id " +
                "from fin_admin_menu am,fin_user_menu um " +
                "where am.menu_id=um.menu_id " +
                "and um.user_id=? ";
        if (level == 1) {
            //一级菜单数据
            sql += "and am.parent_id=0";
        } else {
            //二级菜单数据
            sql += "and am.parent_id!=0";
        }
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') parent_name,m1.menu_url,m1.glyphicon " +
                "from " +
                "fin_admin_menu m1 " +
                "left join " +
                "fin_admin_menu m2 " +
                "on " +
                "m1.parent_id=m2.menu_id ";
        //条件查询        连接词：where and       ?：集合转数组
        boolean isWhere = true;
        List paramList = new ArrayList();
        if (menuName != null && !"".equals(menuName)) {
            if (isWhere) {//T
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.menu_name like ? ";
            paramList.add("%" + menuName + "%");
        }
        if (parentId != null && !"".equals(parentId)) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.parent_id=? ";
            paramList.add(parentId);
        }
        //分页查询
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        System.out.println(sql);
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public long findTotalNum(String menuName, Integer parentId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_menu m1 ";
        boolean isWhere = true;
        List paramList = new ArrayList();
        if (menuName != null && !"".equals(menuName)) {
            if (isWhere) {//T
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.menu_name like ? ";
            paramList.add("%" + menuName + "%");
        }

        if (parentId != null && !"".equals(parentId)) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.parent_id=? ";
            paramList.add(parentId);
        }
        //单数据  数据总条数
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }

    @Override
    public List<Menu> findAllOneMenu() throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id " +
                "from fin_admin_menu am " +
                "where am.parent_id=0";
        BeanListHandler<Menu> listHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> oneMenuList = runner.query(conn, sql, listHandler);
        DBUtils.getClose(conn, null, null);
        return oneMenuList;
    }
}
```

#### 1.2.2.3 业务层

##### MenuService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuService
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public interface MenuService {
    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId);

    /**
     * 查询菜单数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 菜单数据
     */
    List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId);

    /**
     * 查询数据表中数据总条数
     *
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 数据总条数
     */
    long findTotalNum(String menuName, Integer parentId);

    /**
     * 查询所有的一级菜单数据
     *
     * @return 所有的一级菜单数据
     */
    List<Menu> findAllOneMenu();
}
```

##### MenuServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.dao.impl.MenuDaoImpl;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.service.MenuService;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuServiceImpl
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public class MenuServiceImpl implements MenuService {
    MenuDao menuDao = new MenuDaoImpl();

    @Override
    public List<Menu> findMenu(Integer userId) {
        //查询一级菜单数据和二级菜单数据->将二级菜单数据放到一级菜单数据中
        //一级菜单数据
        List<Menu> menuData = null;
        //二级菜单数据
        List<Menu> subMenuData = null;
        try {
            menuData = menuDao.findMenu(userId, 1);
            subMenuData = menuDao.findMenu(userId, 2);
            //将二级菜单数据放到一级菜单数据中
            for (Menu menu : menuData) {
                for (Menu subMenu : subMenuData) {
                    //二级菜单数据的上级编号和一级菜单数据的菜单编号比较
                    if (menu.getMenuId().equals(subMenu.getParentId())) {
                        if (menu.getSubMenu() == null) {
                            menu.setSubMenu(new ArrayList<>());
                        }
                        menu.getSubMenu().add(subMenu);
                    }
                }
            }
            //System.out.println("menuData=" + menuData);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        //一级菜单数据包含二级菜单数据格式
        return menuData;
    }

    @Override
    public List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) {
        List<Menu> menuList = null;
        try {
            menuList = menuDao.findAllMenu(page, pageSize, menuName, parentId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menuList;
    }

    @Override
    public long findTotalNum(String menuName, Integer parentId) {
        long totalNum = 0;
        try {
            totalNum = menuDao.findTotalNum(menuName, parentId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }

    @Override
    public List<Menu> findAllOneMenu() {
        List<Menu> oneMenuList = null;
        try {
            oneMenuList = menuDao.findAllOneMenu();
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return oneMenuList;
    }
}
```

#### 1.2.2.4 控制层

##### MenuController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.PageInfo;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: MenuController
 * @description:
 * @date: 2023/3/1 16:17
 * @since: 11
 */
@WebServlet("/menuQuery")
public class MenuController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //跨域处理
        CORSUtils.handleCORS(resp);
        //菜单名称
        req.setCharacterEncoding("utf-8");
        //菜单名称
        String menuName = req.getParameter("menuName");
        //上级菜单编号
        String parentIdStr = req.getParameter("parentId");
        Integer parentId = null;
        if (parentIdStr != null && !"".equals(parentIdStr)) {
            parentId = Integer.valueOf(parentIdStr);
        }
        //当前页
        Integer page = 1;
        String pageStr = req.getParameter("page");
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示数据条数
        Integer pageSize = 5;
        String pageSizeStr = req.getParameter("pageSize");
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        MenuService menuService = new MenuServiceImpl();
        List<Menu> menuList = menuService.findAllMenu(page, pageSize, menuName, parentId);
        ReturnEntity re = new ReturnEntity();
        if (menuList != null && menuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            Map<String, Object> returnMap = new HashMap<>();
            //菜单数据
            returnMap.put("menuList", menuList);
            //页码数据
            long totalNum = menuService.findTotalNum(menuName, parentId);
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnData(returnMap);
        } else {
            Map<String, Object> returnMap = new HashMap<>();
            PageInfo pageInfo = new PageInfo(1, 5, 0l);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

##### OneMenuController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: OneMenuConbtroller
 * @description:
 * @date: 2023/3/2 11:54
 * @since: 11
 */
@WebServlet("/oneMenu")
public class OneMenuController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //跨域处理
        CORSUtils.handleCORS(resp);
        //查询一级菜单数据
        MenuService menuService = new MenuServiceImpl();
        List<Menu> allOneMenuList = menuService.findAllOneMenu();
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (allOneMenuList != null && allOneMenuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.LOGIN_SUCCESS.getReturnMsg());
            re.setReturnData(allOneMenuList);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

# 2 Servlet整合

## 2.1 内容概述

```java
(1)目前使用方式：一个请求对应于一个servlet
(2)期望使用方式：
    一个servlet处理多个请求  CRUD  
    MenuController   UserController   xxxController，抽出来一个父类
    menu/query->query()
    menu/add->add()
    menu/edit->edit()

    反射
```

## 2.2 案例

### 2.2.1 BaseController

```java
package com.javasm.finance.controller;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

/**
 * @author: ShangMa
 * @className: BaseController
 * @description:
 * @date: 2023/3/2 15:54
 * @since: 11
 */
public class BaseController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //获取路径   /menu/query  /menu/add
        //System.out.println(req.getServletPath());// /menu
        System.out.println(req.getRequestURI());// /menu/add  /menu/query
        String requestURI = req.getRequestURI();
        //add query ...
        System.out.println(requestURI.substring(requestURI.lastIndexOf("/") + 1));
        //获取处理请求对应的方法名称
        String methodName = requestURI.substring(requestURI.lastIndexOf("/") + 1);
        //反射
        Class<? extends BaseController> aClass = this.getClass();
        try {
            //public修饰的
            Method method = aClass.getMethod(methodName, HttpServletRequest.class, HttpServletResponse.class);
            //调用方法
            method.invoke(this, req, resp);
        } catch (NoSuchMethodException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        } catch (InvocationTargetException e) {
            e.printStackTrace();
        }
    }
}
```

### 2.2.2 MenuController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.PageInfo;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: MenuController
 * @description:
 * @date: 2023/3/1 16:17
 * @since: 11
 */
@WebServlet("/menu/*")
public class MenuController extends BaseController {
    /**
     * 查询菜单数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void query(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行MenuController.query()");
        //跨域处理
        CORSUtils.handleCORS(resp);
        //菜单名称
        req.setCharacterEncoding("utf-8");
        //菜单名称
        String menuName = req.getParameter("menuName");
        //上级菜单编号
        String parentIdStr = req.getParameter("parentId");
        Integer parentId = null;
        if (parentIdStr != null && !"".equals(parentIdStr)) {
            parentId = Integer.valueOf(parentIdStr);
        }
        //当前页
        Integer page = 1;
        String pageStr = req.getParameter("page");
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示数据条数
        Integer pageSize = 5;
        String pageSizeStr = req.getParameter("pageSize");
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        MenuService menuService = new MenuServiceImpl();
        List<Menu> menuList = menuService.findAllMenu(page, pageSize, menuName, parentId);
        ReturnEntity re = new ReturnEntity();
        if (menuList != null && menuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            Map<String, Object> returnMap = new HashMap<>();
            //菜单数据
            returnMap.put("menuList", menuList);
            //页码数据
            long totalNum = menuService.findTotalNum(menuName, parentId);
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnData(returnMap);
        } else {
            Map<String, Object> returnMap = new HashMap<>();
            PageInfo pageInfo = new PageInfo(1, 5, 0l);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 查询一级菜单数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void queryOneMenu(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //跨域处理
        CORSUtils.handleCORS(resp);
        //查询一级菜单数据
        MenuService menuService = new MenuServiceImpl();
        List<Menu> allOneMenuList = menuService.findAllOneMenu();
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (allOneMenuList != null && allOneMenuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.LOGIN_SUCCESS.getReturnMsg());
            re.setReturnData(allOneMenuList);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 增加菜单数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void add(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行MenuController.add()");
        //...


    }
}
```

### 2.2.3 UserController

```java
package com.javasm.finance.controller;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * @author: ShangMa
 * @className: UserController
 * @description:
 * @date: 2023/3/2 15:54
 * @since: 11
 */
@WebServlet("/user/*")
public class UserController extends BaseController{
    /**
     * 查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void query(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.query()");
        //...
    }

    /**
     * 增加用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void add(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.add()");
        //...
    }
}
```

# 3 增加菜单

## 3.1 需求分析

```
(1)流程：
	Menu.vue->增加按钮->打开增加对话框->点击对话框上的保存按钮->给服务器端发请求(MenuController.add())
	->MenuService->MenuDao;
	MenuController.add()->写出响应数据;  操作成功|操作失败
	Menu.vue->获取响应数据->给用户设置提示信息;
(2)sql：
	insert into fin_admin_menu() values (?,?,...)
```

## 3.2 实现过程

![image-20230302180546160](img/image-20230302180546160.png)

### 3.2.1 前端

#### Menu.vue

```vue
<template>
  <div>
    <!-- 行内表单->搜索 -->
    <el-form :inline="true" :model="queryForm" class="demo-form-inline">
      <el-form-item label="菜单名称">
        <el-input
          v-model="queryForm.menuName"
          placeholder="请输入菜单名称"
        ></el-input>
      </el-form-item>
      <el-form-item label="上级菜单">
        <el-select v-model="queryForm.parentId" placeholder="请选择">
          <el-option label="超级菜单" value="0"></el-option>
          <!-- 所有的一级菜单名称：使用v-for遍历 -->
          <el-option
            :key="oneMenu.menuId"
            :label="oneMenu.menuName"
            :value="oneMenu.menuId"
            v-for="oneMenu in oneMenuData"
          ></el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="executeQuery()">查询</el-button>
        <!-- Form -->
        <el-button type="success" @click="toAdd()">增加</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格-呈现菜单数据 -->
    <el-table :data="tableData" style="width: 100%">
      <el-table-column prop="menuId" label="菜单编号" width="180">
      </el-table-column>
      <el-table-column prop="menuName" label="菜单名称" width="180">
      </el-table-column>
      <el-table-column prop="parentId" label="上级菜单编号"> </el-table-column>
      <el-table-column prop="parentName" label="上级菜单名称" width="180">
      </el-table-column>
      <el-table-column prop="menuUrl" label="访问地址" width="180">
      </el-table-column>
      <el-table-column prop="glyphicon" label="菜单图标"> </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[5, 10, 15, 20]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
    <!-- 增加对话框 -->
    <el-dialog title="增加" :visible.sync="addDialogFormVisible">
      <el-form :model="addForm">
        <el-form-item label="菜单编号" :label-width="formLabelWidth">
          <el-input v-model="addForm.menuId" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="菜单名称" :label-width="formLabelWidth">
          <el-input v-model="addForm.menuName" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="上级菜单" :label-width="formLabelWidth">
          <el-select v-model="addForm.parentId" placeholder="请选择">
            <el-option label="超级菜单" value="0"></el-option>
            <!-- 所有的一级菜单名称：使用v-for遍历 -->
            <el-option
              :key="oneMenu.menuId"
              :label="oneMenu.menuName"
              :value="oneMenu.menuId"
              v-for="oneMenu in oneMenuData"
            ></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="菜单地址" :label-width="formLabelWidth">
          <el-input v-model="addForm.menuUrl" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="菜单图标" :label-width="formLabelWidth">
          <el-input v-model="addForm.glyphicon" autocomplete="off"></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="addDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeAdd()">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 表格数据 */
      tableData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 20,
        totalNum: 50,
      },
      /* 条件查询 */
      queryForm: {
        menuName: "",
        parentId: "",
      },
      /* 一级菜单数据 */
      oneMenuData: [],
      /* 增加对话框 */
      addDialogFormVisible: false,
      addForm: {
        menuId: "",
        menuName: "",
        parentId: "",
        menuUrl: "",
        glyphicon: "",
      },
      formLabelWidth: "120px",
    };
  },
  methods: {
    toAdd() {
      // 打开对话框
      this.addDialogFormVisible = true;
      // 清空数据
      this.addForm = {
        menuId: "",
        menuName: "",
        parentId: "",
        menuUrl: "",
        glyphicon: "",
      };
    },
    /* 执行增加 */
    executeAdd() {
      // 关闭对话框
      this.addDialogFormVisible = false;
      // 增加数据->axios
      var reqData = this.$qs.stringify(this.addForm);
      console.log(reqData);
      this.$axios
        .get("/menu/add?" + reqData)
        .then((resp) => {
          console.log(resp);
          //设置提示信息
          if (resp.data.returnCode == 2002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "success",
            });
          } else if (resp.data.returnCode == 4002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "error",
            });
          }
          //重新查询菜单数据-table部分数据
          this.pageInfo.page = 1;
          this.pageInfo.pageSize = 5;
          var reqData =
            this.$qs.stringify(this.queryForm) +
            "&" +
            this.$qs.stringify(this.pageInfo);
          console.log(reqData);
          this.queryMenu(reqData);
          //重新查询下拉列表数据-一级菜单数据
          this.queryOneMenu();
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 条件查询 */
    executeQuery() {
      var reqData = this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryMenu(reqData);
    },
    /* 分页查询 */
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置为第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryMenu(reqData);
    },
    /* 切换页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryMenu(reqData);
    },
    /* 公共函数-查询 */
    queryMenu(reqData) {
      this.$axios
        .post("/menu/query", reqData)
        .then((resp) => {
          console.log(resp);
          this.tableData = resp.data.returnData.menuList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 查询所有的一级菜单数据 */
    queryOneMenu() {
      this.$axios
        .post("/menu/queryOneMenu", "")
        .then((resp) => {
          console.log(resp);
          this.oneMenuData = resp.data.returnData;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    this.queryMenu("");
    this.queryOneMenu();
  },
};
</script>
<style>
/* 自增样式 */
/* 设置表格表头高度 */
.el-main {
  line-height: 50px;
}
/* 设置对话框上的下拉选中的宽度 */
.el-select {
  width: 100%;
}
</style>
```

### 3.2.2 后端

#### 3.2.2.1 实体类

##### Menu

```java
package com.javasm.finance.entity;

import lombok.*;

import java.util.List;

/**
 * @author: ShangMa
 * @className: Menu
 * @description:
 * @date: 2023/3/1 11:18
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class Menu {
    //菜单编号
    private Integer menuId;
    //菜单名称
    private String menuName;
    //上级编号
    private Integer parentId;
    //上级名称
    private String parentName;
    //请求地址
    private String menuUrl;
    //菜单图标
    private String glyphicon;
    //版本编号
    private Integer versionId;
    //子菜单-二级菜单数据
    private List<Menu> subMenu;

    public Menu(Integer menuId, String menuName, Integer parentId, String menuUrl, String glyphicon, Integer versionId) {
        this.menuId = menuId;
        this.menuName = menuName;
        this.parentId = parentId;
        this.menuUrl = menuUrl;
        this.glyphicon = glyphicon;
        this.versionId = versionId;
    }
}
```

##### ReturnEntity

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: ReturnEntity
 * @description:
 * @date: 2023/3/1 10:13
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class ReturnEntity {
    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
    //核心数据
    private Object returnData;
}
```

##### CodeAndMsg

```java
package com.javasm.finance.entity;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * @author: ShangMa
 * @className: CodeAndMsg
 * @description:
 * @date: 2023/3/1 10:14
 * @since: 11
 */
@AllArgsConstructor
@Getter
public enum CodeAndMsg {
    LOGIN_SUCCESS(2000, "登录成功"),
    LOGIN_FAILURED(4000, "登录失败"),
    QUERY_SUCCESS(2001, "成功查询到数据"),
    QUERY_FAILURED(4001, "没有查询到数据"),
    OPERATE_SUCCESS(2002, "操作成功"),
    OPERATE_FAILURED(4002, "操作失败"),
    NO_LOGIN(4005, "没有登录");

    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;

```

#### 3.2.2.2 持久层

##### MenuDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDao
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public interface MenuDao {

    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @param level  菜单等级
     * @return 登录用户菜单数据
     * @throws SQLException
     */
    List<Menu> findMenu(Integer userId, Integer level) throws SQLException;


    /**
     * 查询菜单数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 菜单数据
     * @throws SQLException
     */
    List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) throws SQLException;


    /**
     * 查询数据表中数据总条数
     *
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 数据总条数
     * @throws SQLException
     */
    long findTotalNum(String menuName, Integer parentId) throws SQLException;

    /**
     * 查询所有的一级菜单数据
     *
     * @return 所有的一级菜单数据
     * @throws SQLException
     */
    List<Menu> findAllOneMenu() throws SQLException;

    /**
     * 增加菜单数据
     *
     * @param menu 菜单数据
     * @return 成功影响的记录数
     */
    int addMenu(Menu menu) throws SQLException;
}
```

##### MenuDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDaoImpl
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public class MenuDaoImpl implements MenuDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public List<Menu> findMenu(Integer userId, Integer level) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id " +
                "from fin_admin_menu am,fin_user_menu um " +
                "where am.menu_id=um.menu_id " +
                "and um.user_id=? ";
        if (level == 1) {
            //一级菜单数据
            sql += "and am.parent_id=0";
        } else {
            //二级菜单数据
            sql += "and am.parent_id!=0";
        }
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') parent_name,m1.menu_url,m1.glyphicon " +
                "from " +
                "fin_admin_menu m1 " +
                "left join " +
                "fin_admin_menu m2 " +
                "on " +
                "m1.parent_id=m2.menu_id ";
        //条件查询        连接词：where and       ?：集合转数组
        boolean isWhere = true;
        List paramList = new ArrayList();
        if (menuName != null && !"".equals(menuName)) {
            if (isWhere) {//T
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.menu_name like ? ";
            paramList.add("%" + menuName + "%");
        }
        if (parentId != null && !"".equals(parentId)) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.parent_id=? ";
            paramList.add(parentId);
        }
        //分页查询
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        //System.out.println(sql);
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public long findTotalNum(String menuName, Integer parentId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_menu m1 ";
        boolean isWhere = true;
        List paramList = new ArrayList();
        if (menuName != null && !"".equals(menuName)) {
            if (isWhere) {//T
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.menu_name like ? ";
            paramList.add("%" + menuName + "%");
        }

        if (parentId != null && !"".equals(parentId)) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.parent_id=? ";
            paramList.add(parentId);
        }
        //单数据  数据总条数
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }

    @Override
    public List<Menu> findAllOneMenu() throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id " +
                "from fin_admin_menu am " +
                "where am.parent_id=0";
        BeanListHandler<Menu> listHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> oneMenuList = runner.query(conn, sql, listHandler);
        DBUtils.getClose(conn, null, null);
        return oneMenuList;
    }

    @Override
    public int addMenu(Menu menu) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "insert into fin_admin_menu(menu_id,menu_name,parent_id,menu_url,glyphicon,version_id) values (?,?,?,?,?,?)";
        int rows = runner.update(conn, sql, menu.getMenuId(), menu.getMenuName(), menu.getParentId(), menu.getMenuUrl(), menu.getGlyphicon(), menu.getVersionId());
        DBUtils.getClose(conn, null, null);
        return rows;
    }
}
```

#### 3.2.2.3 业务层

##### MenuService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuService
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public interface MenuService {
    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId);

    /**
     * 查询菜单数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 菜单数据
     */
    List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId);

    /**
     * 查询数据表中数据总条数
     *
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 数据总条数
     */
    long findTotalNum(String menuName, Integer parentId);

    /**
     * 查询所有的一级菜单数据
     *
     * @return 所有的一级菜单数据
     */
    List<Menu> findAllOneMenu();

    /**
     * 增加菜单数据
     *
     * @param menu 菜单数据
     * @return 成功影响的记录数
     */
    int addMenu(Menu menu);
}
```

##### MenuServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.dao.impl.MenuDaoImpl;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.service.MenuService;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuServiceImpl
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public class MenuServiceImpl implements MenuService {
    MenuDao menuDao = new MenuDaoImpl();

    @Override
    public List<Menu> findMenu(Integer userId) {
        //查询一级菜单数据和二级菜单数据->将二级菜单数据放到一级菜单数据中
        //一级菜单数据
        List<Menu> menuData = null;
        //二级菜单数据
        List<Menu> subMenuData = null;
        try {
            menuData = menuDao.findMenu(userId, 1);
            subMenuData = menuDao.findMenu(userId, 2);
            //将二级菜单数据放到一级菜单数据中
            for (Menu menu : menuData) {
                for (Menu subMenu : subMenuData) {
                    //二级菜单数据的上级编号和一级菜单数据的菜单编号比较
                    if (menu.getMenuId().equals(subMenu.getParentId())) {
                        if (menu.getSubMenu() == null) {
                            menu.setSubMenu(new ArrayList<>());
                        }
                        menu.getSubMenu().add(subMenu);
                    }
                }
            }
            //System.out.println("menuData=" + menuData);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        //一级菜单数据包含二级菜单数据格式
        return menuData;
    }

    @Override
    public List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) {
        List<Menu> menuList = null;
        try {
            menuList = menuDao.findAllMenu(page, pageSize, menuName, parentId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menuList;
    }

    @Override
    public long findTotalNum(String menuName, Integer parentId) {
        long totalNum = 0;
        try {
            totalNum = menuDao.findTotalNum(menuName, parentId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }

    @Override
    public List<Menu> findAllOneMenu() {
        List<Menu> oneMenuList = null;
        try {
            oneMenuList = menuDao.findAllOneMenu();
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return oneMenuList;
    }

    @Override
    public int addMenu(Menu menu) {
        int rows = 0;
        try {
            rows = menuDao.addMenu(menu);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }
}
```

#### 3.2.2.4 控制层

##### MenuController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.PageInfo;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: MenuController
 * @description:
 * @date: 2023/3/1 16:17
 * @since: 11
 */
@WebServlet("/menu/*")
public class MenuController extends BaseController {
    MenuService menuService = new MenuServiceImpl();

    /**
     * 查询菜单数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void query(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行MenuController.query()");
        //跨域处理
        CORSUtils.handleCORS(resp);
        //菜单名称
        req.setCharacterEncoding("utf-8");
        //菜单名称
        String menuName = req.getParameter("menuName");
        //上级菜单编号
        String parentIdStr = req.getParameter("parentId");
        Integer parentId = null;
        if (parentIdStr != null && !"".equals(parentIdStr)) {
            parentId = Integer.valueOf(parentIdStr);
        }
        //当前页
        Integer page = 1;
        String pageStr = req.getParameter("page");
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示数据条数
        Integer pageSize = 5;
        String pageSizeStr = req.getParameter("pageSize");
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        List<Menu> menuList = menuService.findAllMenu(page, pageSize, menuName, parentId);
        ReturnEntity re = new ReturnEntity();
        if (menuList != null && menuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            Map<String, Object> returnMap = new HashMap<>();
            //菜单数据
            returnMap.put("menuList", menuList);
            //页码数据
            long totalNum = menuService.findTotalNum(menuName, parentId);
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnData(returnMap);
        } else {
            Map<String, Object> returnMap = new HashMap<>();
            PageInfo pageInfo = new PageInfo(1, 5, 0l);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 查询一级菜单数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void queryOneMenu(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //跨域处理
        CORSUtils.handleCORS(resp);
        //查询一级菜单数据
        List<Menu> allOneMenuList = menuService.findAllOneMenu();
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (allOneMenuList != null && allOneMenuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.LOGIN_SUCCESS.getReturnMsg());
            re.setReturnData(allOneMenuList);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 增加菜单数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void add(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行MenuController.add()");
        //跨域处理
        CORSUtils.handleCORS(resp);
        //接收请求数据
        //menuId=111&menuName=111&parentId=0&menuUrl=111&glyphicon=111
        req.setCharacterEncoding("utf-8");
        String menuIdStr = req.getParameter("menuId");
        Integer menuId = null;
        if (menuIdStr != null && !"".equals(menuIdStr)) {
            menuId = Integer.valueOf(menuIdStr);
        }
        String menuName = req.getParameter("menuName");
        String parentIdStr = req.getParameter("parentId");
        Integer parentId = null;
        if (parentIdStr != null && !"".equals(parentIdStr)) {
            parentId = Integer.valueOf(parentIdStr);
        }
        String menuUrl = req.getParameter("menuUrl");
        String glyphicon = req.getParameter("glyphicon");
        Menu menu = new Menu(menuId, menuName, parentId, menuUrl, glyphicon, 100);
        //调用业务层方法
        int rows = menuService.addMenu(menu);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //返回响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

## 4 扩展作业

### 4.1 修改

![image-20230302180755413](img/image-20230302180755413.png)

### 4.2 删除

![image-20230302180842823](img/image-20230302180842823.png)

















