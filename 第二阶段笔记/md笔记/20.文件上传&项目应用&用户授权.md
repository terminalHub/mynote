---
typora-copy-images-to: ./img
---

# 文件上传&项目应用&用户授权

```
(1)文件上传
(2)项目应用文件上传
(3)用户授权-二维数组(数组的数组)
```

# 1 文件上传

## 1.1 内容概述

```
(1)将制作好的网页(HTML：文字、图片、视频等)发送到服务器端
(2)上传表单：
	form表单
	method(get|post)，基于字符格式传输  默认    get：url?key=val&key=val&...     post：请求正文
	enctype(application/x-www-form-urlencoded，默认)  浏览器传输数据 编码格式
(3)上传文件：普遍操作
	文件(图片)：类型不定、文件较大，一般使用字节方式传输    二进制文件
```

## 1.2 上传文件注意事项

````
(1)客户端：
	form表单
	method：post
	enctype：multipart/form-data
	文件上传框：<input type="file" />
(2)服务端：
	接收文件、在指定位置保存文件(便于被tomcat服务器读取到)
	servlet3.0之前：io(io加强版)、upload(上传)   jar文件
	servlet3.0之后：@MultipartConfig
````

![image-20230308115032228](img/image-20230308115032228.png)

## 1.3 基础案例

### 1.3.1 upload-demo.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<!--
    form表单
    method     设置为port
    enctype    设置成multipart/form-data
    文件上传框   type设置为file

-->
<form action="/upload" method="post" enctype="multipart/form-data">
    <!--表单项-->
    用户名称：<input type="text" name="userName"><br>
    用户头像：<input type="file" name="userFile"><br>
    <input type="submit">
</form>
    
</body>
</html>
```

### 1.3.2 UploadDemo

```java
package com.javasm.upload.controller;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;
import java.io.IOException;
import java.util.UUID;

/**
 * @author: ShangMa
 * @className: UploadDemo
 * @description: 处理文件上传请求
 * @date: 2023/3/7 18:17
 * @since: 11
 */
@WebServlet("/upload")
@MultipartConfig
public class UploadDemo extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //接收请求数据
        /*System.out.println(req.getParameter("userName"));
        System.out.println(req.getParameter("userFile"));*/

        //文件对象
        //org.apache.catalina.core.ApplicationPart@6b23c5cf
        System.out.println(req.getPart("userFile"));
        Part userFile = req.getPart("userFile");
        //获取文件名称
        String submittedFileName = userFile.getSubmittedFileName();
        //book01.jpg
        System.out.println(submittedFileName);
        //保存文件的位置->需要被tomcat服务器读取到
        System.out.println(req.getServletContext().getRealPath("/"));
        String realPath = req.getServletContext().getRealPath("/");
        //设置保存文件的指定目录
        String folderName = "upload/";
        //扩展-文件名称
        String fileName = UUID.randomUUID() + ".jpg";
        //保存文件的完整路径
        String absolutePath = realPath + folderName + fileName;
        //将文件保存到指定位置
        userFile.write(absolutePath);
    }
}
```

## 1.4 异步上传

```java
(1)普通的Ajax不能直接传输二进制文件
(2)FormData对象：
	将HTML表单映射成表单对象，将表单对象作为请求数据发送给服务器端
	var formData = new FormData()：创建FormData对象
    formData.append(key,val)：向formData对象上追加数据
```

### 1.4.1 regist.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!--引入axios.js文件-->
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.3.4/axios.js"></script>
</head>
<body>
<form action="/regist" method="post">
    用户名称：<input type="text" name="userName"><br>
    用户密码：<input type="password" name="userPwd"><br>
    <!--
        用户选择好头像之后，发送异步请求
        普通的ajax不能传输图片等二进制文件的，需借助FormData对象：
            var formData = new FormData()：创建FormData对象
            formData.append(key,val)：向formData对象上追加数据

            将HTML表单映射成表单对象，将表单对象作为请求数据发送给服务器端
    -->
    用户头像：<input type="file" id="userFile" onchange="queryFilePath()"><br>
    <!--隐藏框：设置value值为头像的路径值-->
    <input type="hidden" id="userHead" name="userHead"><br>
    <!--....-->
    <input type="submit">
</form>

</body>
<script>
    /*当选择好头像之后*/
    function queryFilePath() {
        console.log(111);
        //创建FormData对象
        var formData = new FormData();
        //将图片数据追加到FormData对象上
        console.log(document.getElementById("userFile").files[0]);
        formData.append("userFile", document.getElementById("userFile").files[0]);
        axios.post("/fileUpload", formData, {"headers": {"Content-Type": "multipart/form-data"}})
            .then(resp => {
                //获取到保存图片的路径值->给隐藏框上的value属性设置值
                console.log(resp);
                document.getElementById("userHead").value = resp.data.returnData.filePath;
                //console.log(document.getElementById("userHead").value);
            })
            .catch(error => {
                console.log(error);
            })
    }
</script>
</html>
```

### 1.4.2 FileUpload

```java
package com.javasm.upload.controller;

import com.alibaba.fastjson.JSON;
import com.javasm.upload.entity.CodeAndMsg;
import com.javasm.upload.entity.ReturnEntity;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.HashMap;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: FileUpload
 * @description: 处理文件上传请求
 * @date: 2023/3/8 11:19
 * @since: 11
 */
@WebServlet("/fileUpload")
@MultipartConfig
public class FileUpload extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //接收图片对象数据
        Part userFile = req.getPart("userFile");
        System.out.println("userFile=" + userFile);
        //获取文件名称
        String fileName = userFile.getSubmittedFileName();
        System.out.println("fileName=" + fileName);
        //将文件保存到指定位置
        String realPath = req.getServletContext().getRealPath("/");
        String folderName = "upload/";
        userFile.write(realPath + folderName + fileName);
        //设置响应数据并给客户端写出
        ReturnEntity re = new ReturnEntity();
        re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
        re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        Map<String, Object> returnMap = new HashMap<>();
        returnMap.put("filePath", "http://localhost:8080/" + folderName + fileName);
        re.setReturnData(returnMap);
        //写出响应数据
        resp.setContentType("application/json;charset=utf-8");
        PrintWriter writer = resp.getWriter();
        writer.print(JSON.toJSONString(re));
        writer.flush();
        writer.close();
    }
}

```

### 1.4.3 RegistController

```java
package com.javasm.upload.controller;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * @author: ShangMa
 * @className: RegistController
 * @description: 处理注册请求
 * @date: 2023/3/8 10:59
 * @since: 11
 */
@WebServlet("/regist")
public class RegistController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println(req.getParameter("userName"));
        System.out.println(req.getParameter("userPwd"));
        System.out.println(req.getParameter("userHead"));

    }
}
```

# 2 项目运用文件上传

## 2.1 内容概述

```
(1)主要解决问题：
	table：表格
	addDialog
	editDialog
(2)流程：
	User.vue
	UploadController：接收图片文件、保存图片文件、写出响应数据(图片路径值)
```

## 2.2 案例实现

### 2.2.1 前端

#### 2.2.1.1 vue

##### User.vue

```vue
<template>
  <div>
    <!-- 行内表单->条件查询 -->
    <el-form
      :inline="true"
      :model="queryForm"
      ref="queryForm"
      class="demo-form-inline"
    >
      <el-form-item label="用户编号" prop="userId">
        <el-input v-model="queryForm.userId" placeholder="用户编号"></el-input>
      </el-form-item>
      <el-form-item label="用户名称" prop="userName">
        <el-input
          v-model="queryForm.userName"
          placeholder="用户名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="executeQuery">查询</el-button>
        <el-button @click="resetForm('queryForm')">重置</el-button>
        <el-button type="success" @click="toAdd()">增加</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格->呈现用户数据 -->
    <el-table :data="userData" style="width: 100%">
      <el-table-column prop="userId" label="用户编号"> </el-table-column>
      <el-table-column prop="userName" label="用户名称">
        <template slot-scope="scope">
          <el-tag>{{ scope.row.userName }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="regTime" label="注册时间"> </el-table-column>
      <el-table-column prop="loginTime" label="最后登录时间"> </el-table-column>
      <el-table-column prop="isValid" label="人员状态">
        <!-- 0在职 1休假 2离职 -->
        <template slot-scope="scope">
          <span v-if="scope.row.isValid == 0">
            <el-tag type="success">在职</el-tag>
          </span>
          <span v-if="scope.row.isValid == 1">
            <el-tag type="warning">休假</el-tag>
          </span>
          <span v-if="scope.row.isValid == 2">
            <el-tag type="danger">离职</el-tag>
          </span>
        </template>
      </el-table-column>
      <el-table-column prop="headImg" label="用户头像">
        <template slot-scope="scope">
          <!-- 
            Avatar 头像->基本用法：
              size：图片大小  "large", "medium", "small"
              src：图片路径
           -->
          <el-avatar :size="'large'" :src="scope.row.headImg"></el-avatar>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button type="warning" @click="toEdit(scope.$index, scope.row)"
            >修改</el-button
          >
          <el-button
            type="danger"
            @click="executeDelete(scope.$index, scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[5, 10, 15, 20]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
    <!-- 增加对话框 -->
    <el-dialog title="增加" :visible.sync="addDialogFormVisible">
      <el-form :model="addForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="addForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="addForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" value="0"></el-option>
            <el-option label="休假" value="1"></el-option>
            <el-option label="离职" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="addForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" value="1"></el-option>
            <el-option label="普通用户" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="addForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <!-- 
            Upload 上传->用户头像上传：
              http-request	覆盖默认的上传行为，可以自定义上传的实现	function
           -->
          <el-upload
            class="avatar-uploader"
            action=""
            :show-file-list="false"
            :http-request="handleAdd"
            :before-upload="beforeAvatarUpload"
          >
            <img v-if="addForm.headImg" :src="addForm.headImg" class="avatar" />
            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="addDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeAdd()">确 定</el-button>
      </div>
    </el-dialog>
    <!-- 修改对话框 -->
    <el-dialog title="修改" :visible.sync="editDialogFormVisible">
      <el-form :model="editForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="editForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="editForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" :value="0"></el-option>
            <el-option label="休假" :value="1"></el-option>
            <el-option label="离职" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="editForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" :value="1"></el-option>
            <el-option label="普通用户" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="editForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <!-- 
            Upload 上传->用户头像上传：
              http-request	覆盖默认的上传行为，可以自定义上传的实现	function
           -->
          <el-upload
            class="avatar-uploader"
            action=""
            :show-file-list="false"
            :http-request="handleEdit"
            :before-upload="beforeAvatarUpload"
          >
            <img
              v-if="editForm.headImg"
              :src="editForm.headImg"
              class="avatar"
            />
            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="editDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeEdit()">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 用户数据 */
      userData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 2,
        totalNum: 30,
      },
      /* 条件查询 */
      queryForm: {
        userId: "",
        userName: "",
      },
      /* 增加 */
      addDialogFormVisible: false,
      addForm: {
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      /* 修改 */
      editDialogFormVisible: false,
      editForm: {
        userId: "",
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      formLabelWidth: "120px",
      imageUrl: "",
    };
  },
  methods: {
    /* 文件上传 */
    /* 增加时：处理图片(把客户端选择的图片发送到服务器端，接收响应数据图片路径，把addForm.headImg赋值) */
    handleAdd(param) {
      console.log(param.file);
      //借助于FormData对象
      var formData = new FormData();
      //把图片数据追加到FormData对象上
      formData.append("userHead", param.file);
      this.$axios
        .post("/upload", formData, {
          headers: {
            "content-type": "multipart/form-data",
          },
        })
        .then((resp) => {
          console.log(resp);
          this.addForm.headImg = resp.data.returnData.filePath;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 处理修改用户数据-头像 */
    handleEdit(item) {
      var formData = new FormData();
      formData.append("userHead", item.file);
      this.$axios
        .post("/upload", formData, {
          headers: { "content-type": "multipart/form-data" },
        })
        .then((resp) => {
          this.editForm.headImg = resp.data.returnData.filePath;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 上传图片之前验证 */
    beforeAvatarUpload(file) {
      const isJPG = file.type === "image/jpeg";
      const isLt2M = file.size / 1024 / 1024 < 2;
      if (!isJPG) {
        this.$message.error("上传头像图片只能是 JPG 格式!");
      }
      if (!isLt2M) {
        this.$message.error("上传头像图片大小不能超过 2MB!");
      }
      return isJPG && isLt2M;
    },
    /* 执行删除 */
    executeDelete(index, row) {
      console.log(index, row);
      this.$confirm("此操作将永久删除该数据, 是否继续?", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning",
      })
        .then(() => {
          //执行删除
          var reqUrl = "/user/delete";
          var reqData = "userId=" + row.userId;
          this.operateCUD(reqUrl, reqData);
        })
        .catch(() => {
          this.$message({
            type: "info",
            message: "已取消删除",
          });
        });
    },
    /* 打开修改对话框 */
    toEdit(index, row) {
      console.log(index, row);
      this.editDialogFormVisible = true;
      //用户编号
      var reqData = "userId=" + row.userId;
      //查询要修改的数据
      this.queryUserByUid(reqData);
    },
    /* 查询要修改的数据 */
    queryUserByUid(reqData) {
      this.$axios
        .post("/user/toEdit", reqData)
        .then((resp) => {
          console.log(resp);
          this.editForm = resp.data.returnData;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 执行修改 */
    executeEdit() {
      this.editDialogFormVisible = false;
      var reqUrl = "/user/edit";
      var reqData = this.$qs.stringify(this.editForm);
      console.log(reqData);
      this.operateCUD(reqUrl, reqData);
    },
    /* 打开增加对话框 */
    toAdd() {
      this.addDialogFormVisible = true;
      this.addForm = { userName: "", isValid: "", roleId: "", headImg: "" };
    },
    /* 执行增加 */
    executeAdd() {
      this.addDialogFormVisible = false;
      console.log(this.addForm.regTime);
      console.log(this.$qs.stringify(this.addForm));
      this.operateCUD("/user/add", this.$qs.stringify(this.addForm));
    },
    /* 公共函数-执行增加修改删除 */
    operateCUD(reqUrl, reqData) {
      this.$axios
        .post(reqUrl, reqData)
        .then((resp) => {
          console.log(resp);
          //设置提示信息
          if (resp.data.returnCode == 2002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "success",
            });
          } else if (resp.data.returnCode == 4002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "error",
            });
          }
          //重新查询用户数据
          this.pageInfo.page = 1;
          this.pageInfo.pageSize = 5;
          var reqData =
            this.$qs.stringify(this.queryForm) +
            "&" +
            this.$qs.stringify(this.pageInfo);
          console.log(reqData);
          this.queryUser(reqData);
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 重置查询条件 */
    resetForm(queryForm) {
      this.$refs[queryForm].resetFields();
      //默认按照第一页数据查询
      this.queryUser("page=1&pageSize=5");
    },
    /* 条件查询 */
    executeQuery() {
      var reqData = this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换当前页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 公共查询函数 */
    queryUser(reqData) {
      this.$axios
        .post("/user/query", reqData)
        .then((resp) => {
          console.log(resp);
          this.userData = resp.data.returnData.userList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    /* 进入用户模块时 */
    this.queryUser("page=1&pageSize=5");
  },
};
</script>
<style>
/* 设置对话框上的日期组件样式 */
div > .el-date-editor.el-input {
  width: 100%;
}

/*  Upload 上传->用户头像上传 */
.avatar-uploader .el-upload {
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.avatar-uploader .el-upload:hover {
  border-color: #409eff;
}
.avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 178px;
  height: 178px;
  line-height: 178px;
  text-align: center;
}
.avatar {
  width: 178px;
  height: 178px;
  display: block;
}
</style>
```

### 2.2.2 后端

#### 2.2.2.1 controller

##### UploadController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: UploadController
 * @description: 处理文件上传请求
 * @date: 2023/3/8 15:07
 * @since: 11
 */
@WebServlet("/upload")
@MultipartConfig
public class UploadController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //接收图片数据
        Part userHead = req.getPart("userHead");
        //获取图片名称
        String fileName = userHead.getSubmittedFileName();
        //设置保存图片文件位置
        String realPath = req.getServletContext().getRealPath("/");
        String folderName = "upload/";
        String filePath = realPath + folderName + fileName;
        //保存文件
        userHead.write(filePath);
        //设置响应数据->保存文件路径
        ReturnEntity re = new ReturnEntity();
        re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
        re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        Map<String, String> returnMap = new HashMap<>();
        returnMap.put("filePath", "http://localhost:8080/" + folderName + fileName);
        re.setReturnData(returnMap);
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

#### 2.2.2.2 filter

##### CFilter

```java
package com.javasm.finance.filter;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.util.RespUtils;

import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: CFilter
 * @description: 权限访问控制过滤器
 * @date: 2023/3/6 16:27
 * @since: 11
 */
@WebFilter("/*")
public class CFilter implements Filter {
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {

    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest req = (HttpServletRequest) servletRequest;
        HttpServletResponse resp = (HttpServletResponse) servletResponse;
        //接收请求路径
        String servletPath = req.getServletPath();
        //获取用户权限访问地址
        HttpSession session = req.getSession();
        List<String> loginUserMenuUrl = (List<String>) session.getAttribute("loginUserMenuUrl");
        //判断
        if ("/login".equals(servletPath) || "/main".equals(servletPath)
                || "/logout".equals(servletPath) || servletPath.endsWith(".jpg")
                || "/upload".equals(servletPath)) {//白名单
            //登录->放行
            filterChain.doFilter(servletRequest, servletResponse);
        } else {
            //不是登录->判断有无权限
            if (loginUserMenuUrl.contains(servletPath)) {
                //有权限
                filterChain.doFilter(servletRequest, servletResponse);
            } else {
                //无权限
                ReturnEntity re = new ReturnEntity();
                re.setReturnCode(CodeAndMsg.NO_AUTH.getReturnCode());
                re.setReturnMsg(CodeAndMsg.NO_AUTH.getReturnMsg());
                RespUtils.handleResp(resp, re);
            }
        }
    }

    @Override
    public void destroy() {

    }
}
```

# 3 用户授权

## 3.1 需求分析

```
(1)流程：
	User.vue->点击授权按钮时->打开授权对话框(呈现用户编号和用户权限数据列表)->授权操作->点击保存按钮时
	->发送请求到服务器端->保存授权数据
	
	呈现用户编号：前端操作
	呈现用户权限数据列表：数据表查询，一级菜单包含二级菜单数据格式|该用户原权限数据呈现被勾选状态
	新用户：保存授权数据：批量插入  batch()  二维数组(数组的数组)
	老用户：删除原权限数据，保存新权限数据
(2)模板：
	树形控件
```

## 3.2 实现过程-授权对话框呈现菜单数据(勾选原菜单编号)

### 3.2.1 后端

#### 3.2.1.1 dao

##### UserDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDao
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserDao {

    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd) throws SQLException;

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId) throws SQLException;


    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号 用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException;


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user) throws SQLException;

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user) throws SQLException;

    /**
     * 根据用户编号查询用户数据
     *
     * @param userId 用户编号
     * @return 用户数据
     */
    User findByUid(Integer userId) throws SQLException;

    /**
     * 修改用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int editUser(User user) throws SQLException;

    /**
     * 删除用户数据
     *
     * @param userId 用户编号
     * @param conn   数据库连接
     * @return 成功影响的记录数
     */
    int deleteUser(Integer userId, Connection conn) throws SQLException;

    /**
     * 查询用户权限数据
     *
     * @param userId 用户编号
     * @return 用户权限数据
     */
    List<UserMenu> findUserMenu(Integer userId) throws SQLException;

    /**
     * 删除用户权限数据
     *
     * @param userId 用户编号
     * @param conn   数据库连接
     * @return 成功影响的记录数
     */
    int deleteUserMenu(Integer userId, Connection conn) throws SQLException;

    /**
     * 设置用户登录时间
     *
     * @param userId 用户编号
     * @return 成功影响的记录数
     */
    int editLoginTime(Integer userId) throws SQLException;


    /**
     * 根据用户编号查询菜单编号集合
     *
     * @param userId 用户编号
     * @return 菜单编号集合
     */
    List<Integer> queryMidList(Integer userId) throws SQLException;

}
```

##### UserDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanHandler;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ColumnListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDaoImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserDaoImpl implements UserDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public User findLoginUser(String userName, String userPwd) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd from fin_admin_user where user_name=? and user_pwd=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userName, userPwd);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_url " +
                "from fin_user_menu um,fin_admin_menu am " +
                "where um.menu_id=am.menu_id " +
                "and am.parent_id!=0 " +
                "and um.user_id=?";
        //将数据表中指定列的字段值，封装到一个list集合中
        ColumnListHandler<String> columnListHandler = new ColumnListHandler<>("menu_url");
        List<String> loginUserMenuUrl = runner.query(conn, sql, columnListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,reg_time,login_time,is_valid,head_img " +
                "from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        //分页查询  m=(page-1)*pageSize  n=pageSize
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        System.out.println("sql=" + sql);
        BeanListHandler<User> beanListHandler = new BeanListHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<User> userList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return userList;
    }

    @Override
    public long findTotalNum(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }

    @Override
    public int addUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "insert into fin_admin_user(user_name,user_pwd,is_valid,role_id,reg_time,head_img) values (?,'1234',?,?,?,?)";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public User findByUid(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd,is_valid,role_id,reg_time,head_img " +
                "from fin_admin_user " +
                "where user_id=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userId);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public int editUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "update " +
                "fin_admin_user " +
                "set " +
                "user_name=?,is_valid=?,role_id=?,reg_time=?,head_img=? " +
                "where " +
                "user_id=?";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg(), user.getUserId());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public int deleteUser(Integer userId, Connection conn) throws SQLException {
        String sql = "delete from fin_admin_user where user_id=?";
        int rows = runner.update(conn, sql, userId);
        return rows;
    }

    @Override
    public List<UserMenu> findUserMenu(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,menu_id from fin_user_menu where user_id=?";
        BeanListHandler<UserMenu> beanListHandler = new BeanListHandler<>(UserMenu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<UserMenu> userMenuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return userMenuList;
    }

    @Override
    public int deleteUserMenu(Integer userId, Connection conn) throws SQLException {
        String sql = "delete from fin_user_menu where user_id=?";
        int rows = runner.update(conn, sql, userId);
        return rows;
    }

    @Override
    public int editLoginTime(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "update fin_admin_user set login_time=now() where user_id=?";
        int rows = runner.update(conn, sql, userId);
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public List<Integer> queryMidList(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select menu_id from fin_user_menu where user_id=?";
        ColumnListHandler<Integer> columnListHandler = new ColumnListHandler<>("menu_id");
        List<Integer> menuIdList = runner.query(conn, sql, columnListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return menuIdList;
    }
}
```

##### MenuDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.Menu;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDao
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public interface MenuDao {

    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @param level  菜单等级
     * @return 登录用户菜单数据
     * @throws SQLException
     */
    List<Menu> findMenu(Integer userId, Integer level) throws SQLException;


    /**
     * 查询菜单数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 菜单数据
     * @throws SQLException
     */
    List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) throws SQLException;


    /**
     * 查询数据表中数据总条数
     *
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 数据总条数
     * @throws SQLException
     */
    long findTotalNum(String menuName, Integer parentId) throws SQLException;

    /**
     * 查询所有的一级菜单数据
     *
     * @return 所有的一级菜单数据
     * @throws SQLException
     */
    List<Menu> findAllOneMenu() throws SQLException;

    /**
     * 增加菜单数据
     *
     * @param menu 菜单数据
     * @return 成功影响的记录数
     */
    int addMenu(Menu menu) throws SQLException;

    /**
     * 根据菜单编号查询菜单数据
     *
     * @param menuId 菜单编号
     * @return 菜单数据
     */
    Menu queryByMenuId(Integer menuId) throws SQLException;

    /**
     * 修改菜单数据
     *
     * @param menu 菜单数据
     * @return 成功影响的记录数
     */
    int editMenu(Menu menu) throws SQLException;

    /**
     * 根据菜单编号删除菜单数据
     *
     * @param menuId 菜单编号
     * @param conn   数据库连接
     * @return 成功影响的记录数
     */
    int deleteMenu(Integer menuId, Connection conn) throws SQLException;

    /**
     * 根据上级菜单编号查询二级菜单数据
     *
     * @param parentId 上级菜单编号
     * @return 二级菜单数据
     */
    List<Menu> querySecondMenu(Integer parentId) throws SQLException;

    /**
     * 根据上级菜单编号删除菜单数据
     *
     * @param parentId 上级菜单编号
     * @param conn     数据库连接
     * @return 成功影响的记录数
     */
    int deleteByParentId(Integer parentId, Connection conn) throws SQLException;


    /**
     * 根据等级查询所有的菜单数据
     *
     * @param level 权限菜单等级
     * @return 所有的菜单数据
     */
    List<Menu> queryByPid(Integer level) throws SQLException;
}
```

##### MenuDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanHandler;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDaoImpl
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public class MenuDaoImpl implements MenuDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public List<Menu> findMenu(Integer userId, Integer level) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id " +
                "from fin_admin_menu am,fin_user_menu um " +
                "where am.menu_id=um.menu_id " +
                "and um.user_id=? ";
        if (level == 1) {
            //一级菜单数据
            sql += "and am.parent_id=0";
        } else {
            //二级菜单数据
            sql += "and am.parent_id!=0";
        }
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') parent_name,m1.menu_url,m1.glyphicon " +
                "from " +
                "fin_admin_menu m1 " +
                "left join " +
                "fin_admin_menu m2 " +
                "on " +
                "m1.parent_id=m2.menu_id ";
        //条件查询        连接词：where and       ?：集合转数组
        boolean isWhere = true;
        List paramList = new ArrayList();
        if (menuName != null && !"".equals(menuName)) {
            if (isWhere) {//T
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.menu_name like ? ";
            paramList.add("%" + menuName + "%");
        }
        if (parentId != null && !"".equals(parentId)) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.parent_id=? ";
            paramList.add(parentId);
        }
        //分页查询
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        //System.out.println(sql);
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public long findTotalNum(String menuName, Integer parentId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_menu m1 ";
        boolean isWhere = true;
        List paramList = new ArrayList();
        if (menuName != null && !"".equals(menuName)) {
            if (isWhere) {//T
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.menu_name like ? ";
            paramList.add("%" + menuName + "%");
        }

        if (parentId != null && !"".equals(parentId)) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "m1.parent_id=? ";
            paramList.add(parentId);
        }
        //单数据  数据总条数
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }

    @Override
    public List<Menu> findAllOneMenu() throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id " +
                "from fin_admin_menu am " +
                "where am.parent_id=0";
        BeanListHandler<Menu> listHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> oneMenuList = runner.query(conn, sql, listHandler);
        DBUtils.getClose(conn, null, null);
        return oneMenuList;
    }

    @Override
    public int addMenu(Menu menu) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "insert into fin_admin_menu(menu_id,menu_name,parent_id,menu_url,glyphicon,version_id) values (?,?,?,?,?,?)";
        int rows = runner.update(conn, sql, menu.getMenuId(), menu.getMenuName(), menu.getParentId(), menu.getMenuUrl(), menu.getGlyphicon(), menu.getVersionId());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public Menu queryByMenuId(Integer menuId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select menu_id,menu_name,parent_id,menu_url,glyphicon,version_id from fin_admin_menu where menu_id=?";
        BeanHandler<Menu> beanHandler = new BeanHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        Menu menu = runner.query(conn, sql, beanHandler, menuId);
        DBUtils.getClose(conn, null, null);
        return menu;
    }

    @Override
    public int editMenu(Menu menu) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "update fin_admin_menu " +
                "set menu_name=?,parent_id=?,menu_url=?,glyphicon=?,version_id=? " +
                "where menu_id=?";
        int rows = runner.update(conn, sql,
                menu.getMenuName(), menu.getParentId(), menu.getMenuUrl(),
                menu.getGlyphicon(), menu.getVersionId() + 1, menu.getMenuId());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public int deleteMenu(Integer menuId, Connection conn) throws SQLException {
        String sql = "delete from fin_admin_menu where menu_id=?";
        int rows = runner.update(conn, sql, menuId);
        return rows;
    }

    @Override
    public List<Menu> querySecondMenu(Integer parentId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select menu_id,menu_name,parent_id,menu_url,glyphicon,version_id from fin_admin_menu where parent_id=?";
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, parentId);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public int deleteByParentId(Integer parentId, Connection conn) throws SQLException {
        String sql = "delete from fin_admin_menu where parent_id=?";
        int rows = runner.update(conn, sql, parentId);
        return rows;
    }

    @Override
    public List<Menu> queryByPid(Integer level) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select menu_id,menu_name,parent_id from fin_admin_menu ";
        if (level == 1) {
            sql += " where parent_id=0";
        } else if (level == 2) {
            sql += " where parent_id!=0";
        }
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }
}
```

#### 3.2.1.2 service

##### UserService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.User;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserService
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserService {
    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd);

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId);

    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号和用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user);


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user);

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user);

    /**
     * 根据用户编号查询用户数据
     *
     * @param userId 用户编号
     * @return 用户数据
     */
    User findByUid(Integer userId);

    /**
     * 修改用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int editUser(User user);

    /**
     * 删除用户数据
     *
     * @param userId 用户编号
     * @return 是否删除成功
     */
    boolean deleteUser(Integer userId);

    /**
     * 设置用户登录时间
     * @param userId 用户编号
     * @return 成功影响的记录数
     */
    int editLoginTime(Integer userId);

    /**
     * 根据用户编号查询菜单编号
     *
     * @param userId 用户编号
     * @return 菜单编号
     */
    String queryUserMenuIdStr(Integer userId);

}
```

##### UserServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.dao.impl.UserDaoImpl;
import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;
import com.javasm.finance.service.UserService;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.DbUtils;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserServiceImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserServiceImpl implements UserService {
    UserDao userDao = new UserDaoImpl();

    @Override
    public User findLoginUser(String userName, String userPwd) {
        User user = null;
        try {
            user = userDao.findLoginUser(userName, userPwd);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) {
        List<String> loginUserMenuUrl = null;
        try {
            loginUserMenuUrl = userDao.findLoginUserMenuUrl(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }

        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) {
        List<User> userList = null;
        try {
            userList = userDao.findUser(page, pageSize, user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return userList;
    }

    @Override
    public long findTotalNum(User user) {
        long totalNum = 0;
        try {
            totalNum = userDao.findTotalNum(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }

    @Override
    public int addUser(User user) {
        int rows = 0;
        try {
            rows = userDao.addUser(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public User findByUid(Integer userId) {
        User user = null;
        try {
            user = userDao.findByUid(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public int editUser(User user) {
        int rows = 0;
        try {
            rows = userDao.editUser(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public boolean deleteUser(Integer userId) {
        boolean isSuccess = false;
        Connection conn = DBUtils.getConn();
        try {
            //关闭事务自动提交
            conn.setAutoCommit(false);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }

        try {
            //删除用户数据
            userDao.deleteUser(userId, conn);
            //若存在用户权限数据，则直接删除
            List<UserMenu> userMenuList = userDao.findUserMenu(userId);
            if (userMenuList != null && userMenuList.size() > 0) {
                userDao.deleteUserMenu(userId, conn);
            }
            //提交事务
            DbUtils.commitAndCloseQuietly(conn);
            isSuccess = true;
        } catch (SQLException throwables) {
            //throwables.printStackTrace();
            DbUtils.rollbackAndCloseQuietly(conn);
        }
        return isSuccess;
    }

    @Override
    public int editLoginTime(Integer userId) {
        int rows = 0;
        try {
            rows = userDao.editLoginTime(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public String queryUserMenuIdStr(Integer userId) {
        List<Integer> menuIdList = null;
        String menuIdStr = "";
        try {
            //[1, 3, 1001, 3001, 3002, 3003, 3004]
            menuIdList = userDao.queryMidList(userId);
            //只保留二级菜单数据编号
            for (int i = 0; i < menuIdList.size(); i++) {
                //1001, 3001, 3002
                if (menuIdList.get(i) > 1000) {
                    menuIdStr += menuIdList.get(i);
                    if (i < menuIdList.size() - 1) {
                        menuIdStr += ",";
                    }
                }
            }
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        System.out.println("menuIdStr=" + menuIdStr);
        return menuIdStr;
    }
}
```

##### MenuService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuService
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public interface MenuService {
    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId);

    /**
     * 查询菜单数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 菜单数据
     */
    List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId);

    /**
     * 查询数据表中数据总条数
     *
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 数据总条数
     */
    long findTotalNum(String menuName, Integer parentId);

    /**
     * 查询所有的一级菜单数据
     *
     * @return 所有的一级菜单数据
     */
    List<Menu> findAllOneMenu();

    /**
     * 增加菜单数据
     *
     * @param menu 菜单数据
     * @return 成功影响的记录数
     */
    int addMenu(Menu menu);

    /**
     * 根据菜单编号查询菜单数据
     *
     * @param menuId 菜单编号
     * @return 菜单数据
     */
    Menu queryByMenuId(Integer menuId);

    /**
     * 修改菜单数据
     *
     * @param menu 菜单数据
     * @return 成功影响的记录数
     */
    int editMenu(Menu menu);

    /**
     * 根据菜单编号删除菜单数据
     *
     * @param menuId 菜单编号
     * @return 是否删除成功
     */
    boolean deleteMenu(Integer menuId);

    /**
     * 根据等级查询所有的菜单数据
     *
     * @return 所有的菜单数据
     */
    List<Menu> queryAllMenu();
}
```

##### MenuServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.dao.impl.MenuDaoImpl;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.DbUtils;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuServiceImpl
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public class MenuServiceImpl implements MenuService {
    MenuDao menuDao = new MenuDaoImpl();

    @Override
    public List<Menu> findMenu(Integer userId) {
        //查询一级菜单数据和二级菜单数据->将二级菜单数据放到一级菜单数据中
        //一级菜单数据
        List<Menu> menuData = null;
        //二级菜单数据
        List<Menu> subMenuData = null;
        try {
            menuData = menuDao.findMenu(userId, 1);
            subMenuData = menuDao.findMenu(userId, 2);
            //将二级菜单数据放到一级菜单数据中
            for (Menu menu : menuData) {
                for (Menu subMenu : subMenuData) {
                    //二级菜单数据的上级编号和一级菜单数据的菜单编号比较
                    if (menu.getMenuId().equals(subMenu.getParentId())) {
                        if (menu.getSubMenu() == null) {
                            menu.setSubMenu(new ArrayList<>());
                        }
                        menu.getSubMenu().add(subMenu);
                    }
                }
            }
            //System.out.println("menuData=" + menuData);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        //一级菜单数据包含二级菜单数据格式
        return menuData;
    }

    @Override
    public List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) {
        List<Menu> menuList = null;
        try {
            menuList = menuDao.findAllMenu(page, pageSize, menuName, parentId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menuList;
    }

    @Override
    public long findTotalNum(String menuName, Integer parentId) {
        long totalNum = 0;
        try {
            totalNum = menuDao.findTotalNum(menuName, parentId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }

    @Override
    public List<Menu> findAllOneMenu() {
        List<Menu> oneMenuList = null;
        try {
            oneMenuList = menuDao.findAllOneMenu();
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return oneMenuList;
    }

    @Override
    public int addMenu(Menu menu) {
        int rows = 0;
        try {
            rows = menuDao.addMenu(menu);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public Menu queryByMenuId(Integer menuId) {
        Menu menu = null;
        try {
            menu = menuDao.queryByMenuId(menuId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menu;
    }

    @Override
    public int editMenu(Menu menu) {
        int rows = 0;
        try {
            rows = menuDao.editMenu(menu);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public boolean deleteMenu(Integer menuId) {
        boolean isSuccess = false;
        Connection conn = DBUtils.getConn();
        try {
            //关闭事务自动提交
            conn.setAutoCommit(false);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        try {
            //删除当条菜单数据(二级菜单数据)
            menuDao.deleteMenu(menuId, conn);
            //删除对应的二级菜单数据
            List<Menu> menuList = menuDao.querySecondMenu(menuId);
            if (menuList != null && menuList.size() > 0) {
                menuDao.deleteByParentId(menuId, conn);
            }
            //提交事务
            DbUtils.commitAndCloseQuietly(conn);
            isSuccess = true;
        } catch (SQLException throwables) {
            throwables.printStackTrace();
            //回退事务
            DbUtils.rollbackAndCloseQuietly(conn);
        }
        return isSuccess;
    }

    @Override
    public List<Menu> queryAllMenu() {
        //一级菜单数据
        List<Menu> menuList = null;
        //二级菜单数据
        List<Menu> subMenuList = null;
        //查询数据
        try {
            menuList = menuDao.queryByPid(1);
            subMenuList = menuDao.queryByPid(2);
            for (Menu menu : menuList) {
                for (Menu subMenu : subMenuList) {
                    if (menu.getMenuId().equals(subMenu.getParentId())) {
                        if (menu.getSubMenu() == null) {
                            menu.setSubMenu(new ArrayList<>());
                        }
                        menu.getSubMenu().add(subMenu);
                    }
                }
            }
            System.out.println("menuList=" + menuList);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menuList;
    }
}
```

#### 3.2.1.3 controller

##### UserController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.*;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.UserService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.service.impl.UserServiceImpl;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: UserController
 * @description: 处理用户请求
 * @date: 2023/3/2 15:54
 * @since: 11
 */
@WebServlet("/user/*")
public class UserController extends BaseController {
    UserService userService = new UserServiceImpl();

    /**
     * 查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void query(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.query()");
        //接收请求数据
        //当前页
        String pageStr = req.getParameter("page");
        Integer page = 1;
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示的数据条数
        String pageSizeStr = req.getParameter("pageSize");
        Integer pageSize = 5;
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        User user = new User(userId, userName);
        //调用方法
        List<User> userList = userService.findUser(page, pageSize, user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (userList != null && userList.size() > 0) {
            //查询数据总条数
            long totalNum = userService.findTotalNum(user);
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("userList", userList);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(returnMap);
        } else {
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("pageInfo", new PageInfo(1, 5, 0l));
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 增加用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void add(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.add()");
        //接收请求数据
        //用户名称
        String userName = req.getParameter("userName");
        //人员状态
        String isValidStr = req.getParameter("isValid");
        Integer isValid = null;
        if (isValidStr != null && !"".equals(isValidStr)) {
            isValid = Integer.valueOf(isValidStr);
        }
        //人员角色
        String roleIdStr = req.getParameter("roleId");
        Integer roleId = null;
        if (roleIdStr != null && !"".equals(roleIdStr)) {
            roleId = Integer.valueOf(roleIdStr);
        }
        //注册时间
        String regTime = req.getParameter("regTime");
        //用户头像
        String headImg = req.getParameter("headImg");
        User user = new User(null, userName, roleId, regTime, isValid, headImg);
        //调用方法
        int rows = userService.addUser(user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 根据用户编号查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void toEdit(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.toEdit()");
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //查询用户数据
        User user = userService.findByUid(userId);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (user != null) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(user);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }


    /**
     * 修改用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void edit(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.edit()");
        //接收请求数据
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        //人员状态
        String isValidStr = req.getParameter("isValid");
        Integer isValid = null;
        if (isValidStr != null && !"".equals(isValidStr)) {
            isValid = Integer.valueOf(isValidStr);
        }
        //人员角色
        String roleIdStr = req.getParameter("roleId");
        Integer roleId = null;
        if (roleIdStr != null && !"".equals(roleIdStr)) {
            roleId = Integer.valueOf(roleIdStr);
        }
        //注册时间
        String regTime = req.getParameter("regTime");
        //用户头像
        String headImg = req.getParameter("headImg");
        User user = new User(userId, userName, roleId, regTime, isValid, headImg);
        //调用方法
        int rows = userService.editUser(user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 删除用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void delete(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.delete()");
        //接收请求数据
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //调用方法
        boolean isSuccess = userService.deleteUser(userId);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (isSuccess) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 查询所有的权限菜单数据和该用户原权限菜单编号
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void queryAllMenuAndUserMid(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.queryAllMenuAndUserMid()");
        //接收请求数据
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //查询所有的菜单数据
        MenuService menuService = new MenuServiceImpl();
        List<Menu> menuList = menuService.queryAllMenu();
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (menuList != null && menuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("menuList", menuList);
            //查询该用户原菜单编号
            String menuIdStr = userService.queryUserMenuIdStr(userId);
            if (menuIdStr != null && !"".equals(menuIdStr)) {
                returnMap.put("menuIdStr", menuIdStr);
            }
            re.setReturnData(returnMap);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
    
}
```

### 3.2.2 前端

#### 3.2.2.1 User.vue

```vue
<template>
  <div>
    <!-- 行内表单->条件查询 -->
    <el-form
      :inline="true"
      :model="queryForm"
      ref="queryForm"
      class="demo-form-inline"
    >
      <el-form-item label="用户编号" prop="userId">
        <el-input v-model="queryForm.userId" placeholder="用户编号"></el-input>
      </el-form-item>
      <el-form-item label="用户名称" prop="userName">
        <el-input
          v-model="queryForm.userName"
          placeholder="用户名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="executeQuery">查询</el-button>
        <el-button @click="resetForm('queryForm')">重置</el-button>
        <el-button type="success" @click="toAdd()">增加</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格->呈现用户数据 -->
    <el-table :data="userData" style="width: 100%">
      <el-table-column prop="userId" label="用户编号"> </el-table-column>
      <el-table-column prop="userName" label="用户名称">
        <template slot-scope="scope">
          <el-tag>{{ scope.row.userName }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="regTime" label="注册时间"> </el-table-column>
      <el-table-column prop="loginTime" label="最后登录时间"> </el-table-column>
      <el-table-column prop="isValid" label="人员状态">
        <!-- 0在职 1休假 2离职 -->
        <template slot-scope="scope">
          <span v-if="scope.row.isValid == 0">
            <el-tag type="success">在职</el-tag>
          </span>
          <span v-if="scope.row.isValid == 1">
            <el-tag type="warning">休假</el-tag>
          </span>
          <span v-if="scope.row.isValid == 2">
            <el-tag type="danger">离职</el-tag>
          </span>
        </template>
      </el-table-column>
      <el-table-column prop="headImg" label="用户头像">
        <template slot-scope="scope">
          <!-- 
            Avatar 头像->基本用法：
              size：图片大小  "large", "medium", "small"
              src：图片路径
           -->
          <el-avatar :size="'large'" :src="scope.row.headImg"></el-avatar>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button type="warning" @click="toEdit(scope.$index, scope.row)"
            >修改</el-button
          >
          <el-button
            type="danger"
            @click="executeDelete(scope.$index, scope.row)"
            >删除</el-button
          >
          <el-button type="success" @click="toGrant(scope.$index, scope.row)"
            >授权</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[5, 10, 15, 20]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
    <!-- 增加对话框 -->
    <el-dialog title="增加" :visible.sync="addDialogFormVisible">
      <el-form :model="addForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="addForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="addForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" value="0"></el-option>
            <el-option label="休假" value="1"></el-option>
            <el-option label="离职" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="addForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" value="1"></el-option>
            <el-option label="普通用户" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="addForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <!-- 
            Upload 上传->用户头像上传：
              http-request	覆盖默认的上传行为，可以自定义上传的实现	function
           -->
          <el-upload
            class="avatar-uploader"
            action=""
            :show-file-list="false"
            :http-request="handleAdd"
            :before-upload="beforeAvatarUpload"
          >
            <img v-if="addForm.headImg" :src="addForm.headImg" class="avatar" />
            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="addDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeAdd()">确 定</el-button>
      </div>
    </el-dialog>
    <!-- 修改对话框 -->
    <el-dialog title="修改" :visible.sync="editDialogFormVisible">
      <el-form :model="editForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="editForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="editForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" :value="0"></el-option>
            <el-option label="休假" :value="1"></el-option>
            <el-option label="离职" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="editForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" :value="1"></el-option>
            <el-option label="普通用户" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="editForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <!-- 
            Upload 上传->用户头像上传：
              http-request	覆盖默认的上传行为，可以自定义上传的实现	function
           -->
          <el-upload
            class="avatar-uploader"
            action=""
            :show-file-list="false"
            :http-request="handleEdit"
            :before-upload="beforeAvatarUpload"
          >
            <img
              v-if="editForm.headImg"
              :src="editForm.headImg"
              class="avatar"
            />
            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="editDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeEdit()">确 定</el-button>
      </div>
    </el-dialog>
    <!-- 授权对话框 -->
    <el-dialog title="授权" :visible.sync="grantDialogFormVisible">
      <el-form :model="grantForm">
        <el-form-item label="用户编号" :label-width="formLabelWidth">
          <el-input
            v-model="grantForm.userId"
            autocomplete="off"
            :disabled="true"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="用户权限" :label-width="formLabelWidth">
          <!-- 树形结构：default-expand-all	是否默认展开所有节点 -->
          <el-tree
            :data="grantForm.menuData"
            show-checkbox
            ref="tree"
            node-key="menuId"
            default-expand-all
            :default-checked-keys="checkedKeys"
            :props="defaultProps"
          >
          </el-tree>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="grantDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeGrant()">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 用户数据 */
      userData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 2,
        totalNum: 30,
      },
      /* 条件查询 */
      queryForm: {
        userId: "",
        userName: "",
      },
      /* 增加 */
      addDialogFormVisible: false,
      addForm: {
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      /* 修改 */
      editDialogFormVisible: false,
      editForm: {
        userId: "",
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      /* 授权 */
      grantDialogFormVisible: false,
      grantForm: {
        userId: "",
        menuData: [],
      },
      /* 默认选中 */
      checkedKeys: [],
      defaultProps: {
        children: "subMenu",
        label: "menuName",
      },
      formLabelWidth: "120px",
    };
  },
  methods: {
    /* 打开授权对话框 */
    toGrant(index, row) {
      //打开授权对话框
      this.grantDialogFormVisible = true;
      //呈现用户编号和用户授权数据
      this.grantForm.userId = row.userId;
      this.queryAllMenuAndUserMid("userId=" + this.grantForm.userId);
    },
    /* 获取所有的权限菜单数据和该用户原权限菜单编号 */
    queryAllMenuAndUserMid(reqData) {
      this.$axios
        .post("/user/queryAllMenuAndUserMid", reqData)
        .then((resp) => {
          console.log(resp);
          this.grantForm.menuData = resp.data.returnData.menuList;
          if (resp.data.returnData.menuIdStr != null) {
            this.checkedKeys = resp.data.returnData.menuIdStr.split(",");
          } else {
            this.checkedKeys = [];
          }
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 执行授权 */
    executeGrant() {
    },
    /* 执行删除 */
    executeDelete(index, row) {
      console.log(index, row);
      this.$confirm("此操作将永久删除该数据, 是否继续?", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning",
      })
        .then(() => {
          //执行删除
          var reqUrl = "/user/delete";
          var reqData = "userId=" + row.userId;
          this.operateCUD(reqUrl, reqData);
        })
        .catch(() => {
          this.$message({
            type: "info",
            message: "已取消删除",
          });
        });
    },
    /* 打开修改对话框 */
    toEdit(index, row) {
      console.log(index, row);
      this.editDialogFormVisible = true;
      //用户编号
      var reqData = "userId=" + row.userId;
      //查询要修改的数据
      this.queryUserByUid(reqData);
    },
    /* 查询要修改的数据 */
    queryUserByUid(reqData) {
      this.$axios
        .post("/user/toEdit", reqData)
        .then((resp) => {
          console.log(resp);
          this.editForm = resp.data.returnData;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 执行修改 */
    executeEdit() {
      this.editDialogFormVisible = false;
      var reqUrl = "/user/edit";
      var reqData = this.$qs.stringify(this.editForm);
      console.log(reqData);
      this.operateCUD(reqUrl, reqData);
    },
    /* 打开增加对话框 */
    toAdd() {
      this.addDialogFormVisible = true;
      this.addForm = { userName: "", isValid: "", roleId: "", headImg: "" };
    },
    /* 执行增加 */
    executeAdd() {
      this.addDialogFormVisible = false;
      console.log(this.addForm.regTime);
      console.log(this.$qs.stringify(this.addForm));
      this.operateCUD("/user/add", this.$qs.stringify(this.addForm));
    },
    /* 文件上传 */
    /* 增加时：处理图片(把客户端选择的图片发送到服务器端，接收响应数据图片路径，把addForm.headImg赋值) */
    handleAdd(param) {
      console.log(param.file);
      //借助于FormData对象
      var formData = new FormData();
      //把图片数据追加到FormData对象上
      formData.append("userHead", param.file);
      this.$axios
        .post("/upload", formData, {
          headers: {
            "content-type": "multipart/form-data",
          },
        })
        .then((resp) => {
          console.log(resp);
          this.addForm.headImg = resp.data.returnData.filePath;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 处理修改用户数据-头像 */
    handleEdit(item) {
      var formData = new FormData();
      formData.append("userHead", item.file);
      this.$axios
        .post("/upload", formData, {
          headers: { "content-type": "multipart/form-data" },
        })
        .then((resp) => {
          this.editForm.headImg = resp.data.returnData.filePath;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 上传图片之前验证 */
    beforeAvatarUpload(file) {
      const isJPG = file.type === "image/jpeg";
      const isLt2M = file.size / 1024 / 1024 < 2;
      if (!isJPG) {
        this.$message.error("上传头像图片只能是 JPG 格式!");
      }
      if (!isLt2M) {
        this.$message.error("上传头像图片大小不能超过 2MB!");
      }
      return isJPG && isLt2M;
    },
    /* 公共函数-执行增加修改删除 */
    operateCUD(reqUrl, reqData) {
      this.$axios
        .post(reqUrl, reqData)
        .then((resp) => {
          console.log(resp);
          //设置提示信息
          if (resp.data.returnCode == 2002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "success",
            });
          } else if (resp.data.returnCode == 4002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "error",
            });
          }
          //重新查询用户数据
          this.pageInfo.page = 1;
          this.pageInfo.pageSize = 5;
          var reqData =
            this.$qs.stringify(this.queryForm) +
            "&" +
            this.$qs.stringify(this.pageInfo);
          console.log(reqData);
          this.queryUser(reqData);
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 重置查询条件 */
    resetForm(queryForm) {
      this.$refs[queryForm].resetFields();
      //默认按照第一页数据查询
      this.queryUser("page=1&pageSize=5");
    },
    /* 条件查询 */
    executeQuery() {
      var reqData = this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换当前页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 公共查询函数 */
    queryUser(reqData) {
      this.$axios
        .post("/user/query", reqData)
        .then((resp) => {
          console.log(resp);
          this.userData = resp.data.returnData.userList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    /* 进入用户模块时 */
    this.queryUser("page=1&pageSize=5");
  },
};
</script>
<style>
/* 设置对话框上的日期组件样式 */
div > .el-date-editor.el-input {
  width: 100%;
}

/*  Upload 上传->用户头像上传 */
.avatar-uploader .el-upload {
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.avatar-uploader .el-upload:hover {
  border-color: #409eff;
}
.avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 178px;
  height: 178px;
  line-height: 178px;
  text-align: center;
}
.avatar {
  width: 178px;
  height: 178px;
  display: block;
}
</style>
```

## 3.3 实现过程-保存用户权限菜单数据

### 3.3.1 后端

#### 3.3.1.1 dao

##### UserDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDao
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserDao {

    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd) throws SQLException;

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId) throws SQLException;


    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号 用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException;


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user) throws SQLException;

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user) throws SQLException;

    /**
     * 根据用户编号查询用户数据
     *
     * @param userId 用户编号
     * @return 用户数据
     */
    User findByUid(Integer userId) throws SQLException;

    /**
     * 修改用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int editUser(User user) throws SQLException;

    /**
     * 删除用户数据
     *
     * @param userId 用户编号
     * @param conn   数据库连接
     * @return 成功影响的记录数
     */
    int deleteUser(Integer userId, Connection conn) throws SQLException;

    /**
     * 查询用户权限数据
     *
     * @param userId 用户编号
     * @return 用户权限数据
     */
    List<UserMenu> findUserMenu(Integer userId) throws SQLException;

    /**
     * 删除用户权限数据
     *
     * @param userId 用户编号
     * @param conn   数据库连接
     * @return 成功影响的记录数
     */
    int deleteUserMenu(Integer userId, Connection conn) throws SQLException;

    /**
     * 设置用户登录时间
     *
     * @param userId 用户编号
     * @return 成功影响的记录数
     */
    int editLoginTime(Integer userId) throws SQLException;


    /**
     * 根据用户编号查询菜单编号集合
     *
     * @param userId 用户编号
     * @return 菜单编号集合
     */
    List<Integer> queryMidList(Integer userId) throws SQLException;


    /**
     * 保存用户权限数据
     *
     * @param userMenuData 用户权限菜单数据
     * @param conn         数据库连接
     * @return 成功影响的记录数
     */
    int addUserMenu(Object[][] userMenuData, Connection conn) throws SQLException;


}
```

##### UserDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanHandler;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ColumnListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDaoImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserDaoImpl implements UserDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public User findLoginUser(String userName, String userPwd) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd from fin_admin_user where user_name=? and user_pwd=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userName, userPwd);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_url " +
                "from fin_user_menu um,fin_admin_menu am " +
                "where um.menu_id=am.menu_id " +
                "and am.parent_id!=0 " +
                "and um.user_id=?";
        //将数据表中指定列的字段值，封装到一个list集合中
        ColumnListHandler<String> columnListHandler = new ColumnListHandler<>("menu_url");
        List<String> loginUserMenuUrl = runner.query(conn, sql, columnListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,reg_time,login_time,is_valid,head_img " +
                "from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        //分页查询  m=(page-1)*pageSize  n=pageSize
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        System.out.println("sql=" + sql);
        BeanListHandler<User> beanListHandler = new BeanListHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<User> userList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return userList;
    }

    @Override
    public long findTotalNum(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }

    @Override
    public int addUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "insert into fin_admin_user(user_name,user_pwd,is_valid,role_id,reg_time,head_img) values (?,'1234',?,?,?,?)";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public User findByUid(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd,is_valid,role_id,reg_time,head_img " +
                "from fin_admin_user " +
                "where user_id=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userId);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public int editUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "update " +
                "fin_admin_user " +
                "set " +
                "user_name=?,is_valid=?,role_id=?,reg_time=?,head_img=? " +
                "where " +
                "user_id=?";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg(), user.getUserId());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public int deleteUser(Integer userId, Connection conn) throws SQLException {
        String sql = "delete from fin_admin_user where user_id=?";
        int rows = runner.update(conn, sql, userId);
        return rows;
    }

    @Override
    public List<UserMenu> findUserMenu(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,menu_id from fin_user_menu where user_id=?";
        BeanListHandler<UserMenu> beanListHandler = new BeanListHandler<>(UserMenu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<UserMenu> userMenuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return userMenuList;
    }

    @Override
    public int deleteUserMenu(Integer userId, Connection conn) throws SQLException {
        String sql = "delete from fin_user_menu where user_id=?";
        int rows = runner.update(conn, sql, userId);
        return rows;
    }

    @Override
    public int editLoginTime(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "update fin_admin_user set login_time=now() where user_id=?";
        int rows = runner.update(conn, sql, userId);
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public List<Integer> queryMidList(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select menu_id from fin_user_menu where user_id=?";
        ColumnListHandler<Integer> columnListHandler = new ColumnListHandler<>("menu_id");
        List<Integer> menuIdList = runner.query(conn, sql, columnListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return menuIdList;
    }

    @Override
    public int addUserMenu(Object[][] userMenuData, Connection conn) throws SQLException {
        String sql = "insert into fin_user_menu(user_id,menu_id) values (?,?)";
        int rows = runner.batch(conn, sql, userMenuData).length;
        return rows;
    }
}
```

#### 3.3.1.2 service

##### MenuService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuService
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public interface MenuService {
    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId);

    /**
     * 查询菜单数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 菜单数据
     */
    List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId);

    /**
     * 查询数据表中数据总条数
     *
     * @param menuName 菜单名称
     * @param parentId 上级菜单编号
     * @return 数据总条数
     */
    long findTotalNum(String menuName, Integer parentId);

    /**
     * 查询所有的一级菜单数据
     *
     * @return 所有的一级菜单数据
     */
    List<Menu> findAllOneMenu();

    /**
     * 增加菜单数据
     *
     * @param menu 菜单数据
     * @return 成功影响的记录数
     */
    int addMenu(Menu menu);

    /**
     * 根据菜单编号查询菜单数据
     *
     * @param menuId 菜单编号
     * @return 菜单数据
     */
    Menu queryByMenuId(Integer menuId);

    /**
     * 修改菜单数据
     *
     * @param menu 菜单数据
     * @return 成功影响的记录数
     */
    int editMenu(Menu menu);

    /**
     * 根据菜单编号删除菜单数据
     *
     * @param menuId 菜单编号
     * @return 是否删除成功
     */
    boolean deleteMenu(Integer menuId);

    /**
     * 根据等级查询所有的菜单数据
     *
     * @return 所有的菜单数据
     */
    List<Menu> queryAllMenu();
}
```

##### MenuServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.dao.impl.MenuDaoImpl;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.DbUtils;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuServiceImpl
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public class MenuServiceImpl implements MenuService {
    MenuDao menuDao = new MenuDaoImpl();

    @Override
    public List<Menu> findMenu(Integer userId) {
        //查询一级菜单数据和二级菜单数据->将二级菜单数据放到一级菜单数据中
        //一级菜单数据
        List<Menu> menuData = null;
        //二级菜单数据
        List<Menu> subMenuData = null;
        try {
            menuData = menuDao.findMenu(userId, 1);
            subMenuData = menuDao.findMenu(userId, 2);
            //将二级菜单数据放到一级菜单数据中
            for (Menu menu : menuData) {
                for (Menu subMenu : subMenuData) {
                    //二级菜单数据的上级编号和一级菜单数据的菜单编号比较
                    if (menu.getMenuId().equals(subMenu.getParentId())) {
                        if (menu.getSubMenu() == null) {
                            menu.setSubMenu(new ArrayList<>());
                        }
                        menu.getSubMenu().add(subMenu);
                    }
                }
            }
            //System.out.println("menuData=" + menuData);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        //一级菜单数据包含二级菜单数据格式
        return menuData;
    }

    @Override
    public List<Menu> findAllMenu(Integer page, Integer pageSize, String menuName, Integer parentId) {
        List<Menu> menuList = null;
        try {
            menuList = menuDao.findAllMenu(page, pageSize, menuName, parentId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menuList;
    }

    @Override
    public long findTotalNum(String menuName, Integer parentId) {
        long totalNum = 0;
        try {
            totalNum = menuDao.findTotalNum(menuName, parentId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }

    @Override
    public List<Menu> findAllOneMenu() {
        List<Menu> oneMenuList = null;
        try {
            oneMenuList = menuDao.findAllOneMenu();
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return oneMenuList;
    }

    @Override
    public int addMenu(Menu menu) {
        int rows = 0;
        try {
            rows = menuDao.addMenu(menu);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public Menu queryByMenuId(Integer menuId) {
        Menu menu = null;
        try {
            menu = menuDao.queryByMenuId(menuId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menu;
    }

    @Override
    public int editMenu(Menu menu) {
        int rows = 0;
        try {
            rows = menuDao.editMenu(menu);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public boolean deleteMenu(Integer menuId) {
        boolean isSuccess = false;
        Connection conn = DBUtils.getConn();
        try {
            //关闭事务自动提交
            conn.setAutoCommit(false);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        try {
            //删除当条菜单数据(二级菜单数据)
            menuDao.deleteMenu(menuId, conn);
            //删除对应的二级菜单数据
            List<Menu> menuList = menuDao.querySecondMenu(menuId);
            if (menuList != null && menuList.size() > 0) {
                menuDao.deleteByParentId(menuId, conn);
            }
            //提交事务
            DbUtils.commitAndCloseQuietly(conn);
            isSuccess = true;
        } catch (SQLException throwables) {
            throwables.printStackTrace();
            //回退事务
            DbUtils.rollbackAndCloseQuietly(conn);
        }
        return isSuccess;
    }

    @Override
    public List<Menu> queryAllMenu() {
        //一级菜单数据
        List<Menu> menuList = null;
        //二级菜单数据
        List<Menu> subMenuList = null;
        //查询数据
        try {
            menuList = menuDao.queryByPid(1);
            subMenuList = menuDao.queryByPid(2);
            for (Menu menu : menuList) {
                for (Menu subMenu : subMenuList) {
                    if (menu.getMenuId().equals(subMenu.getParentId())) {
                        if (menu.getSubMenu() == null) {
                            menu.setSubMenu(new ArrayList<>());
                        }
                        menu.getSubMenu().add(subMenu);
                    }
                }
            }
            System.out.println("menuList=" + menuList);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menuList;
    }
}
```

#### 3.3.1.3 controller

##### UserController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.*;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.UserService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.service.impl.UserServiceImpl;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: UserController
 * @description: 处理用户请求
 * @date: 2023/3/2 15:54
 * @since: 11
 */
@WebServlet("/user/*")
public class UserController extends BaseController {
    UserService userService = new UserServiceImpl();

    /**
     * 查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void query(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.query()");
        //接收请求数据
        //当前页
        String pageStr = req.getParameter("page");
        Integer page = 1;
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示的数据条数
        String pageSizeStr = req.getParameter("pageSize");
        Integer pageSize = 5;
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        User user = new User(userId, userName);
        //调用方法
        List<User> userList = userService.findUser(page, pageSize, user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (userList != null && userList.size() > 0) {
            //查询数据总条数
            long totalNum = userService.findTotalNum(user);
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("userList", userList);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(returnMap);
        } else {
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("pageInfo", new PageInfo(1, 5, 0l));
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 增加用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void add(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.add()");
        //接收请求数据
        //用户名称
        String userName = req.getParameter("userName");
        //人员状态
        String isValidStr = req.getParameter("isValid");
        Integer isValid = null;
        if (isValidStr != null && !"".equals(isValidStr)) {
            isValid = Integer.valueOf(isValidStr);
        }
        //人员角色
        String roleIdStr = req.getParameter("roleId");
        Integer roleId = null;
        if (roleIdStr != null && !"".equals(roleIdStr)) {
            roleId = Integer.valueOf(roleIdStr);
        }
        //注册时间
        String regTime = req.getParameter("regTime");
        //用户头像
        String headImg = req.getParameter("headImg");
        User user = new User(null, userName, roleId, regTime, isValid, headImg);
        //调用方法
        int rows = userService.addUser(user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 根据用户编号查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void toEdit(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.toEdit()");
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //查询用户数据
        User user = userService.findByUid(userId);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (user != null) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(user);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }


    /**
     * 修改用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void edit(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.edit()");
        //接收请求数据
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        //人员状态
        String isValidStr = req.getParameter("isValid");
        Integer isValid = null;
        if (isValidStr != null && !"".equals(isValidStr)) {
            isValid = Integer.valueOf(isValidStr);
        }
        //人员角色
        String roleIdStr = req.getParameter("roleId");
        Integer roleId = null;
        if (roleIdStr != null && !"".equals(roleIdStr)) {
            roleId = Integer.valueOf(roleIdStr);
        }
        //注册时间
        String regTime = req.getParameter("regTime");
        //用户头像
        String headImg = req.getParameter("headImg");
        User user = new User(userId, userName, roleId, regTime, isValid, headImg);
        //调用方法
        int rows = userService.editUser(user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 删除用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void delete(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.delete()");
        //接收请求数据
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //调用方法
        boolean isSuccess = userService.deleteUser(userId);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (isSuccess) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 查询所有的权限菜单数据和该用户原权限菜单编号
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void queryAllMenuAndUserMid(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.queryAllMenuAndUserMid()");
        //接收请求数据
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //查询所有的菜单数据
        MenuService menuService = new MenuServiceImpl();
        List<Menu> menuList = menuService.queryAllMenu();
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (menuList != null && menuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("menuList", menuList);
            //查询该用户原菜单编号
            String menuIdStr = userService.queryUserMenuIdStr(userId);
            if (menuIdStr != null && !"".equals(menuIdStr)) {
                returnMap.put("menuIdStr", menuIdStr);
            }
            re.setReturnData(returnMap);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }


    /**
     * 保存用户权限菜单数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void saveUserMenu(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.saveUserMenu()");
        //接收请求数据 用户编号和权限菜单编号(多个值)
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //创建数组的数组
        Object[][] userMenuData = null;
        String userMenuIdStrs = req.getParameter("userMenuIdStrs");
        if (userMenuIdStrs != null && !"".equals(userMenuIdStrs)) {
            String[] userMenuIdArr = userMenuIdStrs.split(",");
            //有x行有2列
            userMenuData = new Object[userMenuIdArr.length][2];
            for (int i = 0; i < userMenuIdArr.length; i++) {
                //菜单编号
                Integer menuId = Integer.valueOf(userMenuIdArr[i]);
                userMenuData[i][0] = userId;
                userMenuData[i][1] = menuId;
            }
        }
        //调用方法
        boolean isSuccess = userService.saveUserMenu(userId, userMenuData);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (isSuccess) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

### 3.3.2 前端

#### 3.3.2.1 User.vue

```vue
<template>
  <div>
    <!-- 行内表单->条件查询 -->
    <el-form
      :inline="true"
      :model="queryForm"
      ref="queryForm"
      class="demo-form-inline"
    >
      <el-form-item label="用户编号" prop="userId">
        <el-input v-model="queryForm.userId" placeholder="用户编号"></el-input>
      </el-form-item>
      <el-form-item label="用户名称" prop="userName">
        <el-input
          v-model="queryForm.userName"
          placeholder="用户名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="executeQuery">查询</el-button>
        <el-button @click="resetForm('queryForm')">重置</el-button>
        <el-button type="success" @click="toAdd()">增加</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格->呈现用户数据 -->
    <el-table :data="userData" style="width: 100%">
      <el-table-column prop="userId" label="用户编号"> </el-table-column>
      <el-table-column prop="userName" label="用户名称">
        <template slot-scope="scope">
          <el-tag>{{ scope.row.userName }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="regTime" label="注册时间"> </el-table-column>
      <el-table-column prop="loginTime" label="最后登录时间"> </el-table-column>
      <el-table-column prop="isValid" label="人员状态">
        <!-- 0在职 1休假 2离职 -->
        <template slot-scope="scope">
          <span v-if="scope.row.isValid == 0">
            <el-tag type="success">在职</el-tag>
          </span>
          <span v-if="scope.row.isValid == 1">
            <el-tag type="warning">休假</el-tag>
          </span>
          <span v-if="scope.row.isValid == 2">
            <el-tag type="danger">离职</el-tag>
          </span>
        </template>
      </el-table-column>
      <el-table-column prop="headImg" label="用户头像">
        <template slot-scope="scope">
          <!-- 
            Avatar 头像->基本用法：
              size：图片大小  "large", "medium", "small"
              src：图片路径
           -->
          <el-avatar :size="'large'" :src="scope.row.headImg"></el-avatar>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button type="warning" @click="toEdit(scope.$index, scope.row)"
            >修改</el-button
          >
          <el-button
            type="danger"
            @click="executeDelete(scope.$index, scope.row)"
            >删除</el-button
          >
          <el-button type="success" @click="toGrant(scope.$index, scope.row)"
            >授权</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[5, 10, 15, 20]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
    <!-- 增加对话框 -->
    <el-dialog title="增加" :visible.sync="addDialogFormVisible">
      <el-form :model="addForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="addForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="addForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" value="0"></el-option>
            <el-option label="休假" value="1"></el-option>
            <el-option label="离职" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="addForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" value="1"></el-option>
            <el-option label="普通用户" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="addForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <!-- 
            Upload 上传->用户头像上传：
              http-request	覆盖默认的上传行为，可以自定义上传的实现	function
           -->
          <el-upload
            class="avatar-uploader"
            action=""
            :show-file-list="false"
            :http-request="handleAdd"
            :before-upload="beforeAvatarUpload"
          >
            <img v-if="addForm.headImg" :src="addForm.headImg" class="avatar" />
            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="addDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeAdd()">确 定</el-button>
      </div>
    </el-dialog>
    <!-- 修改对话框 -->
    <el-dialog title="修改" :visible.sync="editDialogFormVisible">
      <el-form :model="editForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="editForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="editForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" :value="0"></el-option>
            <el-option label="休假" :value="1"></el-option>
            <el-option label="离职" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="editForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" :value="1"></el-option>
            <el-option label="普通用户" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="editForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <!-- 
            Upload 上传->用户头像上传：
              http-request	覆盖默认的上传行为，可以自定义上传的实现	function
           -->
          <el-upload
            class="avatar-uploader"
            action=""
            :show-file-list="false"
            :http-request="handleEdit"
            :before-upload="beforeAvatarUpload"
          >
            <img
              v-if="editForm.headImg"
              :src="editForm.headImg"
              class="avatar"
            />
            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
          </el-upload>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="editDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeEdit()">确 定</el-button>
      </div>
    </el-dialog>
    <!-- 授权对话框 -->
    <el-dialog title="授权" :visible.sync="grantDialogFormVisible">
      <el-form :model="grantForm">
        <el-form-item label="用户编号" :label-width="formLabelWidth">
          <el-input
            v-model="grantForm.userId"
            autocomplete="off"
            :disabled="true"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="用户权限" :label-width="formLabelWidth">
          <!-- 树形结构：default-expand-all	是否默认展开所有节点 -->
          <el-tree
            :data="grantForm.menuData"
            show-checkbox
            ref="tree"
            node-key="menuId"
            default-expand-all
            :default-checked-keys="checkedKeys"
            :props="defaultProps"
          >
          </el-tree>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="grantDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeGrant()">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 用户数据 */
      userData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 2,
        totalNum: 30,
      },
      /* 条件查询 */
      queryForm: {
        userId: "",
        userName: "",
      },
      /* 增加 */
      addDialogFormVisible: false,
      addForm: {
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      /* 修改 */
      editDialogFormVisible: false,
      editForm: {
        userId: "",
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      /* 授权 */
      grantDialogFormVisible: false,
      grantForm: {
        userId: "",
        menuData: [],
      },
      /* 默认选中 */
      checkedKeys: [],
      defaultProps: {
        children: "subMenu",
        label: "menuName",
      },
      formLabelWidth: "120px",
    };
  },
  methods: {
    /* 打开授权对话框 */
    toGrant(index, row) {
      //打开授权对话框
      this.grantDialogFormVisible = true;
      //呈现用户编号和用户授权数据
      this.grantForm.userId = row.userId;
      this.queryAllMenuAndUserMid("userId=" + this.grantForm.userId);
    },
    /* 获取所有的权限菜单数据和该用户原权限菜单编号 */
    queryAllMenuAndUserMid(reqData) {
      this.$axios
        .post("/user/queryAllMenuAndUserMid", reqData)
        .then((resp) => {
          console.log(resp);
          this.grantForm.menuData = resp.data.returnData.menuList;
          if (resp.data.returnData.menuIdStr != null) {
            this.checkedKeys = resp.data.returnData.menuIdStr.split(",");
          } else {
            this.checkedKeys = [];
          }
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 执行授权 */
    executeGrant() {
      // 关闭授权对话框
      this.grantDialogFormVisible = false;
      // 执行授权
      // 获取用户编号和权限菜单编号
      var userId = this.grantForm.userId;
      /**
       * getCheckedKeys	若节点可被选择（即 show-checkbox 为 true），则返回目前被选中的节点的 key 所组成的数组
       * getHalfCheckedKeys	若节点可被选择（即 show-checkbox 为 true），则返回目前半选中的节点的 key 所组成的数组
       */
      //若对于二级菜单数据部分选择，只能获取到二级的菜单菜单
      console.log(this.$refs.tree.getCheckedKeys());
      //若对于二级菜单数据部分选择，只能获取到一级的菜单菜单
      console.log(this.$refs.tree.getHalfCheckedKeys());
      var userMenuIdStrs =
        this.$refs.tree.getCheckedKeys().join(",") +
        "," +
        this.$refs.tree.getHalfCheckedKeys().join(",");
      console.log(userMenuIdStrs);
      if (userMenuIdStrs.length == 1) {
        //没有授权->设置提示信息
        this.$message({
          showClose: true,
          message: "请勾选权限菜单数据",
          type: "warning",
        });
      } else {
        this.operateCUD(
          "/user/saveUserMenu",
          "userId=" + userId + "&userMenuIdStrs=" + userMenuIdStrs
        );
      }
    },
    /* 执行删除 */
    executeDelete(index, row) {
      console.log(index, row);
      this.$confirm("此操作将永久删除该数据, 是否继续?", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning",
      })
        .then(() => {
          //执行删除
          var reqUrl = "/user/delete";
          var reqData = "userId=" + row.userId;
          this.operateCUD(reqUrl, reqData);
        })
        .catch(() => {
          this.$message({
            type: "info",
            message: "已取消删除",
          });
        });
    },
    /* 打开修改对话框 */
    toEdit(index, row) {
      console.log(index, row);
      this.editDialogFormVisible = true;
      //用户编号
      var reqData = "userId=" + row.userId;
      //查询要修改的数据
      this.queryUserByUid(reqData);
    },
    /* 查询要修改的数据 */
    queryUserByUid(reqData) {
      this.$axios
        .post("/user/toEdit", reqData)
        .then((resp) => {
          console.log(resp);
          this.editForm = resp.data.returnData;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 执行修改 */
    executeEdit() {
      this.editDialogFormVisible = false;
      var reqUrl = "/user/edit";
      var reqData = this.$qs.stringify(this.editForm);
      console.log(reqData);
      this.operateCUD(reqUrl, reqData);
    },
    /* 打开增加对话框 */
    toAdd() {
      this.addDialogFormVisible = true;
      this.addForm = { userName: "", isValid: "", roleId: "", headImg: "" };
    },
    /* 执行增加 */
    executeAdd() {
      this.addDialogFormVisible = false;
      console.log(this.addForm.regTime);
      console.log(this.$qs.stringify(this.addForm));
      this.operateCUD("/user/add", this.$qs.stringify(this.addForm));
    },
    /* 文件上传 */
    /* 增加时：处理图片(把客户端选择的图片发送到服务器端，接收响应数据图片路径，把addForm.headImg赋值) */
    handleAdd(param) {
      console.log(param.file);
      //借助于FormData对象
      var formData = new FormData();
      //把图片数据追加到FormData对象上
      formData.append("userHead", param.file);
      this.$axios
        .post("/upload", formData, {
          headers: {
            "content-type": "multipart/form-data",
          },
        })
        .then((resp) => {
          console.log(resp);
          this.addForm.headImg = resp.data.returnData.filePath;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 处理修改用户数据-头像 */
    handleEdit(item) {
      var formData = new FormData();
      formData.append("userHead", item.file);
      this.$axios
        .post("/upload", formData, {
          headers: { "content-type": "multipart/form-data" },
        })
        .then((resp) => {
          this.editForm.headImg = resp.data.returnData.filePath;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 上传图片之前验证 */
    beforeAvatarUpload(file) {
      const isJPG = file.type === "image/jpeg";
      const isLt2M = file.size / 1024 / 1024 < 2;
      if (!isJPG) {
        this.$message.error("上传头像图片只能是 JPG 格式!");
      }
      if (!isLt2M) {
        this.$message.error("上传头像图片大小不能超过 2MB!");
      }
      return isJPG && isLt2M;
    },
    /* 公共函数-执行增加修改删除 */
    operateCUD(reqUrl, reqData) {
      this.$axios
        .post(reqUrl, reqData)
        .then((resp) => {
          console.log(resp);
          //设置提示信息
          if (resp.data.returnCode == 2002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "success",
            });
          } else if (resp.data.returnCode == 4002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "error",
            });
          }
          //重新查询用户数据
          this.pageInfo.page = 1;
          this.pageInfo.pageSize = 5;
          var reqData =
            this.$qs.stringify(this.queryForm) +
            "&" +
            this.$qs.stringify(this.pageInfo);
          console.log(reqData);
          this.queryUser(reqData);
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 重置查询条件 */
    resetForm(queryForm) {
      this.$refs[queryForm].resetFields();
      //默认按照第一页数据查询
      this.queryUser("page=1&pageSize=5");
    },
    /* 条件查询 */
    executeQuery() {
      var reqData = this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换当前页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 公共查询函数 */
    queryUser(reqData) {
      this.$axios
        .post("/user/query", reqData)
        .then((resp) => {
          console.log(resp);
          this.userData = resp.data.returnData.userList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    /* 进入用户模块时 */
    this.queryUser("page=1&pageSize=5");
  },
};
</script>
<style>
/* 设置对话框上的日期组件样式 */
div > .el-date-editor.el-input {
  width: 100%;
}

/*  Upload 上传->用户头像上传 */
.avatar-uploader .el-upload {
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.avatar-uploader .el-upload:hover {
  border-color: #409eff;
}
.avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 178px;
  height: 178px;
  line-height: 178px;
  text-align: center;
}
.avatar {
  width: 178px;
  height: 178px;
  display: block;
}
</style>
```





























































