---
typora-copy-images-to: ./img
---

# 用户模块-CRUD

```
(1)用户模块-CRUD
(2)系统主界面显示登录用户名称
(3)用户登出
(4)修改用户登录时间
```

# 1 用户-查询

## 1.1 需求分析

![image-20230306172619598](img/image-20230306172619598.png)



```sql
(1)流程：
	用户进入用户模块：基础查询
	用户操作分页：分页查询
	用户设置条件：条件查询
(2)前端：
	设置公共查询方法->获取响应数据->利用表格形式呈现数据
(3)后端：
	UserController->UserService->UserDao
	
	UserController：
		获取请求数据：当前页page、每页显示数据条数pageSize、用户编号userId、用户名称userName
	UserDao：
		情况一：
            select 
                user_id,user_name,login_time,is_valid,head_img
            from 
                in_admin_user
            where 
                user_id=1
            and 
                user_name like '%o%'
            limit 0,5
		情况二：
            select 
                user_id,user_name,login_time,is_valid,head_img
            from 
                in_admin_user
            limit 0,5
		情况三：
        	select 
                user_id,user_name,login_time,is_valid,head_img
            from 
                in_admin_user
            where 
                user_id=1
            limit 0,5
		情况四：
       		select 
                user_id,user_name,login_time,is_valid,head_img
            from 
                in_admin_user
            where 
                user_name like '%o%'
            limit 0,5
```

## 1.2 实现过程

### 1.2.1 后端

#### 1.2.1.1 entity

##### User

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: User
 * @description:
 * @date: 2023/2/28 18:08
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class User {
    //用户编号
    private Integer userId;
    //用户名称
    private String userName;
    //用户密码
    private String userPwd;
    //角色id 1管理员 2普通用户
    private Integer roleId;
    //注册时间
    private String regTime;
    //登录时间
    private String loginTime;
    //0在职 1休假 2离职
    private Integer isValid;
    //头像路径
    private String headImg;
    //版本编号
    private Integer versionId;

    public User(String userName, String userPwd) {
        this.userName = userName;
        this.userPwd = userPwd;
    }

    public User(Integer userId, String userName) {
        this.userId = userId;
        this.userName = userName;
    }
}
```

#### 1.2.1.2 dao

##### UserDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.User;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDao
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserDao {

    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd) throws SQLException;

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId) throws SQLException;


    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号 用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException;


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user) throws SQLException;


}
```

##### UserDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.entity.User;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanHandler;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ColumnListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDaoImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserDaoImpl implements UserDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public User findLoginUser(String userName, String userPwd) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd from fin_admin_user where user_name=? and user_pwd=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userName, userPwd);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_url " +
                "from fin_user_menu um,fin_admin_menu am " +
                "where um.menu_id=am.menu_id " +
                "and am.parent_id!=0 " +
                "and um.user_id=?";
        //将数据表中指定列的字段值，封装到一个list集合中
        ColumnListHandler<String> columnListHandler = new ColumnListHandler<>("menu_url");
        List<String> loginUserMenuUrl = runner.query(conn, sql, columnListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,login_time,is_valid,head_img " +
                "from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        //分页查询  m=(page-1)*pageSize  n=pageSize
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        System.out.println("sql=" + sql);
        BeanListHandler<User> beanListHandler = new BeanListHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<User> userList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return userList;
    }

    @Override
    public long findTotalNum(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }
}
```

#### 1.2.1.3 service

##### UserService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.User;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserService
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserService {
    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd);

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId);

    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号和用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user);


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user);
}
```

##### UserServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.dao.impl.UserDaoImpl;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.UserService;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserServiceImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserServiceImpl implements UserService {
    UserDao userDao = new UserDaoImpl();

    @Override
    public User findLoginUser(String userName, String userPwd) {
        User user = null;
        try {
            user = userDao.findLoginUser(userName, userPwd);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) {
        List<String> loginUserMenuUrl = null;
        try {
            loginUserMenuUrl = userDao.findLoginUserMenuUrl(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }

        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) {
        List<User> userList = null;
        try {
            userList = userDao.findUser(page, pageSize, user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return userList;
    }

    @Override
    public long findTotalNum(User user) {
        long totalNum = 0;
        try {
            totalNum = userDao.findTotalNum(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }
}
```

#### 1.2.1.4 controller

##### UserController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.PageInfo;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.UserService;
import com.javasm.finance.service.impl.UserServiceImpl;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: UserController
 * @description: 处理用户请求
 * @date: 2023/3/2 15:54
 * @since: 11
 */
@WebServlet("/user/*")
public class UserController extends BaseController {
    UserService userService = new UserServiceImpl();

    /**
     * 查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void query(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.query()");
        //接收请求数据
        //当前页
        String pageStr = req.getParameter("page");
        Integer page = 1;
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示的数据条数
        String pageSizeStr = req.getParameter("pageSize");
        Integer pageSize = 5;
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        User user = new User(userId, userName);
        //调用方法
        List<User> userList = userService.findUser(page, pageSize, user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (userList != null && userList.size() > 0) {
            //查询数据总条数
            long totalNum = userService.findTotalNum(user);
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("userList", userList);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(returnMap);
        } else {
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("pageInfo", new PageInfo(1, 5, 0l));
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

}
```

### 1.2.2 前端

#### 1.2.2.1 User.vue

```vue
<template>
  <div>
    <!-- 行内表单->条件查询 -->
    <el-form
      :inline="true"
      :model="queryForm"
      ref="queryForm"
      class="demo-form-inline"
    >
      <el-form-item label="用户编号" prop="userId">
        <el-input v-model="queryForm.userId" placeholder="用户编号"></el-input>
      </el-form-item>
      <el-form-item label="用户名称" prop="userName">
        <el-input
          v-model="queryForm.userName"
          placeholder="用户名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="executeQuery">查询</el-button>
        <el-button @click="resetForm('queryForm')">重置</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格->呈现用户数据 -->
    <el-table :data="userData" style="width: 100%">
      <el-table-column prop="userId" label="用户编号"> </el-table-column>
      <el-table-column prop="userName" label="用户名称">
        <template slot-scope="scope">
          <el-tag>{{ scope.row.userName }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="loginTime" label="最后登录时间"> </el-table-column>
      <el-table-column prop="isValid" label="人员状态">
        <!-- 0在职 1休假 2离职 -->
        <template slot-scope="scope">
          <span v-if="scope.row.isValid == 0">
            <el-tag :type="scope.row.isValid === 0 ? 'success' : 'warning'"
              >在职</el-tag
            >
          </span>
          <span v-if="scope.row.isValid == 1">
            <el-tag :type="scope.row.isValid === 0 ? 'success' : 'warning'"
              >休假</el-tag
            >
          </span>
          <span v-if="scope.row.isValid == 2">
            <el-tag :type="scope.row.isValid === 2 ? 'danger' : 'warning'"
              >离职</el-tag
            >
          </span>
        </template>
      </el-table-column>
      <el-table-column prop="headImg" label="用户头像"> </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[5, 10, 15, 20]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 用户数据 */
      userData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 2,
        totalNum: 30,
      },
      /* 条件查询 */
      queryForm: {
        userId: "",
        userName: "",
      },
    };
  },
  methods: {
    /* 重置查询条件 */
    resetForm(queryForm) {
      this.$refs[queryForm].resetFields();
      //默认按照第一页数据查询
      this.queryUser("page=1&pageSize=5");
    },
    /* 条件查询 */
    executeQuery() {
      var reqData = this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换当前页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 公共查询函数 */
    queryUser(reqData) {
      this.$axios
        .post("/user/query", reqData)
        .then((resp) => {
          console.log(resp);
          this.userData = resp.data.returnData.userList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    /* 进入用户模块时 */
    this.queryUser("page=1&pageSize=5");
  },
};
</script>
<style>
</style>
```

# 2 用户-增加

## 2.1 需求分析

```
(1)流程：
	A.
		User.vue->点击增加按钮时->打开增加对话框->点击保存按钮时->向服务器端发请求保存用户数据
		->UserController(add)->UserService->UserDao
	B.
		UserController(add)->写出响应数据(增加成功|增加失败)->User.vue->给用户设置提示信息
(2)sql：
	insert into fin_admin_user(user_name,is_valid,role_id,head_img) values (?,?,?,?);
```

![image-20230306172753579](img/image-20230306172753579.png)

## 2.2 实现过程

### 2.2.1 后端

#### 2.2.1.1 entity

##### User

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: User
 * @description:
 * @date: 2023/2/28 18:08
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class User {
    //用户编号
    private Integer userId;
    //用户名称
    private String userName;
    //用户密码
    private String userPwd;
    //角色id 1管理员 2普通用户
    private Integer roleId;
    //注册时间
    private String regTime;
    //登录时间
    private String loginTime;
    //0在职 1休假 2离职
    private Integer isValid;
    //头像路径
    private String headImg;
    //版本编号
    private Integer versionId;

    public User(String userName, String userPwd) {
        this.userName = userName;
        this.userPwd = userPwd;
    }

    public User(Integer userId, String userName) {
        this.userId = userId;
        this.userName = userName;
    }

    public User(String userName, Integer roleId, Integer isValid, String headImg) {
        this.userName = userName;
        this.roleId = roleId;
        this.isValid = isValid;
        this.headImg = headImg;
    }
}
```

#### 2.2.1.2 dao

##### UserDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.User;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDao
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserDao {

    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd) throws SQLException;

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId) throws SQLException;


    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号 用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException;


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user) throws SQLException;

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user) throws SQLException;


}
```

##### UserDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.entity.User;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanHandler;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ColumnListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDaoImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserDaoImpl implements UserDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public User findLoginUser(String userName, String userPwd) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd from fin_admin_user where user_name=? and user_pwd=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userName, userPwd);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_url " +
                "from fin_user_menu um,fin_admin_menu am " +
                "where um.menu_id=am.menu_id " +
                "and am.parent_id!=0 " +
                "and um.user_id=?";
        //将数据表中指定列的字段值，封装到一个list集合中
        ColumnListHandler<String> columnListHandler = new ColumnListHandler<>("menu_url");
        List<String> loginUserMenuUrl = runner.query(conn, sql, columnListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,login_time,is_valid,head_img " +
                "from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        //分页查询  m=(page-1)*pageSize  n=pageSize
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        System.out.println("sql=" + sql);
        BeanListHandler<User> beanListHandler = new BeanListHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<User> userList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return userList;
    }

    @Override
    public long findTotalNum(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }

    @Override
    public int addUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "insert into fin_admin_user(user_name,user_pwd,is_valid,role_id,reg_time,head_img) values (?,'1234',?,?,now(),?)";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getHeadImg());
        DBUtils.getClose(conn, null, null);
        return rows;
    }
}
```

#### 2.2.1.3 service

##### UserService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.User;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserService
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserService {
    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd);

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId);

    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号和用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user);


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user);

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user);
}
```

##### UserServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.dao.impl.UserDaoImpl;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.UserService;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserServiceImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserServiceImpl implements UserService {
    UserDao userDao = new UserDaoImpl();

    @Override
    public User findLoginUser(String userName, String userPwd) {
        User user = null;
        try {
            user = userDao.findLoginUser(userName, userPwd);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) {
        List<String> loginUserMenuUrl = null;
        try {
            loginUserMenuUrl = userDao.findLoginUserMenuUrl(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }

        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) {
        List<User> userList = null;
        try {
            userList = userDao.findUser(page, pageSize, user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return userList;
    }

    @Override
    public long findTotalNum(User user) {
        long totalNum = 0;
        try {
            totalNum = userDao.findTotalNum(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }

    @Override
    public int addUser(User user) {
        int rows = 0;
        try {
            rows = userDao.addUser(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }
}
```

#### 2.2.1.4 controller

##### UserController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.PageInfo;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.UserService;
import com.javasm.finance.service.impl.UserServiceImpl;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: UserController
 * @description: 处理用户请求
 * @date: 2023/3/2 15:54
 * @since: 11
 */
@WebServlet("/user/*")
public class UserController extends BaseController {
    UserService userService = new UserServiceImpl();

    /**
     * 查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void query(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.query()");
        //接收请求数据
        //当前页
        String pageStr = req.getParameter("page");
        Integer page = 1;
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示的数据条数
        String pageSizeStr = req.getParameter("pageSize");
        Integer pageSize = 5;
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        User user = new User(userId, userName);
        //调用方法
        List<User> userList = userService.findUser(page, pageSize, user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (userList != null && userList.size() > 0) {
            //查询数据总条数
            long totalNum = userService.findTotalNum(user);
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("userList", userList);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(returnMap);
        } else {
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("pageInfo", new PageInfo(1, 5, 0l));
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 增加用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void add(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.add()");
        //接收请求数据
        //用户名称
        String userName = req.getParameter("userName");
        //人员状态
        String isValidStr = req.getParameter("isValid");
        Integer isValid = null;
        if (isValidStr != null && !"".equals(isValidStr)) {
            isValid = Integer.valueOf(isValidStr);
        }
        //人员角色
        String roleIdStr = req.getParameter("roleId");
        Integer roleId = null;
        if (roleIdStr != null && !"".equals(roleIdStr)) {
            roleId = Integer.valueOf(roleIdStr);
        }
        //用户头像
        String headImg = req.getParameter("headImg");
        User user = new User(userName, roleId, isValid, headImg);
        //调用方法
        int rows = userService.addUser(user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

### 2.2.2 前端

#### 2.2.2.1 User.vue

```vue
<template>
  <div>
    <!-- 行内表单->条件查询 -->
    <el-form
      :inline="true"
      :model="queryForm"
      ref="queryForm"
      class="demo-form-inline"
    >
      <el-form-item label="用户编号" prop="userId">
        <el-input v-model="queryForm.userId" placeholder="用户编号"></el-input>
      </el-form-item>
      <el-form-item label="用户名称" prop="userName">
        <el-input
          v-model="queryForm.userName"
          placeholder="用户名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="executeQuery">查询</el-button>
        <el-button @click="resetForm('queryForm')">重置</el-button>
        <el-button type="success" @click="toAdd()">增加</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格->呈现用户数据 -->
    <el-table :data="userData" style="width: 100%">
      <el-table-column prop="userId" label="用户编号"> </el-table-column>
      <el-table-column prop="userName" label="用户名称">
        <template slot-scope="scope">
          <el-tag>{{ scope.row.userName }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="loginTime" label="最后登录时间"> </el-table-column>
      <el-table-column prop="isValid" label="人员状态">
        <!-- 0在职 1休假 2离职 -->
        <template slot-scope="scope">
          <span v-if="scope.row.isValid == 0">
            <el-tag type="success">在职</el-tag>
          </span>
          <span v-if="scope.row.isValid == 1">
            <el-tag type="warning">休假</el-tag>
          </span>
          <span v-if="scope.row.isValid == 2">
            <el-tag type="danger">离职</el-tag>
          </span>
        </template>
      </el-table-column>
      <el-table-column prop="headImg" label="用户头像"> </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[5, 10, 15, 20]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
    <!-- 增加对话框 -->
    <el-dialog title="增加" :visible.sync="addDialogFormVisible">
      <el-form :model="addForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="addForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="addForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" value="0"></el-option>
            <el-option label="休假" value="1"></el-option>
            <el-option label="离职" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="addForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" value="1"></el-option>
            <el-option label="普通用户" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <el-input
            v-model="addForm.headImg"
            autocomplete="off"
            placeholder="请输入用户头像"
          ></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="addDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeAdd()">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 用户数据 */
      userData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 2,
        totalNum: 30,
      },
      /* 条件查询 */
      queryForm: {
        userId: "",
        userName: "",
      },
      /* 增加 */
      addDialogFormVisible: false,
      addForm: {
        userName: "",
        isValid: "",
        roleId: "",
        headImg: "",
      },
      formLabelWidth: "120px",
    };
  },
  methods: {
    /* 打开增加对话框 */
    toAdd() {
      this.addDialogFormVisible = true;
      this.addForm = { userName: "", isValid: "", roleId: "", headImg: "" };
    },
    /* 执行增加 */
    executeAdd() {
      this.addDialogFormVisible = false;
      console.log(this.$qs.stringify(this.addForm));
      this.operateCUD("/user/add", this.$qs.stringify(this.addForm));
    },
    /* 公共函数-执行增加修改删除 */
    operateCUD(reqUrl, reqData) {
      this.$axios
        .post(reqUrl, reqData)
        .then((resp) => {
          console.log(resp);
          //设置提示信息
          if (resp.data.returnCode == 2002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "success",
            });
          } else if (resp.data.returnCode == 4002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "error",
            });
          }
          //重新查询用户数据
          var reqData =
            this.$qs.stringify(this.queryForm) +
            "&" +
            this.$qs.stringify(this.pageInfo);
          console.log(reqData);
          this.queryUser(reqData);
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 重置查询条件 */
    resetForm(queryForm) {
      this.$refs[queryForm].resetFields();
      //默认按照第一页数据查询
      this.queryUser("page=1&pageSize=5");
    },
    /* 条件查询 */
    executeQuery() {
      var reqData = this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换当前页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 公共查询函数 */
    queryUser(reqData) {
      this.$axios
        .post("/user/query", reqData)
        .then((resp) => {
          console.log(resp);
          this.userData = resp.data.returnData.userList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    /* 进入用户模块时 */
    this.queryUser("page=1&pageSize=5");
  },
};
</script>
<style>
</style>
```

# 3 用户-修改

## 3.1 需求分析

```sql
(1)流程：
	User.vue->点击修改按钮->打开修改对话框&呈现原数据->向服务器端发请求执行修改
	->UserController(edit)->UserService->UserDao
	UserController(edit)->写出响应数据(操作成功|操作失败)->User.vue设置提示信息
	
	呈现原数据：利用用户编号查询真实的数据
(2)sql：
	修改：
        update 
            fin_admin_user
        set
            user_name=?,is_valid=?,role_id=?,reg_time=?,head_img=?
        where
            user_id=?
    查询原数据：
    	select user_id,user_name,user_pwd,is_valid,role_id,reg_time,head_img 
    	from fin_admin_user
    	where user_id=?
```



![image-20230306172850909](img/image-20230306172850909.png)

## 3.2 实现过程

### 3.2.1 后端

#### 3.2.1.1 entity

##### User

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: User
 * @description:
 * @date: 2023/2/28 18:08
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class User {
    //用户编号
    private Integer userId;
    //用户名称
    private String userName;
    //用户密码
    private String userPwd;
    //角色id 1管理员 2普通用户
    private Integer roleId;
    //注册时间
    private String regTime;
    //登录时间
    private String loginTime;
    //0在职 1休假 2离职
    private Integer isValid;
    //头像路径
    private String headImg;
    //版本编号
    private Integer versionId;

    public User(String userName, String userPwd) {
        this.userName = userName;
        this.userPwd = userPwd;
    }

    public User(Integer userId, String userName) {
        this.userId = userId;
        this.userName = userName;
    }

    public User(Integer userId, String userName, Integer roleId, String regTime, Integer isValid, String headImg) {
        this.userId = userId;
        this.userName = userName;
        this.roleId = roleId;
        this.regTime = regTime;
        this.isValid = isValid;
        this.headImg = headImg;
    }
}
```

#### 3.2.1.2 dao

##### UserDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.User;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDao
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserDao {

    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd) throws SQLException;

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId) throws SQLException;


    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号 用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException;


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user) throws SQLException;

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user) throws SQLException;

    /**
     * 根据用户编号查询用户数据
     *
     * @param userId 用户编号
     * @return 用户数据
     */
    User findByUid(Integer userId) throws SQLException;

    /**
     * 修改用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int editUser(User user) throws SQLException;
}
```

##### UserDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.entity.User;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanHandler;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ColumnListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDaoImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserDaoImpl implements UserDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public User findLoginUser(String userName, String userPwd) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd from fin_admin_user where user_name=? and user_pwd=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userName, userPwd);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_url " +
                "from fin_user_menu um,fin_admin_menu am " +
                "where um.menu_id=am.menu_id " +
                "and am.parent_id!=0 " +
                "and um.user_id=?";
        //将数据表中指定列的字段值，封装到一个list集合中
        ColumnListHandler<String> columnListHandler = new ColumnListHandler<>("menu_url");
        List<String> loginUserMenuUrl = runner.query(conn, sql, columnListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,reg_time,login_time,is_valid,head_img " +
                "from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        //分页查询  m=(page-1)*pageSize  n=pageSize
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        System.out.println("sql=" + sql);
        BeanListHandler<User> beanListHandler = new BeanListHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<User> userList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return userList;
    }

    @Override
    public long findTotalNum(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }

    @Override
    public int addUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "insert into fin_admin_user(user_name,user_pwd,is_valid,role_id,reg_time,head_img) values (?,'1234',?,?,?,?)";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public User findByUid(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd,is_valid,role_id,reg_time,head_img " +
                "from fin_admin_user " +
                "where user_id=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userId);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public int editUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "update " +
                "fin_admin_user " +
                "set " +
                "user_name=?,is_valid=?,role_id=?,reg_time=?,head_img=? " +
                "where " +
                "user_id=?";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg(), user.getUserId());
        DBUtils.getClose(conn, null, null);
        return rows;
    }
}
```

#### 3.2.1.3 service

##### UserService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.User;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserService
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserService {
    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd);

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId);

    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号和用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user);


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user);

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user);

    /**
     * 根据用户编号查询用户数据
     *
     * @param userId 用户编号
     * @return 用户数据
     */
    User findByUid(Integer userId);

    /**
     * 修改用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int editUser(User user);
}
```

##### UserServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.dao.impl.UserDaoImpl;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.UserService;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserServiceImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserServiceImpl implements UserService {
    UserDao userDao = new UserDaoImpl();

    @Override
    public User findLoginUser(String userName, String userPwd) {
        User user = null;
        try {
            user = userDao.findLoginUser(userName, userPwd);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) {
        List<String> loginUserMenuUrl = null;
        try {
            loginUserMenuUrl = userDao.findLoginUserMenuUrl(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }

        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) {
        List<User> userList = null;
        try {
            userList = userDao.findUser(page, pageSize, user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return userList;
    }

    @Override
    public long findTotalNum(User user) {
        long totalNum = 0;
        try {
            totalNum = userDao.findTotalNum(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }

    @Override
    public int addUser(User user) {
        int rows = 0;
        try {
            rows = userDao.addUser(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public User findByUid(Integer userId) {
        User user = null;
        try {
            user = userDao.findByUid(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public int editUser(User user) {
        int rows = 0;
        try {
            rows = userDao.editUser(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }
}
```

#### 3.2.1.4 controller

##### UserController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.PageInfo;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.UserService;
import com.javasm.finance.service.impl.UserServiceImpl;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: UserController
 * @description: 处理用户请求
 * @date: 2023/3/2 15:54
 * @since: 11
 */
@WebServlet("/user/*")
public class UserController extends BaseController {
    UserService userService = new UserServiceImpl();

    /**
     * 查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void query(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.query()");
        //接收请求数据
        //当前页
        String pageStr = req.getParameter("page");
        Integer page = 1;
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示的数据条数
        String pageSizeStr = req.getParameter("pageSize");
        Integer pageSize = 5;
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        User user = new User(userId, userName);
        //调用方法
        List<User> userList = userService.findUser(page, pageSize, user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (userList != null && userList.size() > 0) {
            //查询数据总条数
            long totalNum = userService.findTotalNum(user);
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("userList", userList);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(returnMap);
        } else {
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("pageInfo", new PageInfo(1, 5, 0l));
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 增加用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void add(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.add()");
        //接收请求数据
        //用户名称
        String userName = req.getParameter("userName");
        //人员状态
        String isValidStr = req.getParameter("isValid");
        Integer isValid = null;
        if (isValidStr != null && !"".equals(isValidStr)) {
            isValid = Integer.valueOf(isValidStr);
        }
        //人员角色
        String roleIdStr = req.getParameter("roleId");
        Integer roleId = null;
        if (roleIdStr != null && !"".equals(roleIdStr)) {
            roleId = Integer.valueOf(roleIdStr);
        }
        //注册时间
        String regTime = req.getParameter("regTime");
        //用户头像
        String headImg = req.getParameter("headImg");
        User user = new User(null, userName, roleId, regTime, isValid, headImg);
        //调用方法
        int rows = userService.addUser(user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 根据用户编号查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void toEdit(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.toEdit()");
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //查询用户数据
        User user = userService.findByUid(userId);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (user != null) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(user);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }


    /**
     * 修改用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void edit(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.edit()");
        //接收请求数据
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        //人员状态
        String isValidStr = req.getParameter("isValid");
        Integer isValid = null;
        if (isValidStr != null && !"".equals(isValidStr)) {
            isValid = Integer.valueOf(isValidStr);
        }
        //人员角色
        String roleIdStr = req.getParameter("roleId");
        Integer roleId = null;
        if (roleIdStr != null && !"".equals(roleIdStr)) {
            roleId = Integer.valueOf(roleIdStr);
        }
        //注册时间
        String regTime = req.getParameter("regTime");
        //用户头像
        String headImg = req.getParameter("headImg");
        User user = new User(userId, userName, roleId, regTime, isValid, headImg);
        //调用方法
        int rows = userService.editUser(user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

}
```

### 3.2.2 前端

#### 3.2.2.1 User.vue

```vue
<template>
  <div>
    <!-- 行内表单->条件查询 -->
    <el-form
      :inline="true"
      :model="queryForm"
      ref="queryForm"
      class="demo-form-inline"
    >
      <el-form-item label="用户编号" prop="userId">
        <el-input v-model="queryForm.userId" placeholder="用户编号"></el-input>
      </el-form-item>
      <el-form-item label="用户名称" prop="userName">
        <el-input
          v-model="queryForm.userName"
          placeholder="用户名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="executeQuery">查询</el-button>
        <el-button @click="resetForm('queryForm')">重置</el-button>
        <el-button type="success" @click="toAdd()">增加</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格->呈现用户数据 -->
    <el-table :data="userData" style="width: 100%">
      <el-table-column prop="userId" label="用户编号"> </el-table-column>
      <el-table-column prop="userName" label="用户名称">
        <template slot-scope="scope">
          <el-tag>{{ scope.row.userName }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="regTime" label="注册时间"> </el-table-column>
      <el-table-column prop="loginTime" label="最后登录时间"> </el-table-column>
      <el-table-column prop="isValid" label="人员状态">
        <!-- 0在职 1休假 2离职 -->
        <template slot-scope="scope">
          <span v-if="scope.row.isValid == 0">
            <el-tag type="success">在职</el-tag>
          </span>
          <span v-if="scope.row.isValid == 1">
            <el-tag type="warning">休假</el-tag>
          </span>
          <span v-if="scope.row.isValid == 2">
            <el-tag type="danger">离职</el-tag>
          </span>
        </template>
      </el-table-column>
      <el-table-column prop="headImg" label="用户头像"> </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button type="warning" @click="toEdit(scope.$index, scope.row)"
            >修改</el-button
          >
          <el-button
            type="danger"
            @click="handleDelete(scope.$index, scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[5, 10, 15, 20]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
    <!-- 增加对话框 -->
    <el-dialog title="增加" :visible.sync="addDialogFormVisible">
      <el-form :model="addForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="addForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="addForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" value="0"></el-option>
            <el-option label="休假" value="1"></el-option>
            <el-option label="离职" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="addForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" value="1"></el-option>
            <el-option label="普通用户" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="addForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <el-input
            v-model="addForm.headImg"
            autocomplete="off"
            placeholder="请输入用户头像"
          ></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="addDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeAdd()">确 定</el-button>
      </div>
    </el-dialog>
    <!-- 修改对话框 -->
    <el-dialog title="修改" :visible.sync="editDialogFormVisible">
      <el-form :model="editForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="editForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="editForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" :value="0"></el-option>
            <el-option label="休假" :value="1"></el-option>
            <el-option label="离职" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="editForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" :value="1"></el-option>
            <el-option label="普通用户" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="editForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <el-input
            v-model="editForm.headImg"
            autocomplete="off"
            placeholder="请输入用户头像"
          ></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="editDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeEdit()">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 用户数据 */
      userData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 2,
        totalNum: 30,
      },
      /* 条件查询 */
      queryForm: {
        userId: "",
        userName: "",
      },
      /* 增加 */
      addDialogFormVisible: false,
      addForm: {
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      /* 修改 */
      editDialogFormVisible: false,
      editForm: {
        userId: "",
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      formLabelWidth: "120px",
    };
  },
  methods: {
    /* 打开修改对话框 */
    toEdit(index, row) {
      console.log(index, row);
      this.editDialogFormVisible = true;
      //用户编号
      var reqData = "userId=" + row.userId;
      //查询要修改的数据
      this.queryUserByUid(reqData);
    },
    /* 查询要修改的数据 */
    queryUserByUid(reqData) {
      this.$axios
        .post("/user/toEdit", reqData)
        .then((resp) => {
          console.log(resp);
          this.editForm = resp.data.returnData;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 执行修改 */
    executeEdit() {
      this.editDialogFormVisible = false;
      var reqUrl = "/user/edit";
      var reqData = this.$qs.stringify(this.editForm);
      console.log(reqData);
      this.operateCUD(reqUrl, reqData);
    },
    /* 删除 */
    handleDelete(index, row) {
      console.log(index, row);
    },
    /* 打开增加对话框 */
    toAdd() {
      this.addDialogFormVisible = true;
      this.addForm = { userName: "", isValid: "", roleId: "", headImg: "" };
    },
    /* 执行增加 */
    executeAdd() {
      this.addDialogFormVisible = false;
      console.log(this.addForm.regTime);
      console.log(this.$qs.stringify(this.addForm));
      this.operateCUD("/user/add", this.$qs.stringify(this.addForm));
    },
    /* 公共函数-执行增加修改删除 */
    operateCUD(reqUrl, reqData) {
      this.$axios
        .post(reqUrl, reqData)
        .then((resp) => {
          console.log(resp);
          //设置提示信息
          if (resp.data.returnCode == 2002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "success",
            });
          } else if (resp.data.returnCode == 4002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "error",
            });
          }
          //重新查询用户数据
          var reqData =
            this.$qs.stringify(this.queryForm) +
            "&" +
            this.$qs.stringify(this.pageInfo);
          console.log(reqData);
          this.queryUser(reqData);
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 重置查询条件 */
    resetForm(queryForm) {
      this.$refs[queryForm].resetFields();
      //默认按照第一页数据查询
      this.queryUser("page=1&pageSize=5");
    },
    /* 条件查询 */
    executeQuery() {
      var reqData = this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换当前页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 公共查询函数 */
    queryUser(reqData) {
      this.$axios
        .post("/user/query", reqData)
        .then((resp) => {
          console.log(resp);
          this.userData = resp.data.returnData.userList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    /* 进入用户模块时 */
    this.queryUser("page=1&pageSize=5");
  },
};
</script>
<style>
</style>
```

# 4 用户-删除

## 4.1 需求分析

```sql
(1)流程：
	User.vue->点击删除按钮时->MessageBox 弹框->点击确定按钮时->向服务器端发请求执行删除
	->UserController(delete)->userService->UserDao
	
	UserController(delete)->写出响应数据->User.vue设置提示信息
(2)sql：
	删除用户数据：
		delete from fin_admin_user where user_id=?
	删除用户权限数据：
		select user_id,menu_id from fin_user_menu where user_id=?
		delete from fin_user_menu where user_id=?
```



![image-20230306172936412](img/image-20230306172936412.png)

## 4.2 实现过程

### 4.2.1 后端

#### 4.2.1.1 entity

##### User

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: User
 * @description:
 * @date: 2023/2/28 18:08
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class User {
    //用户编号
    private Integer userId;
    //用户名称
    private String userName;
    //用户密码
    private String userPwd;
    //角色id 1管理员 2普通用户
    private Integer roleId;
    //注册时间
    private String regTime;
    //登录时间
    private String loginTime;
    //0在职 1休假 2离职
    private Integer isValid;
    //头像路径
    private String headImg;
    //版本编号
    private Integer versionId;

    public User(String userName, String userPwd) {
        this.userName = userName;
        this.userPwd = userPwd;
    }

    public User(Integer userId, String userName) {
        this.userId = userId;
        this.userName = userName;
    }

    public User(Integer userId, String userName, Integer roleId, String regTime, Integer isValid, String headImg) {
        this.userId = userId;
        this.userName = userName;
        this.roleId = roleId;
        this.regTime = regTime;
        this.isValid = isValid;
        this.headImg = headImg;
    }
}
```

##### UserMenu

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: UserMenu
 * @description: 用户权限
 * @date: 2023/3/7 17:02
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class UserMenu {
    //用户编号
    private Integer userId;
    //权限编号
    private Integer menuId;
}
```

#### 4.2.1.2 dao

##### UserDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDao
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserDao {

    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd) throws SQLException;

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId) throws SQLException;


    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号 用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException;


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user) throws SQLException;

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user) throws SQLException;

    /**
     * 根据用户编号查询用户数据
     *
     * @param userId 用户编号
     * @return 用户数据
     */
    User findByUid(Integer userId) throws SQLException;

    /**
     * 修改用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int editUser(User user) throws SQLException;

    /**
     * 删除用户数据
     *
     * @param userId 用户编号
     * @param conn   数据库连接
     * @return 成功影响的记录数
     */
    int deleteUser(Integer userId, Connection conn) throws SQLException;

    /**
     * 查询用户权限数据
     *
     * @param userId 用户编号
     * @return 用户权限数据
     */
    List<UserMenu> findUserMenu(Integer userId) throws SQLException;

    /**
     * 删除用户权限数据
     *
     * @param userId 用户编号
     * @param conn   数据库连接
     * @return 成功影响的记录数
     */
    int deleteUserMenu(Integer userId, Connection conn) throws SQLException;
}
```

##### UserDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanHandler;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ColumnListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDaoImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserDaoImpl implements UserDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public User findLoginUser(String userName, String userPwd) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd from fin_admin_user where user_name=? and user_pwd=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userName, userPwd);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_url " +
                "from fin_user_menu um,fin_admin_menu am " +
                "where um.menu_id=am.menu_id " +
                "and am.parent_id!=0 " +
                "and um.user_id=?";
        //将数据表中指定列的字段值，封装到一个list集合中
        ColumnListHandler<String> columnListHandler = new ColumnListHandler<>("menu_url");
        List<String> loginUserMenuUrl = runner.query(conn, sql, columnListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,reg_time,login_time,is_valid,head_img " +
                "from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        //分页查询  m=(page-1)*pageSize  n=pageSize
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        System.out.println("sql=" + sql);
        BeanListHandler<User> beanListHandler = new BeanListHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<User> userList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return userList;
    }

    @Override
    public long findTotalNum(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }

    @Override
    public int addUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "insert into fin_admin_user(user_name,user_pwd,is_valid,role_id,reg_time,head_img) values (?,'1234',?,?,?,?)";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public User findByUid(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd,is_valid,role_id,reg_time,head_img " +
                "from fin_admin_user " +
                "where user_id=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userId);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public int editUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "update " +
                "fin_admin_user " +
                "set " +
                "user_name=?,is_valid=?,role_id=?,reg_time=?,head_img=? " +
                "where " +
                "user_id=?";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg(), user.getUserId());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public int deleteUser(Integer userId, Connection conn) throws SQLException {
        String sql = "delete from fin_admin_user where user_id=?";
        int rows = runner.update(conn, sql, userId);
        return rows;
    }

    @Override
    public List<UserMenu> findUserMenu(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,menu_id from fin_user_menu where user_id=?";
        BeanListHandler<UserMenu> beanListHandler = new BeanListHandler<>(UserMenu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<UserMenu> userMenuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return userMenuList;
    }

    @Override
    public int deleteUserMenu(Integer userId, Connection conn) throws SQLException {
        String sql = "delete from fin_user_menu where user_id=?";
        int rows = runner.update(conn, sql, userId);
        return rows;
    }

}
```

#### 4.2.1.3 service

##### UserService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.User;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserService
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserService {
    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd);

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId);

    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号和用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user);


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user);

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user);

    /**
     * 根据用户编号查询用户数据
     *
     * @param userId 用户编号
     * @return 用户数据
     */
    User findByUid(Integer userId);

    /**
     * 修改用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int editUser(User user);

    /**
     * 删除用户数据
     *
     * @param userId 用户编号
     * @return 是否删除成功
     */
    boolean deleteUser(Integer userId);

}
```

##### UserServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.dao.impl.UserDaoImpl;
import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;
import com.javasm.finance.service.UserService;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.DbUtils;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserServiceImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserServiceImpl implements UserService {
    UserDao userDao = new UserDaoImpl();

    @Override
    public User findLoginUser(String userName, String userPwd) {
        User user = null;
        try {
            user = userDao.findLoginUser(userName, userPwd);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) {
        List<String> loginUserMenuUrl = null;
        try {
            loginUserMenuUrl = userDao.findLoginUserMenuUrl(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }

        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) {
        List<User> userList = null;
        try {
            userList = userDao.findUser(page, pageSize, user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return userList;
    }

    @Override
    public long findTotalNum(User user) {
        long totalNum = 0;
        try {
            totalNum = userDao.findTotalNum(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }

    @Override
    public int addUser(User user) {
        int rows = 0;
        try {
            rows = userDao.addUser(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public User findByUid(Integer userId) {
        User user = null;
        try {
            user = userDao.findByUid(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public int editUser(User user) {
        int rows = 0;
        try {
            rows = userDao.editUser(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public boolean deleteUser(Integer userId) {
        boolean isSuccess = false;
        Connection conn = DBUtils.getConn();
        try {
            //关闭事务自动提交
            conn.setAutoCommit(false);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }

        try {
            //删除用户数据
            userDao.deleteUser(userId, conn);
            //若存在用户权限数据，则直接删除
            List<UserMenu> userMenuList = userDao.findUserMenu(userId);
            if (userMenuList != null && userMenuList.size() > 0) {
                userDao.deleteUserMenu(userId, conn);
            }
            //提交事务
            DbUtils.commitAndCloseQuietly(conn);
            isSuccess = true;
        } catch (SQLException throwables) {
            //throwables.printStackTrace();
            DbUtils.rollbackAndCloseQuietly(conn);
        }
        return isSuccess;
    }

}
```

#### 4.2.1.4 controller

##### UserController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.PageInfo;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.UserService;
import com.javasm.finance.service.impl.UserServiceImpl;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: UserController
 * @description: 处理用户请求
 * @date: 2023/3/2 15:54
 * @since: 11
 */
@WebServlet("/user/*")
public class UserController extends BaseController {
    UserService userService = new UserServiceImpl();

    /**
     * 查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void query(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.query()");
        //接收请求数据
        //当前页
        String pageStr = req.getParameter("page");
        Integer page = 1;
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示的数据条数
        String pageSizeStr = req.getParameter("pageSize");
        Integer pageSize = 5;
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        User user = new User(userId, userName);
        //调用方法
        List<User> userList = userService.findUser(page, pageSize, user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (userList != null && userList.size() > 0) {
            //查询数据总条数
            long totalNum = userService.findTotalNum(user);
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("userList", userList);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(returnMap);
        } else {
            //创建Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("pageInfo", new PageInfo(1, 5, 0l));
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 增加用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void add(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.add()");
        //接收请求数据
        //用户名称
        String userName = req.getParameter("userName");
        //人员状态
        String isValidStr = req.getParameter("isValid");
        Integer isValid = null;
        if (isValidStr != null && !"".equals(isValidStr)) {
            isValid = Integer.valueOf(isValidStr);
        }
        //人员角色
        String roleIdStr = req.getParameter("roleId");
        Integer roleId = null;
        if (roleIdStr != null && !"".equals(roleIdStr)) {
            roleId = Integer.valueOf(roleIdStr);
        }
        //注册时间
        String regTime = req.getParameter("regTime");
        //用户头像
        String headImg = req.getParameter("headImg");
        User user = new User(null, userName, roleId, regTime, isValid, headImg);
        //调用方法
        int rows = userService.addUser(user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 根据用户编号查询用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void toEdit(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.toEdit()");
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //查询用户数据
        User user = userService.findByUid(userId);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (user != null) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(user);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }


    /**
     * 修改用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void edit(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.edit()");
        //接收请求数据
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //用户名称
        String userName = req.getParameter("userName");
        //人员状态
        String isValidStr = req.getParameter("isValid");
        Integer isValid = null;
        if (isValidStr != null && !"".equals(isValidStr)) {
            isValid = Integer.valueOf(isValidStr);
        }
        //人员角色
        String roleIdStr = req.getParameter("roleId");
        Integer roleId = null;
        if (roleIdStr != null && !"".equals(roleIdStr)) {
            roleId = Integer.valueOf(roleIdStr);
        }
        //注册时间
        String regTime = req.getParameter("regTime");
        //用户头像
        String headImg = req.getParameter("headImg");
        User user = new User(userId, userName, roleId, regTime, isValid, headImg);
        //调用方法
        int rows = userService.editUser(user);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (rows > 0) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }

    /**
     * 删除用户数据
     *
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    public void delete(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("执行UserController.delete()");
        //接收请求数据
        //用户编号
        String userIdStr = req.getParameter("userId");
        Integer userId = null;
        if (userIdStr != null && !"".equals(userIdStr)) {
            userId = Integer.valueOf(userIdStr);
        }
        //调用方法
        boolean isSuccess = userService.deleteUser(userId);
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        if (isSuccess) {
            re.setReturnCode(CodeAndMsg.OPERATE_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.OPERATE_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.OPERATE_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

### 4.2.2 前端

#### 4.2.2.1 User.vue

```vue
<template>
  <div>
    <!-- 行内表单->条件查询 -->
    <el-form
      :inline="true"
      :model="queryForm"
      ref="queryForm"
      class="demo-form-inline"
    >
      <el-form-item label="用户编号" prop="userId">
        <el-input v-model="queryForm.userId" placeholder="用户编号"></el-input>
      </el-form-item>
      <el-form-item label="用户名称" prop="userName">
        <el-input
          v-model="queryForm.userName"
          placeholder="用户名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="executeQuery">查询</el-button>
        <el-button @click="resetForm('queryForm')">重置</el-button>
        <el-button type="success" @click="toAdd()">增加</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格->呈现用户数据 -->
    <el-table :data="userData" style="width: 100%">
      <el-table-column prop="userId" label="用户编号"> </el-table-column>
      <el-table-column prop="userName" label="用户名称">
        <template slot-scope="scope">
          <el-tag>{{ scope.row.userName }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="regTime" label="注册时间"> </el-table-column>
      <el-table-column prop="loginTime" label="最后登录时间"> </el-table-column>
      <el-table-column prop="isValid" label="人员状态">
        <!-- 0在职 1休假 2离职 -->
        <template slot-scope="scope">
          <span v-if="scope.row.isValid == 0">
            <el-tag type="success">在职</el-tag>
          </span>
          <span v-if="scope.row.isValid == 1">
            <el-tag type="warning">休假</el-tag>
          </span>
          <span v-if="scope.row.isValid == 2">
            <el-tag type="danger">离职</el-tag>
          </span>
        </template>
      </el-table-column>
      <el-table-column prop="headImg" label="用户头像"> </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button type="warning" @click="toEdit(scope.$index, scope.row)"
            >修改</el-button
          >
          <el-button
            type="danger"
            @click="executeDelete(scope.$index, scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[5, 10, 15, 20]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
    <!-- 增加对话框 -->
    <el-dialog title="增加" :visible.sync="addDialogFormVisible">
      <el-form :model="addForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="addForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="addForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" value="0"></el-option>
            <el-option label="休假" value="1"></el-option>
            <el-option label="离职" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="addForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" value="1"></el-option>
            <el-option label="普通用户" value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="addForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <el-input
            v-model="addForm.headImg"
            autocomplete="off"
            placeholder="请输入用户头像"
          ></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="addDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeAdd()">确 定</el-button>
      </div>
    </el-dialog>
    <!-- 修改对话框 -->
    <el-dialog title="修改" :visible.sync="editDialogFormVisible">
      <el-form :model="editForm">
        <el-form-item label="用户名称" :label-width="formLabelWidth">
          <el-input
            v-model="editForm.userName"
            autocomplete="off"
            placeholder="请输入用户名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="人员状态" :label-width="formLabelWidth">
          <el-select v-model="editForm.isValid" placeholder="请选择人员状态">
            <!-- 0在职 1休假 2离职 -->
            <el-option label="在职" :value="0"></el-option>
            <el-option label="休假" :value="1"></el-option>
            <el-option label="离职" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="人员角色" :label-width="formLabelWidth">
          <el-select v-model="editForm.roleId" placeholder="请选择人员角色">
            <!-- 角色id 1管理员 2普通用户 -->
            <el-option label="管理员" :value="1"></el-option>
            <el-option label="普通用户" :value="2"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="注册时间" :label-width="formLabelWidth">
          <!-- 
              format	显示在输入框中的格式，默认是yyyy-MM-dd HH:mm:ss
              value-format	可选，绑定值的格式。不指定则绑定值为 Date 对象
           -->
          <el-date-picker
            v-model="editForm.regTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择日期时间"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="用户头像" :label-width="formLabelWidth">
          <el-input
            v-model="editForm.headImg"
            autocomplete="off"
            placeholder="请输入用户头像"
          ></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="editDialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="executeEdit()">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 用户数据 */
      userData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 2,
        totalNum: 30,
      },
      /* 条件查询 */
      queryForm: {
        userId: "",
        userName: "",
      },
      /* 增加 */
      addDialogFormVisible: false,
      addForm: {
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      /* 修改 */
      editDialogFormVisible: false,
      editForm: {
        userId: "",
        userName: "",
        isValid: "",
        roleId: "",
        regTime: "",
        headImg: "",
      },
      formLabelWidth: "120px",
    };
  },
  methods: {
    /* 执行删除 */
    executeDelete(index, row) {
      console.log(index, row);
      this.$confirm("此操作将永久删除该数据, 是否继续?", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning",
      })
        .then(() => {
          //执行删除
          var reqUrl = "/user/delete";
          var reqData = "userId=" + row.userId;
          this.operateCUD(reqUrl, reqData);
        })
        .catch(() => {
          this.$message({
            type: "info",
            message: "已取消删除",
          });
        });
    },
    /* 打开修改对话框 */
    toEdit(index, row) {
      console.log(index, row);
      this.editDialogFormVisible = true;
      //用户编号
      var reqData = "userId=" + row.userId;
      //查询要修改的数据
      this.queryUserByUid(reqData);
    },
    /* 查询要修改的数据 */
    queryUserByUid(reqData) {
      this.$axios
        .post("/user/toEdit", reqData)
        .then((resp) => {
          console.log(resp);
          this.editForm = resp.data.returnData;
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 执行修改 */
    executeEdit() {
      this.editDialogFormVisible = false;
      var reqUrl = "/user/edit";
      var reqData = this.$qs.stringify(this.editForm);
      console.log(reqData);
      this.operateCUD(reqUrl, reqData);
    },
    /* 打开增加对话框 */
    toAdd() {
      this.addDialogFormVisible = true;
      this.addForm = { userName: "", isValid: "", roleId: "", headImg: "" };
    },
    /* 执行增加 */
    executeAdd() {
      this.addDialogFormVisible = false;
      console.log(this.addForm.regTime);
      console.log(this.$qs.stringify(this.addForm));
      this.operateCUD("/user/add", this.$qs.stringify(this.addForm));
    },
    /* 公共函数-执行增加修改删除 */
    operateCUD(reqUrl, reqData) {
      this.$axios
        .post(reqUrl, reqData)
        .then((resp) => {
          console.log(resp);
          //设置提示信息
          if (resp.data.returnCode == 2002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "success",
            });
          } else if (resp.data.returnCode == 4002) {
            this.$message({
              showClose: true,
              message: resp.data.returnMsg,
              type: "error",
            });
          }
          //重新查询用户数据
          this.pageInfo.page = 1;
          this.pageInfo.pageSize = 5;
          var reqData =
            this.$qs.stringify(this.queryForm) +
            "&" +
            this.$qs.stringify(this.pageInfo);
          console.log(reqData);
          this.queryUser(reqData);
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 重置查询条件 */
    resetForm(queryForm) {
      this.$refs[queryForm].resetFields();
      //默认按照第一页数据查询
      this.queryUser("page=1&pageSize=5");
    },
    /* 条件查询 */
    executeQuery() {
      var reqData = this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 切换当前页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData =
        this.$qs.stringify(this.pageInfo) +
        "&" +
        this.$qs.stringify(this.queryForm);
      console.log(reqData);
      this.queryUser(reqData);
    },
    /* 公共查询函数 */
    queryUser(reqData) {
      this.$axios
        .post("/user/query", reqData)
        .then((resp) => {
          console.log(resp);
          this.userData = resp.data.returnData.userList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    /* 进入用户模块时 */
    this.queryUser("page=1&pageSize=5");
  },
};
</script>
<style>
/* 设置对话框上的日期组件样式 */
div > .el-date-editor.el-input {
  width: 100%;
}
</style>
```

# 5 设置登录用户名称

## 5.1 需求分析

```
根据具体的登录用户数据->设置系统主界面显示的用户名称
```

## 5.2 实现过程

### 5.2.1 后端

#### 5.2.1.1 controller

##### MainController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.entity.User;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: MainController
 * @description:
 * @date: 2023/3/1 11:44
 * @since: 11
 */
@WebServlet("/main")
public class MainController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //从session对象上获取登录用户的权限数据
        HttpSession session = req.getSession();
        System.out.println("MainController.sessionId=" + session.getId());
        List<Menu> menuList = (List<Menu>) session.getAttribute("menuList");
        //写出响应数据
        ReturnEntity re = new ReturnEntity();
        if (menuList != null && menuList.size() > 0) {
            //查询登录用户名称
            User user = (User) session.getAttribute("user");
            String loginUserName = user.getUserName();
            //设置Map集合
            Map<String, Object> returnMap = new HashMap<>();
            returnMap.put("menuList", menuList);
            returnMap.put("loginUserName", loginUserName);
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            //包含：登录用户权限数据  登录用户名称
            re.setReturnData(returnMap);
        } else {
            re.setReturnCode(CodeAndMsg.NO_LOGIN.getReturnCode());
            re.setReturnMsg(CodeAndMsg.NO_LOGIN.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

### 5.2.2 前端

#### 5.2.2.1 Main.vue

```vue
<template>
  <!-- 内容需要被一个根标签包含 -->
  <!-- Container 布局容器 -->
  <el-container>
    <el-header style="height: 100px; padding: 0; line-height: 100px">
      <img style="float: left" src="../assets/logo2.jpg" alt="" />
      <el-row type="flex" justify="end">
        <el-col :span="18" style="font-size: 25px; font-weight: 600"
          >尚马金融MIS管理系统</el-col
        >
        <el-col :span="6">
          <!-- 按钮组 -->
          <el-button-group>
            <!-- 登录用户名称 -->
            <el-button type="primary">{{ loginUserName }}</el-button>
            <!-- 呈现图表->echarts -->
            <el-button type="primary" icon="el-icon-s-data"></el-button>
            <!-- 设置->修改密码 -->
            <el-button type="primary" icon="el-icon-setting"></el-button>
            <!-- 用户登出操作 -->
            <el-button
              type="primary"
              icon="el-icon-switch-button"
             
            ></el-button>
          </el-button-group>
        </el-col>
      </el-row>
    </el-header>
    <el-container style="overflow-y: hidden">
      <!-- 200->299 -->
      <el-aside width="299px">
        <!-- 
          NavMenu 导航菜单->侧栏：
            router	
              是否使用 vue-router 的模式
              启用该模式会在激活导航时以 index 作为 path 进行路由跳转
        -->
        <el-row class="tac">
          <!-- 24分栏 -->
          <el-col :span="24">
            <el-menu
              router
              default-active="2"
              class="el-menu-vertical-demo"
              @open="handleOpen"
              @close="handleClose"
            >
              <!-- menuData：所有的一级菜单数据 -->
              <el-submenu
                :key="menu.menuId"
                :index="menu.menuId.toString()"
                v-for="menu in menuData"
              >
                <template slot="title">
                  <!-- icon：图标 -->
                  <i :class="menu.glyphicon"></i>
                  <span>{{ menu.menuName }}</span>
                </template>
                <el-menu-item-group>
                  <!-- 呈现二级菜单数据 -->
                  <el-menu-item
                    :key="subMenu.menuId"
                    :index="subMenu.menuUrl"
                    v-for="subMenu in menu.subMenu"
                  >
                    {{ subMenu.menuName }}</el-menu-item
                  >
                </el-menu-item-group>
              </el-submenu>
            </el-menu>
          </el-col>
        </el-row>
      </el-aside>
      <el-main>
        <!-- 子路由 -->
        <router-view></router-view>
      </el-main>
    </el-container>
  </el-container>
</template>
<script>
/* import axios from "axios";
import qs from "qs"; */

export default {
  data() {
    return {
      /* 侧栏数据 */
      menuData: [],
      /* 登录用户名称 */
      loginUserName: "",
    };
  },
  methods: {
    handleOpen(key, keyPath) {
      console.log(key, keyPath);
    },
    handleClose(key, keyPath) {
      console.log(key, keyPath);
    },
    /* 查询用户权限数据和用户名称 */
    queryLoginUserData() {
      /* 获取侧栏数据 */
      this.$axios
        .post("/main", "")
        .then((resp) => {
          console.log(resp);
          if (resp.data.returnCode == 2001) {
            //呈现侧栏数据
            this.menuData = resp.data.returnData.menuList;
            //呈现登录用户名称
            this.loginUserName = resp.data.returnData.loginUserName;
          }
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    this.queryLoginUserData();
  },
};
</script>
<style>
/* 自增样式 */
/* 去除外边距 */
* {
  margin: 0;
  /* padding: 0; */
}

/* 设置页面高度 */
html,
body,
.el-container {
  height: 100%;
}

/* Container 布局容器 */
.el-header,
.el-footer {
  background-color: #b3c0d1;
  color: #333;
  text-align: center;
  line-height: 60px;
}

.el-aside {
  background-color: #d3dce6;
  color: #333;
  text-align: center;
  line-height: 200px;
}

.el-main {
  background-color: #e9eef3;
  color: #333;
  text-align: center;
  line-height: 160px;
}

body > .el-container {
  margin-bottom: 40px;
}

.el-container:nth-child(5) .el-aside,
.el-container:nth-child(6) .el-aside {
  line-height: 260px;
}

.el-container:nth-child(7) .el-aside {
  line-height: 320px;
}
</style>
```

# 6 用户登出操作

## 6.1 需求分析

```
点击退出按钮->移除session对象数据->退出到登录界面
```

## 6.2 实现过程

### 6.2.1 后端

#### 6.2.1.1 entity

##### CodeAndMsg

```java
package com.javasm.finance.entity;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * @author: ShangMa
 * @className: CodeAndMsg
 * @description:
 * @date: 2023/3/1 10:14
 * @since: 11
 */
@AllArgsConstructor
@Getter
public enum CodeAndMsg {
    LOGIN_SUCCESS(2000, "登录成功"),
    LOGIN_FAILURED(4000, "登录失败"),
    QUERY_SUCCESS(2001, "成功查询到数据"),
    QUERY_FAILURED(4001, "没有查询到数据"),
    OPERATE_SUCCESS(2002, "操作成功"),
    OPERATE_FAILURED(4002, "操作失败"),
    NO_LOGIN(4005, "没有登录"),
    NO_AUTH(4006,"没有权限"),
    LOGOUT_SUCCESS(4007,"登出成功");

    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
}
```

#### 6.2.1.2 controller

##### LogoutController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;

/**
 * @author: ShangMa
 * @className: LogoutController
 * @description: 处理用户登出请求
 * @date: 2023/3/7 17:39
 * @since: 11
 */
@WebServlet("/logout")
public class LogoutController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //移除session对象值
        HttpSession session = req.getSession();
        session.removeAttribute("user");
        session.removeAttribute("loginUserMenuUrl");
        session.removeAttribute("menuList");
        //设置响应数据
        ReturnEntity re = new ReturnEntity();
        re.setReturnCode(CodeAndMsg.LOGOUT_SUCCESS.getReturnCode());
        re.setReturnMsg(CodeAndMsg.LOGOUT_SUCCESS.getReturnMsg());
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

#### 6.2.1.3 filter

##### CFilter

```java
package com.javasm.finance.filter;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.util.RespUtils;

import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: CFilter
 * @description: 权限访问控制过滤器
 * @date: 2023/3/6 16:27
 * @since: 11
 */
@WebFilter("/*")
public class CFilter implements Filter {
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {

    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest req = (HttpServletRequest) servletRequest;
        HttpServletResponse resp = (HttpServletResponse) servletResponse;
        //接收请求路径
        String servletPath = req.getServletPath();
        //获取用户权限访问地址
        HttpSession session = req.getSession();
        List<String> loginUserMenuUrl = (List<String>) session.getAttribute("loginUserMenuUrl");
        //判断
        if ("/login".equals(servletPath) || "/main".equals(servletPath)
                || "/logout".equals(servletPath)) {//白名单
            //登录->放行
            filterChain.doFilter(servletRequest, servletResponse);
        } else {
            //不是登录->判断有无权限
            if (loginUserMenuUrl.contains(servletPath)) {
                //有权限
                filterChain.doFilter(servletRequest, servletResponse);
            } else {
                //无权限
                ReturnEntity re = new ReturnEntity();
                re.setReturnCode(CodeAndMsg.NO_AUTH.getReturnCode());
                re.setReturnMsg(CodeAndMsg.NO_AUTH.getReturnMsg());
                RespUtils.handleResp(resp, re);
            }
        }
    }

    @Override
    public void destroy() {

    }
}
```

### 6.2.2 前端

#### 6.2.2.1 Main.vue

```vue
<template>
  <!-- 内容需要被一个根标签包含 -->
  <!-- Container 布局容器 -->
  <el-container>
    <el-header style="height: 100px; padding: 0; line-height: 100px">
      <img style="float: left" src="../assets/logo2.jpg" alt="" />
      <el-row type="flex" justify="end">
        <el-col :span="18" style="font-size: 25px; font-weight: 600"
          >尚马金融MIS管理系统</el-col
        >
        <el-col :span="6">
          <!-- 按钮组 -->
          <el-button-group>
            <!-- 登录用户名称 -->
            <el-button type="primary">{{ loginUserName }}</el-button>
            <!-- 呈现图表->echarts -->
            <el-button type="primary" icon="el-icon-s-data"></el-button>
            <!-- 设置->修改密码 -->
            <el-button type="primary" icon="el-icon-setting"></el-button>
            <!-- 用户登出操作 -->
            <el-button
              type="primary"
              icon="el-icon-switch-button"
              @click="logout()"
            ></el-button>
          </el-button-group>
        </el-col>
      </el-row>
    </el-header>
    <el-container style="overflow-y: hidden">
      <!-- 200->299 -->
      <el-aside width="299px">
        <!-- 
          NavMenu 导航菜单->侧栏：
            router	
              是否使用 vue-router 的模式
              启用该模式会在激活导航时以 index 作为 path 进行路由跳转
        -->
        <el-row class="tac">
          <!-- 24分栏 -->
          <el-col :span="24">
            <el-menu
              router
              default-active="2"
              class="el-menu-vertical-demo"
              @open="handleOpen"
              @close="handleClose"
            >
              <!-- menuData：所有的一级菜单数据 -->
              <el-submenu
                :key="menu.menuId"
                :index="menu.menuId.toString()"
                v-for="menu in menuData"
              >
                <template slot="title">
                  <!-- icon：图标 -->
                  <i :class="menu.glyphicon"></i>
                  <span>{{ menu.menuName }}</span>
                </template>
                <el-menu-item-group>
                  <!-- 呈现二级菜单数据 -->
                  <el-menu-item
                    :key="subMenu.menuId"
                    :index="subMenu.menuUrl"
                    v-for="subMenu in menu.subMenu"
                  >
                    {{ subMenu.menuName }}</el-menu-item
                  >
                </el-menu-item-group>
              </el-submenu>
            </el-menu>
          </el-col>
        </el-row>
      </el-aside>
      <el-main>
        <!-- 子路由 -->
        <router-view></router-view>
      </el-main>
    </el-container>
  </el-container>
</template>
<script>
/* import axios from "axios";
import qs from "qs"; */

export default {
  data() {
    return {
      /* 侧栏数据 */
      menuData: [],
      /* 登录用户名称 */
      loginUserName: "",
    };
  },
  methods: {
    handleOpen(key, keyPath) {
      console.log(key, keyPath);
    },
    handleClose(key, keyPath) {
      console.log(key, keyPath);
    },
    /* 查询用户权限数据和用户名称 */
    queryLoginUserData() {
      /* 获取侧栏数据 */
      this.$axios
        .post("/main", "")
        .then((resp) => {
          console.log(resp);
          if (resp.data.returnCode == 2001) {
            //呈现侧栏数据
            this.menuData = resp.data.returnData.menuList;
            //呈现登录用户名称
            this.loginUserName = resp.data.returnData.loginUserName;
          }
        })
        .catch((error) => {
          console.log(error);
        });
    },
    /* 用户登出 */
    logout() {
      this.$axios
        .post("/logout", "")
        .then((resp) => {
          console.log(resp);
          if (resp.data.returnCode == 4007) {
            //退出到登录
            this.$router.push("/");
          }
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    this.queryLoginUserData();
  },
};
</script>
<style>
/* 自增样式 */
/* 去除外边距 */
* {
  margin: 0;
  /* padding: 0; */
}

/* 设置页面高度 */
html,
body,
.el-container {
  height: 100%;
}

/* Container 布局容器 */
.el-header,
.el-footer {
  background-color: #b3c0d1;
  color: #333;
  text-align: center;
  line-height: 60px;
}

.el-aside {
  background-color: #d3dce6;
  color: #333;
  text-align: center;
  line-height: 200px;
}

.el-main {
  background-color: #e9eef3;
  color: #333;
  text-align: center;
  line-height: 160px;
}

body > .el-container {
  margin-bottom: 40px;
}

.el-container:nth-child(5) .el-aside,
.el-container:nth-child(6) .el-aside {
  line-height: 260px;
}

.el-container:nth-child(7) .el-aside {
  line-height: 320px;
}
</style>
```

## 7 设置用户登录时间

## 7.1 需求分析

```
根据用户登录操作->设置最新的登录时间
```

## 7.2 实现过程

### 7.2.1 后端

#### 7.2.1.1 dao

##### UserDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDao
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserDao {

    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd) throws SQLException;

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId) throws SQLException;


    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号 用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException;


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user) throws SQLException;

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user) throws SQLException;

    /**
     * 根据用户编号查询用户数据
     *
     * @param userId 用户编号
     * @return 用户数据
     */
    User findByUid(Integer userId) throws SQLException;

    /**
     * 修改用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int editUser(User user) throws SQLException;

    /**
     * 删除用户数据
     *
     * @param userId 用户编号
     * @param conn   数据库连接
     * @return 成功影响的记录数
     */
    int deleteUser(Integer userId, Connection conn) throws SQLException;

    /**
     * 查询用户权限数据
     *
     * @param userId 用户编号
     * @return 用户权限数据
     */
    List<UserMenu> findUserMenu(Integer userId) throws SQLException;

    /**
     * 删除用户权限数据
     *
     * @param userId 用户编号
     * @param conn   数据库连接
     * @return 成功影响的记录数
     */
    int deleteUserMenu(Integer userId, Connection conn) throws SQLException;

    /**
     * 设置用户登录时间
     * @param userId 用户编号
     * @return 成功影响的记录数
     */
    int editLoginTime(Integer userId) throws SQLException;


}
```

##### UserDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanHandler;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ColumnListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserDaoImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserDaoImpl implements UserDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public User findLoginUser(String userName, String userPwd) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd from fin_admin_user where user_name=? and user_pwd=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userName, userPwd);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_url " +
                "from fin_user_menu um,fin_admin_menu am " +
                "where um.menu_id=am.menu_id " +
                "and am.parent_id!=0 " +
                "and um.user_id=?";
        //将数据表中指定列的字段值，封装到一个list集合中
        ColumnListHandler<String> columnListHandler = new ColumnListHandler<>("menu_url");
        List<String> loginUserMenuUrl = runner.query(conn, sql, columnListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,reg_time,login_time,is_valid,head_img " +
                "from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        //分页查询  m=(page-1)*pageSize  n=pageSize
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        System.out.println("sql=" + sql);
        BeanListHandler<User> beanListHandler = new BeanListHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<User> userList = runner.query(conn, sql, beanListHandler, paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return userList;
    }

    @Override
    public long findTotalNum(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_user ";
        //SQL连接词
        boolean isWhere = true;
        //条件  ?
        List paramList = new ArrayList();
        //用户编号
        if (user.getUserId() != null && !"".equals(user.getUserId())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_id=? ";
            paramList.add(user.getUserId());
        }
        //用户名称
        if (user.getUserName() != null && !"".equals(user.getUserName())) {
            if (isWhere) {
                sql += "where ";
                isWhere = false;
            } else {
                sql += "and ";
            }
            sql += "user_name like ? ";
            paramList.add("%" + user.getUserName() + "%");
        }
        long totalNum = runner.query(conn, sql, new ScalarHandler<>(), paramList.toArray());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }

    @Override
    public int addUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "insert into fin_admin_user(user_name,user_pwd,is_valid,role_id,reg_time,head_img) values (?,'1234',?,?,?,?)";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public User findByUid(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd,is_valid,role_id,reg_time,head_img " +
                "from fin_admin_user " +
                "where user_id=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userId);
        DBUtils.getClose(conn, null, null);
        return user;
    }

    @Override
    public int editUser(User user) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "update " +
                "fin_admin_user " +
                "set " +
                "user_name=?,is_valid=?,role_id=?,reg_time=?,head_img=? " +
                "where " +
                "user_id=?";
        int rows = runner.update(conn, sql, user.getUserName(), user.getIsValid(), user.getRoleId(), user.getRegTime(), user.getHeadImg(), user.getUserId());
        DBUtils.getClose(conn, null, null);
        return rows;
    }

    @Override
    public int deleteUser(Integer userId, Connection conn) throws SQLException {
        String sql = "delete from fin_admin_user where user_id=?";
        int rows = runner.update(conn, sql, userId);
        return rows;
    }

    @Override
    public List<UserMenu> findUserMenu(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,menu_id from fin_user_menu where user_id=?";
        BeanListHandler<UserMenu> beanListHandler = new BeanListHandler<>(UserMenu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<UserMenu> userMenuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return userMenuList;
    }

    @Override
    public int deleteUserMenu(Integer userId, Connection conn) throws SQLException {
        String sql = "delete from fin_user_menu where user_id=?";
        int rows = runner.update(conn, sql, userId);
        return rows;
    }

    @Override
    public int editLoginTime(Integer userId) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "update fin_admin_user set login_time=now() where user_id=?";
        int rows = runner.update(conn, sql, userId);
        DBUtils.getClose(conn, null, null);
        return rows;
    }
}
```

#### 7.2.1.2 service

##### UserService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.User;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserService
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserService {
    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd);

    /**
     * 根据登录用户编号查询二级权限访问地址
     *
     * @param userId 用户编号
     * @return 二级权限访问地址
     */
    List<String> findLoginUserMenuUrl(Integer userId);

    /**
     * 根据指定条件查询用户数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @param user     用户编号和用户名称
     * @return 用户数据
     */
    List<User> findUser(Integer page, Integer pageSize, User user);


    /**
     * 根据指定条件查询用户数据总条数
     *
     * @param user 用户编号 用户名称
     * @return 用户数据总条数
     */
    long findTotalNum(User user);

    /**
     * 增加用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int addUser(User user);

    /**
     * 根据用户编号查询用户数据
     *
     * @param userId 用户编号
     * @return 用户数据
     */
    User findByUid(Integer userId);

    /**
     * 修改用户数据
     *
     * @param user 用户数据
     * @return 成功影响的记录数
     */
    int editUser(User user);

    /**
     * 删除用户数据
     *
     * @param userId 用户编号
     * @return 是否删除成功
     */
    boolean deleteUser(Integer userId);

    /**
     * 设置用户登录时间
     * @param userId 用户编号
     * @return 成功影响的记录数
     */
    int editLoginTime(Integer userId);
}
```

##### UserServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.dao.impl.UserDaoImpl;
import com.javasm.finance.entity.User;
import com.javasm.finance.entity.UserMenu;
import com.javasm.finance.service.UserService;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.DbUtils;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: UserServiceImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserServiceImpl implements UserService {
    UserDao userDao = new UserDaoImpl();

    @Override
    public User findLoginUser(String userName, String userPwd) {
        User user = null;
        try {
            user = userDao.findLoginUser(userName, userPwd);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public List<String> findLoginUserMenuUrl(Integer userId) {
        List<String> loginUserMenuUrl = null;
        try {
            loginUserMenuUrl = userDao.findLoginUserMenuUrl(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }

        return loginUserMenuUrl;
    }

    @Override
    public List<User> findUser(Integer page, Integer pageSize, User user) {
        List<User> userList = null;
        try {
            userList = userDao.findUser(page, pageSize, user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return userList;
    }

    @Override
    public long findTotalNum(User user) {
        long totalNum = 0;
        try {
            totalNum = userDao.findTotalNum(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }

    @Override
    public int addUser(User user) {
        int rows = 0;
        try {
            rows = userDao.addUser(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public User findByUid(Integer userId) {
        User user = null;
        try {
            user = userDao.findByUid(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }

    @Override
    public int editUser(User user) {
        int rows = 0;
        try {
            rows = userDao.editUser(user);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }

    @Override
    public boolean deleteUser(Integer userId) {
        boolean isSuccess = false;
        Connection conn = DBUtils.getConn();
        try {
            //关闭事务自动提交
            conn.setAutoCommit(false);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }

        try {
            //删除用户数据
            userDao.deleteUser(userId, conn);
            //若存在用户权限数据，则直接删除
            List<UserMenu> userMenuList = userDao.findUserMenu(userId);
            if (userMenuList != null && userMenuList.size() > 0) {
                userDao.deleteUserMenu(userId, conn);
            }
            //提交事务
            DbUtils.commitAndCloseQuietly(conn);
            isSuccess = true;
        } catch (SQLException throwables) {
            //throwables.printStackTrace();
            DbUtils.rollbackAndCloseQuietly(conn);
        }
        return isSuccess;
    }

    @Override
    public int editLoginTime(Integer userId) {
        int rows = 0;
        try {
            rows = userDao.editLoginTime(userId);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return rows;
    }
}
```

#### 7.2.1.3 controller

##### LoginController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.UserService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.service.impl.UserServiceImpl;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: LoginController
 * @description: 处理用户登录请求
 * @date: 2023/2/28 18:10
 * @since: 11
 */
//http://localhost:8080/login?userName=tom&userPwd=1235
@WebServlet("/login")
public class LoginController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //接收请求数据  处理过程  返回响应数据
        //接收请求数据
        String userName = req.getParameter("userName");
        String userPwd = req.getParameter("userPwd");
        System.out.println(userName + " " + userPwd);
        //调用业务层方法
        UserService userService = new UserServiceImpl();
        User loginUser = userService.findLoginUser(userName, userPwd);
        //返回响应数据
        ReturnEntity re = new ReturnEntity();
        if (loginUser != null) {
            //登录成功
            //设置最后登录时间
            userService.editLoginTime(loginUser.getUserId());
            //向session对象上绑定值
            HttpSession session = req.getSession();
            //绑定基础用户数据->判断用户是否已登录
            User user = new User(userName, userPwd);
            session.setAttribute("user", user);
            //绑定权限数据->判断用户有无权限
            List<String> loginUserMenuUrl = userService.findLoginUserMenuUrl(loginUser.getUserId());
            System.out.println("loginUserMenuUrl=" + loginUserMenuUrl);
            session.setAttribute("loginUserMenuUrl", loginUserMenuUrl);
            MenuService menuService = new MenuServiceImpl();
            //一级菜单数据包含二级菜单数据格式
            List<Menu> menuList = menuService.findMenu(loginUser.getUserId());
            System.out.println("LoginController.sessionId=" + session.getId());
            //辅助主界面侧栏数据呈现
            session.setAttribute("menuList", menuList);
            re.setReturnCode(CodeAndMsg.LOGIN_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.LOGIN_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.LOGIN_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.LOGIN_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```





#### 
