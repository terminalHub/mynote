---
typora-copy-images-to: ./img
---

# 登录&动态菜单&菜单基础查询&菜单分页查询

```
(1)登录功能
(2)动态菜单
(3)菜单基础查询&菜单分页查询
```

# 1 登录功能

## 1.1 需求分析

```sql
(1)前端：
	Login.vue：
		登录表单(用户名和密码)、登录按钮(绑定单击事件)、
		执行登录操作(使用axios向服务器端发请求)、登录成功(进入主界面)|登录失败(重新去登录)
(2)后端：
	LoginController、UserService、UserDao
	LoginController：返回响应数据(登录成功|登录失败)->状态码|描述信息|核心数据
	
	sql：
    	select user_id,user_name,user_pwd from fin_admin_user where user_name='tom' and user_pwd='1234'
```

## 1.2 实现过程

### 1.2.1 前端

#### 1.2.1 Login.vue

```vue
<template>
  <el-card class="box-card login-card">
    <div slot="header" class="clearfix">
      <span>登录</span>
    </div>
    <el-form
      hide-required-asterisk
      ref="loginForm"
      :model="loginForm"
      :rules="loginFormRules"
      label-width="80px"
    >
      <el-form-item label="用户名称" prop="userName">
        <el-input
          v-model="loginForm.userName"
          prefix-icon="el-icon-user"
        ></el-input>
      </el-form-item>
      <el-form-item label="用户密码" prop="userPwd">
        <el-input
          v-model="loginForm.userPwd"
          prefix-icon="el-icon-lock"
          show-password
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="login('loginForm')">登录</el-button>
        <el-button @click="resetForm('loginForm')">重置</el-button>
      </el-form-item>
    </el-form>
  </el-card>
</template>
<script>
import axios from "axios";
import qs from "qs";

export default {
  data() {
    return {
      /* 表单数据 */
      loginForm: {
        userName: "",
        userPwd: "",
      },
      /* 表单验证 */
      loginFormRules: {
        userName: [
          { required: true, message: "请输入用户名称", trigger: "blur" },
          { min: 3, max: 8, message: "长度在 3 到 8 个字符", trigger: "blur" },
        ],
        userPwd: [
          { required: true, message: "请输入用户密码", trigger: "blur" },
          { min: 4, max: 8, message: "长度在 4 到 8 个字符", trigger: "blur" },
        ],
      },
    };
  },
  methods: {
    /* 执行登录：收集表单数据，发送服务器端 */
    login(loginForm) {
      /* 
          validate：对整个表单进行校验的方法，参数为一个回调函数，该回调函数会在校验结束后被调用
      */
      this.$refs[loginForm].validate((valid) => {
        //验证
        //console.log(valid);
        if (valid) {
          //true   通过基础的前端验证，收集表单数据，发送服务器端
          //console.log(qs.stringify(this.loginForm));//key=val&key=val&...
          axios
            .post("http://localhost:8080/login", qs.stringify(this.loginForm))
            .then((resp) => {
              console.log(resp);
              //判断
              if (resp.data.returnCode == 2000) {
                //登录成功->进入系统主界面
                this.$router.push("/main");
              } else if (resp.data.returnCode == 4000) {
                //设置提示信息
                this.$message({
                  showClose: true,
                  message: resp.data.returnMsg,
                  type: "error",
                });
              }
            })
            .catch((error) => {
              console.log(error);
            });
        } else {
          //false
          console.log("error submit!!");
          return false;
        }
      });
    },
    /* 重置表单数据 */
    resetForm(loginForm) {
      /* resetFields：对整个表单进行重置，将所有字段值重置为初始值并移除校验结果 */
      this.$refs[loginForm].resetFields();
    },
  },
  mounted() {},
};
</script>
<style>
/* 自增样式 */
.login-card {
  margin: 325px auto;
}

.text {
  font-size: 14px;
}

.item {
  margin-bottom: 18px;
}

.clearfix:before,
.clearfix:after {
  display: table;
  content: "";
}

.clearfix:after {
  clear: both;
}

.box-card {
  width: 480px;
}
</style>
```

#### 1.2.2 index.js

```javascript
/* 导入组件 */
import Vue from 'vue'
import VueRouter from 'vue-router'
/* 相对路径 */
import Login from '../components/Login.vue'
import Main from '../components/Main.vue'

Vue.use(VueRouter)

/* 配置组件 */
const routes = [
  {
    /* 进入登录界面 */
    path: '/',
    redirect: '/login'
  },
  {
    /* 路径 */
    path: '/login',
    /* 组件 */
    component: Login
  },
  {
    /* 路径 */
    path: '/main',
    /* 组件 */
    component: Main
  }
]

const router = new VueRouter({
  routes
})

export default router
```

### 1.2.2 后端

#### 1.2.2.1 实体类

##### User

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: User
 * @description:
 * @date: 2023/2/28 18:08
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class User {
    //用户编号
    private Integer userId;
    //用户名称
    private String userName;
    //用户密码
    private String userPwd;
    //角色id 1管理员 2普通用户
    private Integer roleId;
    //注册时间
    private String regTime;
    //登录时间
    private String loginTime;
    //0在职 1休假 2离职
    private Integer isValid;
    //头像路径
    private String headImg;
    //版本编号
    private Integer versionId;
}
```

##### ReturnEntity

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: ReturnEntity
 * @description:
 * @date: 2023/3/1 10:13
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class ReturnEntity {
    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
    //核心数据
    private Object returnData;
}
```

##### CodeAndMsg

```java
package com.javasm.finance.entity;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * @author: ShangMa
 * @className: CodeAndMsg
 * @description:
 * @date: 2023/3/1 10:14
 * @since: 11
 */
@AllArgsConstructor
@Getter
public enum CodeAndMsg {
    LOGIN_SUCCESS(2000, "登录成功"),
    LOGIN_FAILURED(4000, "登录失败");

    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
}
```

#### 1.2.2.2 持久层

##### UserDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.User;

import java.sql.SQLException;

/**
 * @author: ShangMa
 * @className: UserDao
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserDao {

    /**
     * 查询登录用户数据
     * @param userName 用户名
     * @param userPwd 用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName,String userPwd) throws SQLException;

}
```

##### UserDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.entity.User;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanHandler;

import java.sql.Connection;
import java.sql.SQLException;

/**
 * @author: ShangMa
 * @className: UserDaoImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserDaoImpl implements UserDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public User findLoginUser(String userName, String userPwd) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select user_id,user_name,user_pwd from fin_admin_user where user_name=? and user_pwd=?";
        BeanHandler<User> beanHandler = new BeanHandler<>(User.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        User user = runner.query(conn, sql, beanHandler, userName, userPwd);
        DBUtils.getClose(conn, null, null);
        return user;
    }
}
```

#### 1.2.2.3 业务层

##### UserService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.User;

/**
 * @author: ShangMa
 * @className: UserService
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public interface UserService {
    /**
     * 查询登录用户数据
     *
     * @param userName 用户名
     * @param userPwd  用户密码
     * @return 登录用户数据
     */
    User findLoginUser(String userName, String userPwd);
}
```

##### UserServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.UserDao;
import com.javasm.finance.dao.impl.UserDaoImpl;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.UserService;

import java.sql.SQLException;

/**
 * @author: ShangMa
 * @className: UserServiceImpl
 * @description:
 * @date: 2023/2/28 18:09
 * @since: 11
 */
public class UserServiceImpl implements UserService {
    UserDao userDao = new UserDaoImpl();

    @Override
    public User findLoginUser(String userName, String userPwd) {
        User user = null;
        try {
            user = userDao.findLoginUser(userName, userPwd);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return user;
    }
}
```

#### 1.2.2.4 控制层

##### LoginController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.UserService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.service.impl.UserServiceImpl;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: LoginController
 * @description:
 * @date: 2023/2/28 18:10
 * @since: 11
 */
//http://localhost:8080/login?userName=tom&userPwd=1235
@WebServlet("/login")
public class LoginController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        CORSUtils.handleCORS(resp);
        //接收请求数据  处理过程  返回响应数据
        //接收请求数据
        req.setCharacterEncoding("utf-8");
        String userName = req.getParameter("userName");
        String userPwd = req.getParameter("userPwd");
        System.out.println(userName + " " + userPwd);
        //调用业务层方法
        UserService userService = new UserServiceImpl();
        User loginUser = userService.findLoginUser(userName, userPwd);
        //返回响应数据
        ReturnEntity re = new ReturnEntity();
        if (loginUser != null) {
            //登录成功
            re.setReturnCode(CodeAndMsg.LOGIN_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.LOGIN_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.LOGIN_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.LOGIN_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

## 2 系统主界面

### 2.1 需求分析

```sql
(1)前端：
	Main.vue：呈现真实的侧栏数据  菜单数据
(2)后端：
	MainController：返回响应数据->当前登录用户拥有的菜单数据(一级菜单数据包含二级菜单数据)
	session：会话对象，多次请求之间数据共享
	登录时：向session对象上绑定值->当前登录用户拥有的菜单数据
	进入主界面->MainController：获取当前登录用户拥有的菜单数据
	
	sql：
		select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id
        from fin_admin_menu am,fin_user_menu um
        where am.menu_id=um.menu_id
        and um.user_id=2
        and am.parent_id=0;
        
        select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id
        from fin_admin_menu am,fin_user_menu um
        where am.menu_id=um.menu_id
        and um.user_id=2
        and am.parent_id!=0;
```

### 2.2 实现过程

### 1.2.1 前端

#### Main.vue

```vue
<template>
  <!-- 内容需要被一个根标签包含 -->
  <!-- Container 布局容器 -->
  <el-container>
    <el-header>尚马教育系统</el-header>
    <el-container>
      <el-aside width="200px">
        <!-- 
          NavMenu 导航菜单->侧栏：
            router	
              是否使用 vue-router 的模式
              启用该模式会在激活导航时以 index 作为 path 进行路由跳转
        -->
        <el-row class="tac">
          <!-- 24分栏 -->
          <el-col :span="24">
            <el-menu
              router
              default-active="2"
              class="el-menu-vertical-demo"
              @open="handleOpen"
              @close="handleClose"
            >
              <!-- menuData：所有的一级菜单数据 -->
              <el-submenu
                :key="menu.menuId"
                :index="menu.menuId.toString()"
                v-for="menu in menuData"
              >
                <template slot="title">
                  <!-- icon：图标 -->
                  <i :class="menu.glyphicon"></i>
                  <span>{{ menu.menuName }}</span>
                </template>
                <el-menu-item-group>
                  <!-- 呈现二级菜单数据 -->
                  <el-menu-item
                    :key="subMenu.menuId"
                    :index="subMenu.menuUrl"
                    v-for="subMenu in menu.subMenu"
                  >
                    {{ subMenu.menuName }}</el-menu-item
                  >
                </el-menu-item-group>
              </el-submenu>
            </el-menu>
          </el-col>
        </el-row>
      </el-aside>
      <el-main>
        <!-- 子路由 -->
        <router-view></router-view>
      </el-main>
    </el-container>
  </el-container>
</template>
<script>
/* import axios from "axios";
import qs from "qs"; */

export default {
  data() {
    return {
      /* 侧栏数据 */
      menuData: [],
    };
  },
  methods: {
    handleOpen(key, keyPath) {
      console.log(key, keyPath);
    },
    handleClose(key, keyPath) {
      console.log(key, keyPath);
    },
  },
  mounted() {
    /* 获取侧栏数据 */
    this.$axios
      .post("/main", "")
      .then((resp) => {
        console.log(resp);
        if (resp.data.returnCode == 2001) {
          //呈现侧栏数据
          this.menuData = resp.data.returnData;
        } /* else if (resp.data.returnCode == 4005) {
          //去登录
          this.$router.push("/login");
        } */
      })
      .catch((error) => {
        console.log(error);
      });
  },
};
</script>
<style>
/* 自增样式 */
/* 去除外边距 */
* {
  margin: 0;
  /* padding: 0; */
}

/* 设置页面高度 */
html,
body,
.el-container {
  height: 100%;
}

/* Container 布局容器 */
.el-header,
.el-footer {
  background-color: #b3c0d1;
  color: #333;
  text-align: center;
  line-height: 60px;
}

.el-aside {
  background-color: #d3dce6;
  color: #333;
  text-align: center;
  line-height: 200px;
}

.el-main {
  background-color: #e9eef3;
  color: #333;
  text-align: center;
  line-height: 160px;
}

body > .el-container {
  margin-bottom: 40px;
}

.el-container:nth-child(5) .el-aside,
.el-container:nth-child(6) .el-aside {
  line-height: 260px;
}

.el-container:nth-child(7) .el-aside {
  line-height: 320px;
}
</style>
```

#### index.js

```javascript
/* 导入组件 */
import Vue from 'vue'
import VueRouter from 'vue-router'
/* 相对路径 */
import Login from '../components/Login.vue'
import Main from '../components/Main.vue'

Vue.use(VueRouter)

/* 配置组件 */
const routes = [
  {
    /* 进入登录界面 */
    path: '/',
    redirect: '/login'
  },
  {
    /* 路径 */
    path: '/login',
    /* 组件 */
    component: Login
  },
  {
    /* 路径 */
    path: '/main',
    /* 组件 */
    component: Main
  }
]

const router = new VueRouter({
  routes
})

export default router
```

#### main.js

```javascript
/* 导入 */
import Vue from 'vue'
/* ./：当前目录 */
import App from './App.vue'
import router from './router'
import './plugins/element.js'

/* 关闭Vue在生产环境下的提示 */
Vue.config.productionTip = false

/* 导入axios和qs */
import axios from "axios";
import qs from "qs";
/* 将axios和qs利用原型链扩展到Vue对象上 */
Vue.prototype.$axios = axios
Vue.prototype.$qs = qs

/* 全局配置：请求路径，指定默认配置，它将作用于每个请求 */
axios.defaults.baseURL = 'http://localhost:8080';

/* `withCredentials` 表示跨域请求时是否需要使用凭证  是否携带Cookie数据 */
//withCredentials: false, // default
axios.defaults.withCredentials = true

/* 添加响应拦截器：在请求或响应被 then 或 catch 处理前拦截它们 */
axios.interceptors.response.use(function (resp) {
  // 2xx 范围内的状态码都会触发该函数
  // 对响应数据做点什么
  if (resp.data.returnCode == 4005) {
    //去登录
    router.push("/");
  }
  return resp;
}, function (error) {
  // 超出 2xx 范围的状态码都会触发该函数
  // 对响应错误做点什么
  return Promise.reject(error);
});


/* 创建Vue实例 */
new Vue({
  router,
  /* 渲染页面：将App组件(根组件)内容渲染到页面上 */
  render: h => h(App)
}).$mount('#app')
```

### 1.2.2 后端

#### 1.2.2.1 实体类

##### Menu

```java
package com.javasm.finance.entity;

import lombok.*;

import java.util.List;

/**
 * @author: ShangMa
 * @className: Menu
 * @description:
 * @date: 2023/3/1 11:18
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class Menu {
    //菜单编号
    private Integer menuId;
    //菜单名称
    private String menuName;
    //上级编号
    private Integer parentId;
    //请求地址
    private String menuUrl;
    //菜单图标
    private String glyphicon;
    //版本编号
    private Integer versionId;
    //子菜单-二级菜单数据
    private List<Menu> subMenu;

}
```

##### ReturnEntity

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: ReturnEntity
 * @description:
 * @date: 2023/3/1 10:13
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class ReturnEntity {
    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
    //核心数据
    private Object returnData;
}
```

##### CodeAndMsg

```java
package com.javasm.finance.entity;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * @author: ShangMa
 * @className: CodeAndMsg
 * @description:
 * @date: 2023/3/1 10:14
 * @since: 11
 */
@AllArgsConstructor
@Getter
public enum CodeAndMsg {
    LOGIN_SUCCESS(2000, "登录成功"),
    LOGIN_FAILURED(4000, "登录失败"),
    QUERY_SUCCESS(2001,"成功查询到数据"),
    QUERY_FAILURED(4001,"没有查询到数据"),
    NO_LOGIN(4005,"没有登录");

    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
}
```

#### 1.2.2.2 持久层

##### MenuDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDao
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public interface MenuDao {

    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @param level 菜单等级
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId, Integer level) throws SQLException;
}
```

##### MenuDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanListHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDaoImpl
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public class MenuDaoImpl implements MenuDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public List<Menu> findMenu(Integer userId, Integer level) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id " +
                "from fin_admin_menu am,fin_user_menu um " +
                "where am.menu_id=um.menu_id " +
                "and um.user_id=? ";
        if (level == 1) {
            //一级菜单数据
            sql += "and am.parent_id=0";
        } else {
            //二级菜单数据
            sql += "and am.parent_id!=0";
        }
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }
}
```

#### 1.2.2.3 业务层

##### MenuService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.Menu;

import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuService
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public interface MenuService {
    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId);
}
```

##### MenuServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.dao.impl.MenuDaoImpl;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.service.MenuService;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuServiceImpl
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public class MenuServiceImpl implements MenuService {
    MenuDao menuDao = new MenuDaoImpl();

    @Override
    public List<Menu> findMenu(Integer userId) {
        //查询一级菜单数据和二级菜单数据->将二级菜单数据放到一级菜单数据中
        //一级菜单数据
        List<Menu> menuData = null;
        //二级菜单数据
        List<Menu> subMenuData = null;
        try {
            menuData = menuDao.findMenu(userId, 1);
            subMenuData = menuDao.findMenu(userId, 2);
            //将二级菜单数据放到一级菜单数据中
            for (Menu menu : menuData) {
                for (Menu subMenu : subMenuData) {
                    //二级菜单数据的上级编号和一级菜单数据的菜单编号比较
                    if (menu.getMenuId().equals(subMenu.getParentId())) {
                        if (menu.getSubMenu() == null) {
                            menu.setSubMenu(new ArrayList<>());
                        }
                        menu.getSubMenu().add(subMenu);
                    }
                }
            }
            //System.out.println("menuData=" + menuData);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menuData;
    }
}
```

#### 1.2.2.4 控制层

##### LoginController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.entity.User;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.UserService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.service.impl.UserServiceImpl;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: LoginController
 * @description:
 * @date: 2023/2/28 18:10
 * @since: 11
 */
//http://localhost:8080/login?userName=tom&userPwd=1235
@WebServlet("/login")
public class LoginController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        CORSUtils.handleCORS(resp);
        //接收请求数据  处理过程  返回响应数据
        //接收请求数据
        req.setCharacterEncoding("utf-8");
        String userName = req.getParameter("userName");
        String userPwd = req.getParameter("userPwd");
        System.out.println(userName + " " + userPwd);
        //调用业务层方法
        UserService userService = new UserServiceImpl();
        User loginUser = userService.findLoginUser(userName, userPwd);
        //返回响应数据
        ReturnEntity re = new ReturnEntity();
        if (loginUser != null) {
            //登录成功
            MenuService menuService = new MenuServiceImpl();
            //一级菜单数据包含二级菜单数据格式
            List<Menu> menuList = menuService.findMenu(loginUser.getUserId());
            HttpSession session = req.getSession();
            System.out.println("LoginController.sessionId=" + session.getId());
            //辅助主界面侧栏数据呈现
            session.setAttribute("menuList", menuList);
            re.setReturnCode(CodeAndMsg.LOGIN_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.LOGIN_SUCCESS.getReturnMsg());
        } else {
            re.setReturnCode(CodeAndMsg.LOGIN_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.LOGIN_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

##### MainController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MainController
 * @description:
 * @date: 2023/3/1 11:44
 * @since: 11
 */
@WebServlet("/main")
public class MainController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        CORSUtils.handleCORS(resp);
        //从session对象上获取登录用户的权限数据
        HttpSession session = req.getSession();
        System.out.println("MainController.sessionId=" + session.getId());
        List<Menu> menuList = (List<Menu>) session.getAttribute("menuList");
        //写出响应数据
        ReturnEntity re = new ReturnEntity();
        if (menuList != null && menuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(menuList);
        } else {
            re.setReturnCode(CodeAndMsg.NO_LOGIN.getReturnCode());
            re.setReturnMsg(CodeAndMsg.NO_LOGIN.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

# 3 菜单查询-基础查询

![image-20230302181501119](img/image-20230302181501119.png)

## 3.1 需求分析

```sql
(1)Menu.vue->MenuController->MenuService->MenuDao
(2)sql：
	select 
		m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') 		
		parent_name,m1.menu_url,m1.glyphicon
    from 
    	fin_admin_menu m1 
    left join 
    	fin_admin_menu m2
    on 
    	m1.parent_id=m2.menu_id;
```

## 3.2 实现过程

### 3.2.1 前端

#### Menu.vue

```vue
<template>
  <div>
    <el-table :data="tableData" style="width: 100%">
      <el-table-column prop="menuId" label="菜单编号" width="180">
      </el-table-column>
      <el-table-column prop="menuName" label="菜单名称" width="180">
      </el-table-column>
      <el-table-column prop="parentId" label="上级菜单编号"> </el-table-column>
      <el-table-column prop="parentName" label="上级菜单名称" width="180">
      </el-table-column>
      <el-table-column prop="menuUrl" label="访问地址" width="180">
      </el-table-column>
      <el-table-column prop="glyphicon" label="菜单图标"> </el-table-column>
    </el-table>
  </div>
</template>
<script>
import axios from "axios";
export default {
  data() {
    return {
      /* 表格数据 */
      tableData: [],
    };
  },
  methods: {},
  mounted() {
    axios
      .post("/menuQuery", "")
      .then((resp) => {
        console.log(resp);
        this.tableData = resp.data.returnData;
      })
      .catch((error) => {
        console.log(error);
      });
  },
};
</script>
<style>
/* 自增样式 */
/* 设置表格表头高度 */
.el-main {
  line-height: 50px;
}
</style>
```

### 3.2.2 后端

#### 3.2.2.1 实体类

##### Menu

```java
package com.javasm.finance.entity;

import lombok.*;

import java.util.List;

/**
 * @author: ShangMa
 * @className: Menu
 * @description:
 * @date: 2023/3/1 11:18
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class Menu {
    //菜单编号
    private Integer menuId;
    //菜单名称
    private String menuName;
    //上级编号
    private Integer parentId;
    //上级名称
    private String parentName;
    //请求地址
    private String menuUrl;
    //菜单图标
    private String glyphicon;
    //版本编号
    private Integer versionId;
    //子菜单-二级菜单数据
    private List<Menu> subMenu;

}
```

##### ReturnEntity

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: ReturnEntity
 * @description:
 * @date: 2023/3/1 10:13
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class ReturnEntity {
    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
    //核心数据
    private Object returnData;
}
```

##### CodeAndMsg

```java
package com.javasm.finance.entity;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * @author: ShangMa
 * @className: CodeAndMsg
 * @description:
 * @date: 2023/3/1 10:14
 * @since: 11
 */
@AllArgsConstructor
@Getter
public enum CodeAndMsg {
    LOGIN_SUCCESS(2000, "登录成功"),
    LOGIN_FAILURED(4000, "登录失败"),
    QUERY_SUCCESS(2001,"成功查询到数据"),
    QUERY_FAILURED(4001,"没有查询到数据"),
    NO_LOGIN(4005,"没有登录");

    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
}
```

#### 3.2.2.2 持久层

##### MenuDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDao
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public interface MenuDao {

    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @param level  菜单等级
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId, Integer level) throws SQLException;


    /**
     * 查询菜单数据
     *
     * @return 菜单数据
     */
    List<Menu> findAllMenu() throws SQLException;

}
```

##### MenuDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanListHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDaoImpl
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public class MenuDaoImpl implements MenuDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public List<Menu> findMenu(Integer userId, Integer level) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id " +
                "from fin_admin_menu am,fin_user_menu um " +
                "where am.menu_id=um.menu_id " +
                "and um.user_id=? ";
        if (level == 1) {
            //一级菜单数据
            sql += "and am.parent_id=0";
        } else {
            //二级菜单数据
            sql += "and am.parent_id!=0";
        }
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public List<Menu> findAllMenu() throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') parent_name,m1.menu_url,m1.glyphicon " +
                "from " +
                "fin_admin_menu m1 " +
                "left join " +
                "fin_admin_menu m2 " +
                "on " +
                "m1.parent_id=m2.menu_id";
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }
}
```

#### 3.2.2.3 业务层

##### MenuService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.Menu;

import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuService
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public interface MenuService {
    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId);

    /**
     * 查询菜单数据
     *
     * @return 菜单数据
     */
    List<Menu> findAllMenu();
}
```

##### MenuServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.dao.impl.MenuDaoImpl;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.service.MenuService;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuServiceImpl
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public class MenuServiceImpl implements MenuService {
    MenuDao menuDao = new MenuDaoImpl();

    @Override
    public List<Menu> findMenu(Integer userId) {
        //查询一级菜单数据和二级菜单数据->将二级菜单数据放到一级菜单数据中
        //一级菜单数据
        List<Menu> menuData = null;
        //二级菜单数据
        List<Menu> subMenuData = null;
        try {
            menuData = menuDao.findMenu(userId, 1);
            subMenuData = menuDao.findMenu(userId, 2);
            //将二级菜单数据放到一级菜单数据中
            for (Menu menu : menuData) {
                for (Menu subMenu : subMenuData) {
                    //二级菜单数据的上级编号和一级菜单数据的菜单编号比较
                    if (menu.getMenuId().equals(subMenu.getParentId())) {
                        if (menu.getSubMenu() == null) {
                            menu.setSubMenu(new ArrayList<>());
                        }
                        menu.getSubMenu().add(subMenu);
                    }
                }
            }
            //System.out.println("menuData=" + menuData);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        //一级菜单数据包含二级菜单数据格式
        return menuData;
    }

    @Override
    public List<Menu> findAllMenu() {
        List<Menu> menuList = null;
        try {
            menuList = menuDao.findAllMenu();
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menuList;
    }
}
```

#### 3.2.2.4 控制层

##### MenuController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuController
 * @description:
 * @date: 2023/3/1 16:17
 * @since: 11
 */
@WebServlet("/menuQuery")
public class MenuController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //跨域处理
        CORSUtils.handleCORS(resp);
        MenuService menuService = new MenuServiceImpl();
        List<Menu> menuList = menuService.findAllMenu();
        ReturnEntity re = new ReturnEntity();
        if (menuList != null && menuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            re.setReturnData(menuList);
        } else {
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```

# 4 菜单查询-分页查询

## 4.1 需求分析

```sql
(1)Menu.vue->MenuController->MenuService->MenuDao
(2)sql：
	select 
		m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') 		
		parent_name,m1.menu_url,m1.glyphicon
    from 
    	fin_admin_menu m1 
    left join 
    	fin_admin_menu m2
    on 
    	m1.parent_id=m2.menu_id
    limit 
    	m,n;
  	
  	假设：当前页用page表示，每页显示数据条数用pageSize表示，那么m=(page-1)*pageSize,n=pageSize
```

## 4.2 实现过程

### 4.2.1 前端

#### Menu.vue

```vue
<template>
  <div>
    <!-- 表格-呈现菜单数据 -->
    <el-table :data="tableData" style="width: 100%">
      <el-table-column prop="menuId" label="菜单编号" width="180">
      </el-table-column>
      <el-table-column prop="menuName" label="菜单名称" width="180">
      </el-table-column>
      <el-table-column prop="parentId" label="上级菜单编号"> </el-table-column>
      <el-table-column prop="parentName" label="上级菜单名称" width="180">
      </el-table-column>
      <el-table-column prop="menuUrl" label="访问地址" width="180">
      </el-table-column>
      <el-table-column prop="glyphicon" label="菜单图标"> </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageInfo.page"
      :page-sizes="[10, 20, 30, 40]"
      :page-size="pageInfo.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="pageInfo.totalNum"
    >
    </el-pagination>
  </div>
</template>
<script>
export default {
  data() {
    return {
      /* 表格数据 */
      tableData: [],
      /* 分页 */
      pageInfo: {
        page: 2,
        pageSize: 20,
        totalNum: 50,
      },
    };
  },
  methods: {
    /* 分页查询 */
    /* 切换每页显示数据条数时 */
    handleSizeChange(val) {
      console.log(`每页 ${val} 条`);
      //设置为第一页
      this.pageInfo.page = 1;
      this.pageInfo.pageSize = val;
      var reqData = this.$qs.stringify(this.pageInfo);
      console.log(reqData);
      this.queryMenu(reqData);
    },
    /* 切换页数时 */
    handleCurrentChange(val) {
      console.log(`当前页: ${val}`);
      this.pageInfo.page = val;
      var reqData = this.$qs.stringify(this.pageInfo);
      console.log(reqData);
      this.queryMenu(reqData);
    },
    /* 公共函数-查询 */
    queryMenu(reqData) {
      this.$axios
        .post("/menuQuery", reqData)
        .then((resp) => {
          console.log(resp);
          this.tableData = resp.data.returnData.menuList;
          this.pageInfo = resp.data.returnData.pageInfo;
        })
        .catch((error) => {
          console.log(error);
        });
    },
  },
  mounted() {
    this.queryMenu("");
  },
};
</script>
<style>
/* 自增样式 */
/* 设置表格表头高度 */
.el-main {
  line-height: 50px;
}
</style>
```

### 4.2.2 后端

#### 4.2.2.1 实体类

##### Menu

```java
package com.javasm.finance.entity;

import lombok.*;

import java.util.List;

/**
 * @author: ShangMa
 * @className: Menu
 * @description:
 * @date: 2023/3/1 11:18
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class Menu {
    //菜单编号
    private Integer menuId;
    //菜单名称
    private String menuName;
    //上级编号
    private Integer parentId;
    //上级名称
    private String parentName;
    //请求地址
    private String menuUrl;
    //菜单图标
    private String glyphicon;
    //版本编号
    private Integer versionId;
    //子菜单-二级菜单数据
    private List<Menu> subMenu;

}
```

##### ReturnEntity

```java
package com.javasm.finance.entity;

import lombok.*;

/**
 * @author: ShangMa
 * @className: ReturnEntity
 * @description:
 * @date: 2023/3/1 10:13
 * @since: 11
 */
@NoArgsConstructor
@AllArgsConstructor
@Setter
@Getter
@ToString
public class ReturnEntity {
    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
    //核心数据
    private Object returnData;
}
```

##### CodeAndMsg

```java
package com.javasm.finance.entity;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * @author: ShangMa
 * @className: CodeAndMsg
 * @description:
 * @date: 2023/3/1 10:14
 * @since: 11
 */
@AllArgsConstructor
@Getter
public enum CodeAndMsg {
    LOGIN_SUCCESS(2000, "登录成功"),
    LOGIN_FAILURED(4000, "登录失败"),
    QUERY_SUCCESS(2001,"成功查询到数据"),
    QUERY_FAILURED(4001,"没有查询到数据"),
    NO_LOGIN(4005,"没有登录");

    //状态码
    private Integer returnCode;
    //描述信息
    private String returnMsg;
}
```

#### 4.2.2.2 持久层

##### MenuDao

```java
package com.javasm.finance.dao;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDao
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public interface MenuDao {

    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @param level  菜单等级
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId, Integer level) throws SQLException;

    /**
     * 查询菜单数据
     *
     * @param page     当前页
     * @param pageSize 每页显示的数据条数
     * @return 菜单数据
     * @throws SQLException
     */
    List<Menu> findAllMenu(Integer page, Integer pageSize) throws SQLException;

    /**
     * 查询数据表中数据总条数
     *
     * @return 数据总条数
     */
    long findTotalNum() throws SQLException;
}
```

##### MenuDaoImpl

```java
package com.javasm.finance.dao.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.util.DBUtils;
import org.apache.commons.dbutils.BasicRowProcessor;
import org.apache.commons.dbutils.GenerousBeanProcessor;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.BeanListHandler;
import org.apache.commons.dbutils.handlers.ScalarHandler;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuDaoImpl
 * @description:
 * @date: 2023/3/1 11:22
 * @since: 11
 */
public class MenuDaoImpl implements MenuDao {
    QueryRunner runner = new QueryRunner();

    @Override
    public List<Menu> findMenu(Integer userId, Integer level) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select am.menu_id,am.menu_name,am.parent_id,am.menu_url,am.glyphicon,am.version_id " +
                "from fin_admin_menu am,fin_user_menu um " +
                "where am.menu_id=um.menu_id " +
                "and um.user_id=? ";
        if (level == 1) {
            //一级菜单数据
            sql += "and am.parent_id=0";
        } else {
            //二级菜单数据
            sql += "and am.parent_id!=0";
        }
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler, userId);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public List<Menu> findAllMenu(Integer page, Integer pageSize) throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select m1.menu_id,m1.menu_name,m1.parent_id,ifnull(m2.menu_name,'超级管理') parent_name,m1.menu_url,m1.glyphicon " +
                "from " +
                "fin_admin_menu m1 " +
                "left join " +
                "fin_admin_menu m2 " +
                "on " +
                "m1.parent_id=m2.menu_id ";
        //分页查询
        sql += "limit " + (page - 1) * pageSize + "," + pageSize;
        BeanListHandler<Menu> beanListHandler = new BeanListHandler<>(Menu.class, new BasicRowProcessor(new GenerousBeanProcessor()));
        List<Menu> menuList = runner.query(conn, sql, beanListHandler);
        DBUtils.getClose(conn, null, null);
        return menuList;
    }

    @Override
    public long findTotalNum() throws SQLException {
        Connection conn = DBUtils.getConn();
        String sql = "select count(1) totalNum from fin_admin_menu";
        //单数据  数据总条数
        long totalNum = runner.query(conn, sql, new ScalarHandler<>());
        DBUtils.getClose(conn, null, null);
        return totalNum;
    }
}
```

#### 4.2.2.3 业务层

##### MenuService

```java
package com.javasm.finance.service;

import com.javasm.finance.entity.Menu;

import java.sql.SQLException;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuService
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public interface MenuService {
    /**
     * 查询登录用户菜单数据
     *
     * @param userId 用户编号
     * @return 登录用户菜单数据
     */
    List<Menu> findMenu(Integer userId);

    /**
     * 查询菜单数据
     *
     * @param page 当前页
     * @param pageSize 每页显示的数据条数
     * @return 菜单数据
     * @throws SQLException
     */
    List<Menu> findAllMenu(Integer page, Integer pageSize);

    /**
     * 查询数据表中数据总条数
     *
     * @return 数据总条数
     */
    long findTotalNum();
}
```

##### MenuServiceImpl

```java
package com.javasm.finance.service.impl;

import com.javasm.finance.dao.MenuDao;
import com.javasm.finance.dao.impl.MenuDaoImpl;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.service.MenuService;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author: ShangMa
 * @className: MenuServiceImpl
 * @description:
 * @date: 2023/3/1 11:31
 * @since: 11
 */
public class MenuServiceImpl implements MenuService {
    MenuDao menuDao = new MenuDaoImpl();

    @Override
    public List<Menu> findMenu(Integer userId) {
        //查询一级菜单数据和二级菜单数据->将二级菜单数据放到一级菜单数据中
        //一级菜单数据
        List<Menu> menuData = null;
        //二级菜单数据
        List<Menu> subMenuData = null;
        try {
            menuData = menuDao.findMenu(userId, 1);
            subMenuData = menuDao.findMenu(userId, 2);
            //将二级菜单数据放到一级菜单数据中
            for (Menu menu : menuData) {
                for (Menu subMenu : subMenuData) {
                    //二级菜单数据的上级编号和一级菜单数据的菜单编号比较
                    if (menu.getMenuId().equals(subMenu.getParentId())) {
                        if (menu.getSubMenu() == null) {
                            menu.setSubMenu(new ArrayList<>());
                        }
                        menu.getSubMenu().add(subMenu);
                    }
                }
            }
            //System.out.println("menuData=" + menuData);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        //一级菜单数据包含二级菜单数据格式
        return menuData;
    }

    @Override
    public List<Menu> findAllMenu(Integer page, Integer pageSize) {
        List<Menu> menuList = null;
        try {
            menuList = menuDao.findAllMenu(page, pageSize);
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return menuList;
    }

    @Override
    public long findTotalNum() {
        long totalNum = 0;
        try {
            totalNum = menuDao.findTotalNum();
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        }
        return totalNum;
    }
}
```

#### 4.2.2.4 控制层

##### MenuController

```java
package com.javasm.finance.controller;

import com.javasm.finance.entity.CodeAndMsg;
import com.javasm.finance.entity.Menu;
import com.javasm.finance.entity.PageInfo;
import com.javasm.finance.entity.ReturnEntity;
import com.javasm.finance.service.MenuService;
import com.javasm.finance.service.impl.MenuServiceImpl;
import com.javasm.finance.util.CORSUtils;
import com.javasm.finance.util.RespUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author: ShangMa
 * @className: MenuController
 * @description:
 * @date: 2023/3/1 16:17
 * @since: 11
 */
@WebServlet("/menuQuery")
public class MenuController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //跨域处理
        CORSUtils.handleCORS(resp);
        //当前页
        Integer page = 1;
        String pageStr = req.getParameter("page");
        if (pageStr != null && !"".equals(pageStr)) {
            page = Integer.valueOf(pageStr);
        }
        //每页显示数据条数
        Integer pageSize = 10;
        String pageSizeStr = req.getParameter("pageSize");
        if (pageSizeStr != null && !"".equals(pageSizeStr)) {
            pageSize = Integer.valueOf(pageSizeStr);
        }
        MenuService menuService = new MenuServiceImpl();
        List<Menu> menuList = menuService.findAllMenu(page, pageSize);
        ReturnEntity re = new ReturnEntity();
        if (menuList != null && menuList.size() > 0) {
            re.setReturnCode(CodeAndMsg.QUERY_SUCCESS.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_SUCCESS.getReturnMsg());
            Map<String, Object> returnMap = new HashMap<>();
            //菜单数据
            returnMap.put("menuList", menuList);
            //页码数据
            long totalNum = menuService.findTotalNum();
            PageInfo pageInfo = new PageInfo(page, pageSize, totalNum);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnData(returnMap);
        } else {
            Map<String, Object> returnMap = new HashMap<>();
            PageInfo pageInfo = new PageInfo(1, 5, 0l);
            returnMap.put("pageInfo", pageInfo);
            re.setReturnCode(CodeAndMsg.QUERY_FAILURED.getReturnCode());
            re.setReturnMsg(CodeAndMsg.QUERY_FAILURED.getReturnMsg());
            re.setReturnData(returnMap);
        }
        //写出响应数据
        RespUtils.handleResp(resp, re);
    }
}
```









































